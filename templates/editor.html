<!DOCTYPE HTML>
<html>
<head>
    <title>ESDL Map Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="shortcut icon" href=".{{dir_settings.plugin_prefix}}/favicon.ico" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin="" type="text/css"/>
    <script type="text/javascript" src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg==" crossorigin=""></script>
    <!--link rel="stylesheet" href="./plugins/leaflet.css" crossorigin=""/-->
    <!--script src="./plugins/leaflet.js" crossorigin=""></script-->

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css" type="text/css"/>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>
    <!--link rel="stylesheet" href="./plugins/leaflet.draw.css"/-->
    <!--script src="./plugins/leaflet.draw.js"></script-->

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-polylinedecorator/1.1.0/leaflet.polylineDecorator.min.js"></script>

    <link rel="stylesheet" href=".{{dir_settings.plugin_prefix}}/plugins/L.Control.Sidebar.css" type="text/css"/>
    <script type="text/javascript" src=".{{dir_settings.plugin_prefix}}/plugins/L.Control.Sidebar.js"></script>

    <!-- downloaded from https://github.com/kartena/Proj4Leaflet -->
    <script type="text/javascript" src=".{{dir_settings.plugin_prefix}}/plugins/proj4.js"></script>
    <!--script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.5.0/proj4.js"></script-->
    <script type="text/javascript" src=".{{dir_settings.plugin_prefix}}/plugins/proj4leaflet.js"></script>

    <!--script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.slim.js"></script-->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.4/socket.io.min.js"></script>

    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" type="text/css">
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <!--script type="text/javascript" src="./plugins/socket.io.min.js"></script-->
    <!--script type="text/javascript" src="./plugins/jquery-1.4.2.min.js"></script-->

    <link href=".{{dir_settings.plugin_prefix}}/plugins/leaflet.contextmenu.css" rel="stylesheet" type="text/css" />
    <script src=".{{dir_settings.plugin_prefix}}/plugins/leaflet.contextmenu.js" type="text/javascript"></script>

    <script type="text/javascript" src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>

    <!-- <script src='https://unpkg.com/shpjs@latest/dist/shp.js'></script> -->
    <script type="text/javascript" src=".{{dir_settings.plugin_prefix}}/plugins/shp.js"></script>
    <script type="text/javascript" src=".{{dir_settings.plugin_prefix}}/plugins/rainbowvis.js"></script>

    <script type="text/javascript" src=".{{dir_settings.plugin_prefix}}/utils/utils.js"></script>
    <script type="text/javascript" src=".{{dir_settings.plugin_prefix}}/utils/heatnetwork.js"></script>
    <script type="text/javascript" src=".{{dir_settings.plugin_prefix}}/utils/area_building_layer.js"></script>
    <script type="text/javascript" src=".{{dir_settings.plugin_prefix}}/utils/sectors.js"></script>
    <script type="text/javascript" src=".{{dir_settings.plugin_prefix}}/utils/carriers.js"></script>
    <script type="text/javascript" src=".{{dir_settings.plugin_prefix}}/utils/profiles.js"></script>
    <script type="text/javascript" src=".{{dir_settings.plugin_prefix}}/utils/asset_from_edr.js"></script>
    <script type="text/javascript" src=".{{dir_settings.plugin_prefix}}/utils/esdl_services.js"></script>
    <script type="text/javascript" src=".{{dir_settings.plugin_prefix}}/utils/wkt_rd2wgs.js"></script>
    <link href=".{{dir_settings.plugin_prefix}}/css/custom.css" rel="stylesheet" type="text/css" />

    <link rel="stylesheet" href="https://rawgit.com/socib/Leaflet.TimeDimension/master/dist/leaflet.timedimension.control.min.css" type="text/css"/>
    <script type="text/javascript" src="https://rawgit.com/nezasa/iso8601-js-period/master/iso8601.min.js"></script>
    <script type="text/javascript" src="https://rawgit.com/socib/Leaflet.TimeDimension/master/dist/leaflet.timedimension.src.withlog.js"></script>

    <script type="text/javascript" src=".{{dir_settings.plugin_prefix}}/plugins/animate.js"></script>

    <script type="text/javascript" src=".{{dir_settings.plugin_prefix}}/plugins/leaflet.shpfile.js"></script>
    <script type="text/javascript" charset="utf-8">

        var sidebar;

        var profile_array;
        var quantity_and_units_info;
        var control_strategy_config;
        var wms_layer_list;
        var leaflet_layers = {};

        var connecting_assets = false;
        var first_clicked = false;
        var first_clicked_id;

        var connect_ports;

        var clear_layer = false;        // to indicate if esdl items need to be removed too (or only UI clear)
        var deleting_objects = false;   // to indicate if objects are being deleted (to prevent on click)
        var editing_objects = false;    // to indicate if objects are being edited (to prevent on click)

        var extensions = [];            // list of extensions
        var resource_uri = '{{dir_settings.resource_prefix}}';  // make the resource_prefix accessible by extensions

        // globally define the colors of the lines/conductors on the map
        var colors = {};
        colors['ElectricityCable'] = '#ff9090';
        colors['ElectricityCable_hoover'] = '#906060';
        colors['Pipe'] = 'blue';
        colors['Pipe_hoover'] = '#9999ff';

        // ------------------------------------------------------------------------------------------------------------
        //
        // ------------------------------------------------------------------------------------------------------------
        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // ------------------------------------------------------------------------------------------------------------
        //
        // ------------------------------------------------------------------------------------------------------------
        function show_loader() {
            document.getElementById("loader").style.display = "block";
        }

        function hide_loader() {
            document.getElementById("loader").style.display = "none";
        }

        // ------------------------------------------------------------------------------------------------------------
        //
        // ------------------------------------------------------------------------------------------------------------
        function calculate_length(layer) {
            var previousPoint;
            var polyline_length = 0;

            // http://leafletjs.com/reference.html#polyline-getlatlngs
            layer.getLatLngs().forEach(function (latLng) {
                 // http://leafletjs.com/reference.html#latlng-distanceto
                if (previousPoint) polyline_length += previousPoint.distanceTo(latLng);
                previousPoint = latLng;
            });

            return polyline_length;
        }

        function calculate_area(layer) {
            return L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
        }

        function calculate_array_polygon_center(coords) {
            let lat_min = Infinity;
            let lon_min = Infinity;
            let lat_max = -Infinity;
            let lon_max = -Infinity;

            for (let i=0; i<coords.length; i++) {
                if (coords[i][0] < lat_min) { lat_min = coords[i][0]; }
                if (coords[i][0] > lat_max) { lat_max = coords[i][0]; }
                if (coords[i][1] < lon_min) { lon_min = coords[i][1]; }
                if (coords[i][1] > lon_max) { lon_max = coords[i][1]; }
            }

            return [(lat_min + lat_max) / 2, (lon_min + lon_max) / 2];
        }

        function calculate_leaflet_polygon_center(coords) {
            let lat_min = Infinity;
            let lon_min = Infinity;
            let lat_max = 0;
            let lon_max = 0;

            for (let i=0; i<coords.length; i++) {
                if (coords[i]['lat'] < lat_min) { lat_min = coords[i]['lat']; }
                if (coords[i]['lat'] > lat_max) { lat_max = coords[i]['lat']; }
                if (coords[i]['lng'] < lon_min) { lon_min = coords[i]['lng']; }
                if (coords[i]['lng'] > lon_max) { lon_max = coords[i]['lng']; }
            }

            return [(lat_min + lat_max) / 2, (lon_min + lon_max) / 2];
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Splitting conductors (cables or pipes)
        // ------------------------------------------------------------------------------------------------------------
        splitConductorCallback = function(e, id) {
            splitConductor(id, e.latlng, 'no_connect');
            // only remove conductor from UI, let server side remove conductor in ESDL
            clear_layer = true;
            esdl_layer.removeLayer(e.relatedTarget);
            clear_layer = false;
        }

        splitConductorConnectCallback = function(e, id) {
            splitConductor(id, e.latlng, 'connect');
            // only remove conductor from UI, let server side remove conductor in ESDL
            clear_layer = true;
            esdl_layer.removeLayer(e.relatedTarget);
            clear_layer = false;
        }

        splitConductorAddJointCallback = function(e, id) {
            splitConductor(id, e.latlng, 'add_joint');
            // only remove conductor from UI, let server side remove conductor in ESDL
            clear_layer = true;
            esdl_layer.removeLayer(e.relatedTarget);
            clear_layer = false;
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Handlers for clicking on an asset or potential
        // ------------------------------------------------------------------------------------------------------------
        function set_marker_handlers(marker) {
            let asset_id = marker.id
            if (marker.ports) {

                if (marker.ports.length > 0) {
                    marker.bindContextMenu({
                        contextmenu: true,
                        contextmenuWidth: 140,
                        contextmenuItems: [],
                        contextmenuInheritItems: false
                    });

                    for (let p=0; p<marker.ports.length; p++) {
                        let port_id = ''+marker.ports[p].id;
                        marker.options.contextmenuItems.push({
                            icon: '{{dir_settings.resource_prefix}}icons/Connect.png',
                            text: 'Connect ' + marker.ports[p].type + ' (' + port_id + '): ' + marker.ports[p].name,
                            callback: function(e) { connectAsset(e, asset_id, port_id); }
                        });
                    }
                    marker.options.contextmenuItems.push('-');

                    for (let p=0; p<marker.ports.length; p++) {
                        let port_id = marker.ports[p].id;
                        marker.options.contextmenuItems.push({
                            icon: '{{dir_settings.resource_prefix}}icons/Graph.png',
                            text: 'Set profile of ' + marker.ports[p].type + ' (' + port_id + '): ' + marker.ports[p].name,
                            callback: function(e) { setPortProfile(e, asset_id, port_id); }
                        });
                    }

                    marker.options.contextmenuItems.push('-');
                    marker.options.contextmenuItems.push({
                        text: 'Set carrier',
                        icon: '{{dir_settings.resource_prefix}}icons/SetCarrier.png',
                        callback: function(e) {
                            select_carrier_menu(asset_id);
                        }
                    });

                    if (marker.capability == 'Conversion') {
                        marker.options.contextmenuItems.push('-');
                        for (p=0; p<marker.ports.length; p++) {
                            let port_id = marker.ports[p].id

                            if (marker.ports[p].type == 'OutPort') {
                                menu_item_txt = 'Set DrivenByDemand for [' + asset_id + ']: ' + marker.ports[p].type + ' (' + port_id + '): ' + marker.ports[p].name;
                                callback_function = function(e) {
                                    set_driven_by_demand(asset_id, port_id);
                                }
                            } else {
                                menu_item_txt = 'Set DrivenBySupply for [' + asset_id + ']: ' + marker.ports[p].type + ' (' + port_id + '): ' + marker.ports[p].name;
                                callback_function = function(e) {
                                    set_driven_by_supply(asset_id, port_id);
                                }
                            }

                            marker.options.contextmenuItems.push({
                                icon: '{{dir_settings.resource_prefix}}icons/Graph.png',
                                text: menu_item_txt,
                                callback: callback_function
                            });
                        }
                    }

                    if (marker.capability == 'Storage') {
                        marker.options.contextmenuItems.push('-');
                        marker.options.contextmenuItems.push({
                            icon: '{{dir_settings.resource_prefix}}icons/Graph.png',
                            text: 'Set StorageStrategy for [' + marker.id + ']',
                            callback: function(e) {
                                // set_storage_strategy(asset_id);
                            }
                        });
                    }

                    if (marker.capability == 'Consumer' || marker.capability == 'Producer' ||
                            marker.capability == 'Conversion') {
                        marker.options.contextmenuItems.push('-');
                        marker.options.contextmenuItems.push({
                            icon: '{{dir_settings.resource_prefix}}icons/Costs.png',
                            text: 'Set marginal costs for [' + asset_id + ']',
                            callback: function(e) {
                                socket.emit('command', {cmd: 'set_marginal_costs_get_info', asset_id: asset_id})
                                //marginal_costs_window(asset_id);
                            }
                        });
                    }

                    marker.options.contextmenuItems.push('-');
                    marker.options.contextmenuItems.push({
                        // icon: '{{dir_settings.resource_prefix}}icons/Costs.png',
                        text: 'Set sector',
                        callback: function(e) {
                            select_sector_menu(asset_id);
                        }
                    });
                    // TODO: decide on seperators
                    marker.options.contextmenuItems.push('-');
                }

            }

            marker.on('dragend', function(e) {
                var marker = e.target;
                var pos = marker.getLatLng();
                socket.emit('update-coord', {id: marker.id, lat: pos.lat, lng: pos.lng, asspot: marker.asspot});
                // console.log(e.oldLatLng.lat);
                // console.log(pos.lat + ', ' + pos.lng );
            });

            marker.on('remove', function(e) {
                // console.log('remove marker');
                // marker.options.icon.tooltip('destroy');
                $(".ui-tooltip-content").parents('div').remove();

                if (deleting_objects == true) {
                    // Remove polygon that belongs to marker, if one is present
                    if (marker.polygon) {
                       all_layers = esdl_layer.getLayers();
                       for (let i=0; i<all_layers.length; i++) {
                            layer = all_layers[i];
                            if (layer.id == asset_id && layer instanceof L.Polygon) {
                                esdl_layer.removeLayer(layer);
                            }
                       }
                    }
                    socket.emit('command', {cmd: 'remove_object', id: marker.id, asspot: marker.asspot});
                }
            });

            marker.on('click', function(e) {
                var marker = e.target;
                if (deleting_objects == false && editing_objects == false) {        // do not execute when removing/editing objects
                    // console.log('marker clicked');
                    var marker = e.target;
                    var id = marker.id;

                    if (connecting_assets) {
                        if (marker.asspot == 'asset') {
                            connectAssets(marker);
                        } else {
                            alert('Cannot connect to potential');
                        }
                    } else {
                        socket.emit('command', {cmd: 'get_object_info', id: id, asspot: marker.asspot});
                    }
                }
            });

             // let extensions know they can update this layer.
            // e.g. add a context menu item
            for (let i=0; i<extensions.length; i++) {
                updatefun = extensions[i];
                updatefun({type: 'add_contextmenu', layer: marker});
            }
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Handlers for clicking on a pipe or cable
        // ------------------------------------------------------------------------------------------------------------
        function set_line_handlers(line) {
            let line_id = line.id;
            line.bindContextMenu({
                contextmenu: true,
                contextmenuWidth: 140,
                contextmenuItems: [],
                contextmenuInheritItems: false
            });
            line.options.contextmenuItems.push(
                { text: 'Split', icon: '{{dir_settings.resource_prefix}}icons/SplitLine.png', callback: function(e) { splitConductorCallback(e, line_id); } });
            line.options.contextmenuItems.push(
                { text: 'Split and connect', icon: '{{dir_settings.resource_prefix}}icons/SplitLine.png', callback: function(e) { splitConductorConnectCallback(e, line_id); } });
            line.options.contextmenuItems.push(
                { text: 'Split and add joint', icon: '{{dir_settings.resource_prefix}}icons/SplitLine.png', callback: function(e) { splitConductorAddJointCallback(e, line_id); } });
            line.options.contextmenuItems.push('-');

            //{ text: 'Connect', icon: '{{dir_settings.resource_prefix}}icons/Connect.png', disabled: true, callback: connectConductor },
            for (let p=0; p<line.ports.length; p++) {
                let port_id = ''+line.ports[p].id;
                line.options.contextmenuItems.push({
                    icon: '{{dir_settings.resource_prefix}}icons/Connect.png',
                    text: 'Connect ' + line.ports[p].type + ' (' + port_id + '): ' + line.ports[p].name,
                    callback: function (e) { connectAsset(e, line_id, port_id); }
                });
            }

            line.options.contextmenuItems.push('-');
            line.options.contextmenuItems.push(
                { text: 'Set carrier', icon: '{{dir_settings.resource_prefix}}icons/SetCarrier.png', callback: setCarrier });
            //line.options.contextmenuItems.push('-');
            //line.options.contextmenuItems.push({ text: 'Cancel' });

            line.on('remove', function(e) {
                var layer = e.target;
                if (layer.mouseOverArrowHead !== undefined) {
                    map.removeLayer(layer.mouseOverArrowHead)
                    delete layer.mouseOverArrowHead;
                }
                // TEST IF THIS IS BETTER
                // if (clear_layer == false) socket.emit('command', {cmd: 'remove_object', id: line.id});
                if (deleting_objects == true) socket.emit('command', {cmd: 'remove_object', id: line.id});
            });

            line.on('click', function(e) {
                if (deleting_objects == false && editing_objects == false) {
                    var line = e.target;
                    var id = line.id;
                    // console.log('line clicked: ' + line.title + '(' + line.type + ')');

                    if (connecting_assets) {
                        connectAssets(line);
                    } else {
                        // show popup after getting conductor info
                        socket.emit('command', {cmd: 'get_conductor_info', id: line.id, latlng: e.latlng});
                    }
                }
            });

            line.on('mouseover', function(e) {

                var layer = e.target;
                if (layer.type === undefined) {
                    layer.type = 'ElectricityCable';
                }
                layer.setStyle({
                    color: colors[layer.type + '_hoover'],
                    opacity: 1,
                    weight: 4
                });
                let lineType = layer.type;
                let lineColorHoover = colors[lineType + '_hoover']
                let arrowHead = L.polylineDecorator(layer, {
                            patterns: [
                                {
                                    offset: '1%',
                                    repeat: '49%',
                                    symbol: L.Symbol.arrowHead({pixelSize: 12, polygon: true, pathOptions: {stroke: true, color: lineColorHoover, fillOpacity: 1, weight: 1}})
                                }
                            ]
                        }).addTo(map);
                line.mouseOverArrowHead = arrowHead; // make sure we can removed it later in the mouseOut event
            });

            line.on('mouseout', function(e) {
                var layer = e.target;
                layer.setStyle({
                    color: colors[layer.type],
                    opacity: 1,
                    weight: 3
                });
                if (layer.mouseOverArrowHead !== undefined) {
                    map.removeLayer(layer.mouseOverArrowHead)
                    delete layer.mouseOverArrowHead;
                }
            });

            // let extensions know they can update this layer.
            // e.g. add a context menu item
            for (let i=0; i<extensions.length; i++) {
                updatefun = extensions[i];
                updatefun({type: 'add_contextmenu', layer: line});
            }

        }

        // ------------------------------------------------------------------------------------------------------------
        //  Connecting assets (This way of connecting is not used now and button currently disabled)
        // ------------------------------------------------------------------------------------------------------------
        function connectAssets(object) {
            // console.log('this object is either a line or a marker: ');
            // console.log(object);
            if (first_clicked) {
                first_clicked = false;
                if (first_clicked_id == object.id) {       // clicked same asset twice
                    // console.log('first clicked cancelled');
                } else {                            // connect two assets
                    document.getElementById('conn_asset_id2').innerHTML = object.id;
                    document.getElementById('conn_asset_name2').innerHTML = object.name;
                    document.getElementById('conn_asset_type2').innerHTML = object.type;
                    document.getElementById('conn_asset_result').innerHTML = first_clicked_id + ' and ' + object.id + ' are now connected.';
                    document.getElementById('conn_asset_action').innerHTML = 'Click first asset...!';

                    // console.log('second clicked' + object.id + ', connecting...');
                    socket.emit('command', {cmd: 'connect_assets', id1: first_clicked_id, id2: object.id});

                    // TODO: timer to clear sidebar?
                }
                first_clicked_id = 0;
            } else {
                first_clicked = true;
                first_clicked_id = object.id;

                document.getElementById('conn_asset_id1').innerHTML = object.id;
                document.getElementById('conn_asset_name1').innerHTML = object.name;
                document.getElementById('conn_asset_type1').innerHTML = object.type;
                document.getElementById('conn_asset_result').innerHTML = '';
                document.getElementById('conn_asset_action').innerHTML = 'Click second asset...!';

                // console.log('first clicked ' + first_clicked_id);
            }
        }

        function conn_assets_window() {
            sidebar_ctr = sidebar.getContainer();
            sidebar_ctr.innerHTML = '<h1>Connect assets</h1>';

            par = '<p id="conn_asset_result"></p>';
            par += '<p><h2 style="color:blue;" id="conn_asset_action">Click first asset!</h2></p>';
            sidebar_ctr.innerHTML += par;

            table = '<table>';
            table += '<tr><td width=180><b>First asset:</b></td><td>&nbsp;</td></tr>';
            table += '<tr><td width=180>Id:</td><td id="conn_asset_id1">&nbsp;</td></tr>';
            table += '<tr><td width=180>Name:</td><td id="conn_asset_name1">&nbsp;</td></tr>';
            table += '<tr><td width=180>Type:</td><td id="conn_asset_type1">&nbsp</td></tr>';
            table += '<tr><td>&nbsp;</td><td>&nbsp;</td></tr>';
            table += '<tr><td width=180><b>Second asset:</b></td><td>&nbsp;</td></tr>';
            table += '<tr><td width=180>Id:</td><td id="conn_asset_id2">&nbsp;</td></tr>';
            table += '<tr><td width=180>Name:</td><td id="conn_asset_name2">&nbsp;</td></tr>';
            table += '<tr><td width=180>Type:</td><td id="conn_asset_type2">&nbsp</td></tr>';
            table += '</table>';

            sidebar_ctr.innerHTML += table;

            sidebar.show();
        }

        function conn_disconn_assets() {
            var button = document.getElementById('conn-disconn-assets');
            first_clicked = false;
            if (connecting_assets) {
                connecting_assets = false;
                button.innerHTML = 'Connect assets';
                sidebar.hide();
            } else {
                conn_assets_window();
                connecting_assets = true;
                button.innerHTML = 'Stop connecting assets';
            }
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Boundary information from GEIS boundary service
        // ------------------------------------------------------------------------------------------------------------
        function boundary_info_window() {
            sidebar_ctr = sidebar.getContainer();

            sidebar_ctr.innerHTML = '<h1>Boundary Information:</h1>';

            table = '<table>';
            table = table + '<tr><td width=180>Scope</td>';
            <!-- table = table + '<td><input type="text" width="60" id="scope" value="district"></td></tr>'; -->

            table = table + '<td><select id="scope">';
            table = table + '<option value="country">country</option>';
            table = table + '<option value="province">province</option>';
            table = table + '<option value="region">region</option>';
            table = table + '<option value="municipality" selected>municipality</option>';
            table = table + '<option value="district">district</option>';
            table = table + '<option value="neighbourhood">neighbourhood</option>';
            table = table + '</select></td></tr>';

            table = table + '<tr><td width=180>Subscope</td>';
            <!-- table = table + '<td><input type="text" width="60" id="subscope" value="neighbourhood"></td></tr>'; -->

            table = table + '<td><select id="subscope">';
            table = table + '<option value="country">country</option>';
            table = table + '<option value="province">province</option>';
            table = table + '<option value="region">region</option>';
            table = table + '<option value="municipality">municipality</option>';
            table = table + '<option value="district">district</option>';
            table = table + '<option value="neighbourhood" selected>neighbourhood</option>';
            table = table + '</select></td></tr>';

            table = table + '<tr><td width=180>Identifier</td>';
            table = table + '<td><input type="text" width="60" id="identifier" value="GM0060"></td></tr>';
            table = table + '<tr><td width=180>Initialize energysystem</td>';
            table = table + '<td><input type="checkbox" id="initialize_ES" checked></td></tr>';
            table = table + '<tr><td width=180>Add boundaries to energysystem</td>';
            table = table + '<td><input type="checkbox" id="add_boundary_to_ESDL" disabled></td></tr>';
            table = table + '</table>';
            sidebar_ctr.innerHTML += table;

            sidebar_ctr.innerHTML += '<p><button onclick="sidebar.hide();get_boundary_info(this);">Request</button></p>';

            sidebar.show();
        }

        function get_boundary_info(obj) {
            identifier = document.getElementById('identifier').value;
            scope = document.getElementById('scope').value;
            subscope = document.getElementById('subscope').value;
            initialize_ES = document.getElementById('initialize_ES').checked;
            add_boundary_to_ESDL = document.getElementById('add_boundary_to_ESDL').checked;

            show_loader();
            socket.emit('get_boundary_info', {identifier: identifier, scope: scope, subscope: subscope,
                initialize_ES: initialize_ES, add_boundary_to_ESDL: add_boundary_to_ESDL});
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Marginal costs (used by ESSIM)
        // ------------------------------------------------------------------------------------------------------------
        function set_marginal_costs(asset_id) {
            mc = document.getElementById('marg_costs').value;
            // console.log(mc);
            socket.emit('command', {cmd: 'set_marg_costs', asset_id: asset_id, marg_costs: mc});
        }

        function marginal_costs_window(asset_id, mc) {
            // console.log(typeof(mc));
            // console.log(mc);
            if (mc == null) { mc = ''; }

            sidebar_ctr = sidebar.getContainer();

            sidebar_ctr.innerHTML = '<h1>Set marginal costs:</h1>';

            table = '<table>';
            table = table + '<tr><td width=180>Marginal costs</td>';
            table = table + '<td><input type="text" width="60" id="marg_costs" value="' + mc + '"></td></tr>';
            table += '</table>';
            sidebar_ctr.innerHTML += table;

            sidebar_ctr.innerHTML += '<p><button onclick="sidebar.hide();set_marginal_costs(\''+ asset_id + '\');">Set costs</button></p>';
            sidebar.show();
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Storage strategies (used by ESSIM)
        // ------------------------------------------------------------------------------------------------------------
        function set_driven_by_demand(asset_id, port_id) {
            socket.emit('command', {'cmd': 'set_control_strategy', 'strategy': 'DrivenByDemand', 'asset_id': asset_id, 'port_id': port_id});
        }

        function set_driven_by_supply(asset_id, port_id) {
            socket.emit('command', {'cmd': 'set_control_strategy', 'strategy': 'DrivenBySupply', 'asset_id': asset_id, 'port_id': port_id});
        }

        function set_storage_strategy(asset_id) {
            mcc = document.getElementById('marg_ch_costs').value;
            mdc = document.getElementById('marg_disch_costs').value;
            socket.emit('command', {cmd: 'set_control_strategy', asset_id: asset_id, strategy: 'StorageStrategy', marg_ch_costs: mcc, marg_disch_costs: mdc});
        }

        function storage_strategy_window(asset_id, mcc, mdc) {
            sidebar_ctr = sidebar.getContainer();

            sidebar_ctr.innerHTML = '<h1>Storage Strategy:</h1>';

            table = '<table>';
            table = table + '<tr><td width=180>Marginal charge costs</td>';
            table = table + '<td><input type="text" width="60" id="marg_ch_costs" value="' + mcc + '"></td></tr>';
            table = table + '<tr><td width=180>Marginal discharge costs</td>';
            table = table + '<td><input type="text" width="60" id="marg_disch_costs" value="' + mdc + '"></td></tr>';
            table += '</table>';
            sidebar_ctr.innerHTML += table;

            sidebar_ctr.innerHTML += '<p><button onclick="sidebar.hide();set_storage_strategy(\''+ asset_id + '\');">Set costs</button></p>';
            sidebar.show();
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Functions for starting a new ESDL file, loading and saving an ESDL file
        // ------------------------------------------------------------------------------------------------------------
        function new_ESDL() {
            sidebar_ctr = sidebar.getContainer();
            sidebar_ctr.innerHTML = '<h1>New ESDL energysystem</h1>';

            table = '<table>';
            table += '<tr><td width=180>Name</td><td><input type="text" width="60" id="new_name"></td></tr>';
            table += '<tr><td width=180>Description</td><td><input type="text" width="60" id="new_description"></td></tr>';
            table += '<tr><td width=180>Email address</td><td><input type="text" width="60" id="new_email"></td></tr>';
            table += '<tr><td width=180></td><td></td></tr>';
            table += '<tr><td width=180>Top-level area name</td><td><input type="text" width="60" id="new_area_name"></td></tr>';
            table += '</table>';

            sidebar_ctr.innerHTML += table;
            sidebar_ctr.innerHTML += '<p><button onclick="sidebar.hide();click_new_ESDL_button(this);">Create</button></p>';

            sidebar.show();
        }

        function click_new_ESDL_button(obj) {
            new_name = document.getElementById('new_name').value;
            new_description = document.getElementById('new_description').value;
            new_email = document.getElementById('new_email').value;
            new_top_area_name = document.getElementById('new_area_name').value;

            socket.emit('file_command', {cmd: 'new_esdl', name: new_name, description: new_description,
                email: new_email, top_area_name: new_top_area_name});
        }

        function open_ESDL(event) {
            // getting a hold of the file reference
            var file = event.target.files[0];

            // setting up the reader
            var reader = new FileReader();
            reader.readAsText(file); // this is reading as data url

            // here we tell the reader what to do when it's done reading...
            reader.onload = readerEvent => {
                var content = readerEvent.target.result; // this is the content!
                socket.emit('file_command', {cmd: 'load_esdl_from_file', filename: file.name, file_content: content});
            }

            // show loader
            show_loader();
        }

        function import_ESDL(event) {
            // getting a hold of the file reference
            var file = event.target.files[0];

            // setting up the reader
            var reader = new FileReader();
            reader.readAsText(file); // this is reading as data url

            // here we tell the reader what to do when it's done reading...
            reader.onload = readerEvent => {
                var content = readerEvent.target.result; // this is the content!
                socket.emit('file_command', {cmd: 'import_esdl_from_file', filename: file.name, file_content: content});
            }

            // show loader
            show_loader();
        }

        function send_cmd_load_ESDL() {
            socket.emit('file_command', {cmd: 'get_list_from_store'});
        }

        function click_load_ESDL_button(obj) {
            select = document.getElementById('load_es_selection');
            es_id = select.options[select.selectedIndex].value;
            es_title = select.options[select.selectedIndex].innerHTML;
            // console.log(es_id);

            title_div = document.getElementById('es_title');
            title_div.innerHTML = '<h1>' + es_title + '</h1>';

            socket.emit('file_command', {cmd: 'load_esdl_from_store', id: es_id});

            // show loader
            show_loader();
        }


        // Save ESDL: creates an IFrame to download, otherwise the websocket connection will be reset
        // if we set the window.location.href directly...
        var $idown;  // Keep it outside of the function, so it's initialized once.
        function save_ESDL(e) {
            let url = '.{{dir_settings.download_prefix}}/esdl'
            //if ($idown) {
            //    $idown.attr('src',url);
            //} else {
            //    $idown = $('<iframe>', { id:'idown', src:url }).hide().appendTo('body');
            //}
            // The following code does a HTML5 download request.
            // From stackoverflow:
            // simply setting the window.url to the download url does not work as it navigates away from the current
            // page, releasing the websocket connection.
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.responseType = 'arraybuffer';
            xhr.onload = function () {
                if (this.status === 200) {
                    var filename = "";
                    var disposition = xhr.getResponseHeader('Content-Disposition');
                    if (disposition && disposition.indexOf('attachment') !== -1) {
                        var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                        var matches = filenameRegex.exec(disposition);
                        if (matches != null && matches[1]) filename = matches[1].replace(/['"]/g, '');
                    }
                    var type = xhr.getResponseHeader('Content-Type');

                    var blob;
                    if (typeof File === 'function') {
                        try {
                            blob = new File([this.response], filename, { type: type });
                        } catch (e) { /* Edge */ }
                    }
                    if (typeof blob === 'undefined') {
                        blob = new Blob([this.response], { type: type });
                    }

                    if (typeof window.navigator.msSaveBlob !== 'undefined') {
                        // IE workaround for "HTML7007: One or more blob URLs were revoked by closing the blob for which they were created. These URLs will no longer resolve as the data backing the URL has been freed."
                        window.navigator.msSaveBlob(blob, filename);
                    } else {
                        var URL = window.URL || window.webkitURL;
                        var downloadUrl = URL.createObjectURL(blob);

                        if (filename) {
                            // use HTML5 a[download] attribute to specify filename
                            var a = document.createElement("a");
                            // safari doesn't support this yet
                            if (typeof a.download === 'undefined') {
                                window.location = downloadUrl;
                            } else {
                                a.href = downloadUrl;
                                a.download = filename;
                                document.body.appendChild(a);
                                a.click();
                            }
                        } else {
                            window.location = downloadUrl;
                        }

                        setTimeout(function () { URL.revokeObjectURL(downloadUrl); }, 100); // cleanup
                    }
                }
            };
            xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            xhr.send();
        }

        function send_cmd_store_ESDL() {
            socket.emit('file_command', {cmd: 'store_esdl'});
        }

        function send_download_ESDL() {
            socket.emit('file_command', {cmd: 'download_esdl'});
        }

        // ------------------------------------------------------------------------------------------------------------
        //
        // ------------------------------------------------------------------------------------------------------------
        setPortProfile = function(e, marker_id, port_id) {
            // console.log('setPortProfile(marker_id=' + marker_id + ', port_id=' + port_id + ')');
            socket.emit('command', {'cmd': 'get_port_profile_info', 'port_id': port_id});
        }

        // find a layer assocated with an asset_id
        function find_layer(asset_id) {
           all_layers = esdl_layer.getLayers();
           for (let i=0; i<all_layers.length; i++) {
                layer = all_layers[i];
                if (layer.id == asset_id) {
                    return layer;
                }
           }
        }

        function add_port(direction, asset_id) {
            // get name
            pname = document.getElementById('name_add_port').value;
            socket.emit('command', {cmd: 'add_port', direction: direction, asset_id: asset_id, pname: pname});
        }

        function remove_port(pid) {
            socket.emit('command', {cmd: 'remove_port', port_id: pid});
        }

        function remove_connection(from_asset_id, from_port_id, to_asset_id, to_port_id) {
            socket.emit('command', {cmd: 'remove_connection', from_asset_id:from_asset_id, from_port_id:from_port_id, to_asset_id:to_asset_id, to_port_id:to_port_id});
        }

        function change_param(obj) {
            asset_id = $(obj).attr('assetid');
            asset_param_name = obj.name;
            asset_param_value = obj.value;
            socket.emit('command', {cmd: 'set_asset_param', id: asset_id, param_name: asset_param_name, param_value: asset_param_value});
        }

        function ClickMarker(e) {
            // alert (e.latlng);
        }

        function connectAsset(e, feature_id, port_id) {
            // console.log('connectAsset(feature_id=' + feature_id + ', port_id=' + port_id + ')');
            // console.log(e);
            if (connect_ports != null) {
                socket.emit('command', {'cmd': 'connect_ports', port1id: connect_ports, port2id: port_id});
                connect_ports = null;
            } else {
                connect_ports = port_id;
            }
        }

        function connectConductor(e) {
            // alert (e.latlng);
        }

        function splitConductor(id, location, mode) {
            socket.emit('command', {cmd: 'split_conductor', id: id, location: location, mode: mode});
        }

{% if 'essim' in role %}
        // ------------------------------------------------------------------------------------------------------------
        //   ESSIM related functions
        // ------------------------------------------------------------------------------------------------------------
        function validate_for_ESSIM() {
            socket.emit('command', {cmd: 'validate_for_ESSIM'});
        }

        function show_validate_for_ESSIM_window(results) {
            sidebar_ctr = sidebar.getContainer();

            sidebar_ctr.innerHTML = '<h1>ESSIM Validation results:</h1>';

            table = '<table>';
            for (i=0; i<results.length; i++) {
                table += '<tr><td>' + results[i] + '</td></tr>'
            }
            table += '</table>';
            sidebar_ctr.innerHTML += table;

            sidebar_ctr.innerHTML += '<p id="button_close_validation_dialog"><button onclick="sidebar.hide();">Close</button></p>';

            sidebar.show();
        }

        // ------------------------------------------------------------------------------------------------------------
        //
        // ------------------------------------------------------------------------------------------------------------
        function run_ESSIM_simulation() {
            socket.emit('command', {cmd: 'run_ESSIM_simulation'});
        }

        function cancel_ESSIM_simulation() {
            socket.emit('command', {cmd: 'cancel_ESSIM_simulation'});
        }

        function poll_simulation_progress() {
            $.ajax({
		        url: '{{dir_settings.resource_prefix}}simulation_progress',
                success: function(data){
                    // console.log(data);

                    if (data["percentage"] == "1") {
                        let dashboardURL = data["url"];
                        let simulationRun = data["simulationRun"];
                        // console.log(dashboardURL);
                        let progress = document.getElementById('progress_percentage');
                        progress.innerHTML = 'Simulation finsihed';
                        let dbURL_location = document.getElementById('dashboard_url');
                        dbURL_location.innerHTML = 'Go to <a href="' + dashboardURL + '" target="#">dashboard</a>';
                        let simRun_location = document.getElementById('simulationRun');
                        simRun_location.innerHTML = simulationRun;

                        let button_show = document.getElementById('button_close_simulation_dialog');
                        button_show.style.display = "block";
                        let button_hide = document.getElementById('button_cancel_simulation');
                        button_hide.style.display = "none";

                    } else {
                        let percentage = Math.round(parseFloat(data["percentage"]) * 100);
                        let progress = document.getElementById('progress_percentage');
                        progress.innerHTML =  percentage + '%';
                        setTimeout(poll_simulation_progress, 1000);
                    }
                },
                dataType: "json"
            });
        }

        function show_simulation_progress_window() {
            sidebar_ctr = sidebar.getContainer();

            sidebar_ctr.innerHTML = '<h1>ESSIM Simulation</h1>';

            table = '<table>';
            table = table + '<tr><td width=180>Progress</td>';
            table = table + '<td id="progress_percentage">0%</td></tr>';
            table += '</table>';
            sidebar_ctr.innerHTML += table;

            sidebar_ctr.innerHTML += '<p id="dashboard_url"></p>';
            sidebar_ctr.innerHTML += '<p id="simulationRun"></p>';

            sidebar_ctr.innerHTML += '<p id="button_cancel_simulation"><button onclick="cancel_ESSIM_simulation(); sidebar.hide();">Cancel simulation</button></p>';
            sidebar_ctr.innerHTML += '<p id="button_close_simulation_dialog" hidden><button onclick="sidebar.hide();">Close</button></p>';

            sidebar.show();
            setTimeout(poll_simulation_progress, 1000)
        }

        function calculate_ESSIM_KPIs() {
            socket.emit('command', {cmd: 'calculate_ESSIM_KPIs'});

            // show loader
            show_loader();
        }

        // format-number-with-si-prefix.js
        // https://gist.github.com/cho45/9968462
        function formatN (n) {
            // console.log("n: ", n);
            var nn = n.toExponential(2).split(/e/);
            // console.log("nn: ", nn)
            var u = Math.floor(+nn[1] / 3);
            // console.log("u: ", u)
            return nn[0] * Math.pow(10, +nn[1] - u * 3) + ['p', 'n', 'u', 'm', '', 'k', 'M', 'G', 'T', 'P'][u+4];
        }

        function print_value_unit(val, unit) {
            if (unit == 'kgCO2') {
                val_s = parseFloat(Number(val / 1e6).toPrecision(2)).toString();
                return val_s + ' kton CO2';
            } else {
                val_s = formatN(val);
                // console.log(val);
                // console.log(unit);
                // console.log(val_s);
                return val_s + unit;
            }
        }

        function show_ESSIM_KPIs(results) {
            sidebar_ctr = sidebar.getContainer();

            sidebar_ctr.innerHTML = '<h1>ESSIM KPI\'s</h1>';

            let category = null;
            let table = "";

            for (let i=0; i<results.length; i++) {
                let name = results[i]['name'];
                let cat_kpi = name.split("-");
                let cat = cat_kpi[0];
                let kpi = cat_kpi[1];

                if (cat != category) {            // stop table, start new one
                    if (table != "") {
                        table += '</table>';
                        sidebar_ctr.innerHTML += table;
                        table = "";
                    }
                    sidebar_ctr.innerHTML += '<h2>'+cat+'</h2>';
                    table = '<table>';
                    category = cat;
                }
                if (kpi.indexOf("Total") == 0) {
                    bold_start = "<b>";
                    bold_end = "</b>";
                } else {
                    bold_start = "";
                    bold_end = "";
                }
                table += '<tr><td width=180>'+bold_start+kpi+bold_end+'</td>';
                table += '<td>'+bold_start+print_value_unit(results[i]['value'], results[i]['unit'])+bold_end+'</td></tr>';
            }
            table += '</table>';
            sidebar_ctr.innerHTML += table;

            sidebar.show();
        }
{% endif %}

        // ------------------------------------------------------------------------------------------------------------
        //  Shapefile functions - Not working at the moment
        // ------------------------------------------------------------------------------------------------------------
        function load_shapefile() {
        	var files = document.getElementById('shapefile').files;
            if (files.length == 0) {
                console.log('filelength is zero');
                return; //do nothing if no file given yet
            }

            var file = files[0];

            if (file.name.slice(-3) != 'zip') {             // Only accept .zip. All others, return.
                document.getElementById('warning').innerHTML = 'Select .zip file';
                return;
            } else {
                document.getElementById('warning').innerHTML = ''; //clear warning message.
                handleZipFile(file);
            }
        };

        //More info: https://developer.mozilla.org/en-US/docs/Web/API/FileReader
        function handleZipFile(file){
            console.log('handle zip file');
            var reader = new FileReader();
            reader.onload = function() {
                if (reader.readyState != 2 || reader.error){
                    console.log("error");
                    return;
                } else {
                    console.log("no error");
                    convertShapefileToLayer(reader.result);
                }
            }
            reader.readAsArrayBuffer(file);
        }

        function convertShapefileToLayer(buffer) {
            shp(buffer).then(function(geojson) {	            //More info: https://github.com/calvinmetcalf/shapefile-js
                console.log('shapefile addto map');
                var layer = L.shapefile(geojson).addTo(map);       //More info: https://github.com/calvinmetcalf/leaflet.shapefile
                console.log(layer);
            });
        }

        function show_add_shapefile() {
            sidebar_ctr = sidebar.getContainer();

            sidebar_ctr.innerHTML = '<h1>Add shapefile</h1>';
            sidebar_ctr.innerHTML += '<p><label for="input">Select a zipped shapefile:</label><input type="file" id="shapefile"></p>';
            sidebar_ctr.innerHTML += '<button onclick="sidebar.hide();load_shapefile();">Load shapefile</button></p>';
            sidebar_ctr.innerHTML += '<span id="warning"></span>';

            sidebar.show();
        }

        // ------------------------------------------------------------------------------------------------------------
        //  WMS Layer functionality
        // ------------------------------------------------------------------------------------------------------------
        function add_layer() {
            layer_descr = document.getElementById('layer_descr').value;
            layer_url = document.getElementById('layer_url').value;
            layer_name = document.getElementById('layer_name').value;
            layer_id = uuidv4();

            socket.emit('command', {cmd: 'add_layer', id: layer_id, descr: layer_descr, url: layer_url, name: layer_name, visible: true});
            wms_layer_list[layer_id] = { description: layer_descr, url: layer_url, layer_name: layer_name }

            wms_layer_list[layer_id].layer_ref = L.tileLayer.wms(layer_url, {
                layers: layer_name,
                format:'image/png',
                transparent: true
            });
            wms_layer_list[layer_id].layer_ref.addTo(map);
            wms_layer_list[layer_id].layer_ref.bringToFront();
            wms_layer_list[id].visible = true;
        }

        function remove_layer(id) {
            socket.emit('command', {cmd: 'remove_layer', id: id});
            // console.log('remove layer: '+id);
            map.removeLayer(wms_layer_list[id].layer_ref);
            delete wms_layer_list[id];
        }

        function click_layer(id) {
            checkbox = document.getElementById('cb_'+id);
            if (checkbox.checked) {
                // console.log('add layer to map: '+id);
                wms_layer_list[id].layer_ref.addTo(map);
                wms_layer_list[id].layer_ref.bringToFront();
                wms_layer_list[id].visible = true;
            } else {
                // console.log('remove layer from map: '+id);
                map.removeLayer(wms_layer_list[id].layer_ref);
                wms_layer_list[id].visible = false;
            }
        }

        function show_layers() {
            sidebar_ctr = sidebar.getContainer();

            sidebar_ctr.innerHTML = '<h1>WMS Layers</h1>';
            table = '<table>';
            for (var key in wms_layer_list) {
                let value = wms_layer_list[key];

                table += '<tr><td><input type="checkbox" id="cb_'+ key +'" name="' +value.description+ '" onclick="click_layer(\''+key+'\');"';
                if (value.visible) { table += ' checked'; }
                table +='>';
                table += '<label for="'+value.id+'">'+value.description+'</label></td>';
                table += '<td><button onclick="remove_layer(\'' + key + '\');">Del</button></td></tr>';
            }
            table += '</table>';
            sidebar_ctr.innerHTML += table;

            sidebar_ctr.innerHTML += '<h2>Add layers:</h2>';
            table = '<table>';
            table += '<tr><td width=180>Description</td><td><input type="text" width="60" id="layer_descr"></td></tr>';
            table += '<tr><td width=180>URL</td><td><input type="text" width="60" id="layer_url"></td></tr>';
            table += '<tr><td width=180>Layer name</td><td><input type="text" width="60" id="layer_name"></td></tr>';
            table += '<tr><td><button onclick="add_layer();">Add layer</button></td><td>&nbsp;</td>';
            table += '</table>';
            sidebar_ctr.innerHTML = sidebar_ctr.innerHTML + table;

            sidebar.show();
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Energy System information
        // ------------------------------------------------------------------------------------------------------------
        function get_es_info() {
            socket.emit('command', {cmd: 'get_es_info'});
        }

        function change_es_info(obj) {
            es_info_param_id = obj.id;
            es_info_param_name = obj.name;
            es_info_param_value = obj.value;

            socket.emit('command', {cmd: 'set_es_info_param', id: es_info_param_id, name: es_info_param_name, value: es_info_param_value});
        }

        function show_es_info(es_attrs) {
            // console.log(es_attrs);

            sidebar_ctr = sidebar.getContainer();

            sidebar_ctr.innerHTML = '<h1>Energy system information</h1>';

            table = '<table>';
            for (i=0; i<es_attrs.length; i++) {
                if (es_attrs[i][1] == null) {
                    value = '';
                } else {
                    value = es_attrs[i][1];
                }
                table += '<tr><td width=180>' + es_attrs[i]['name'] + '</td>';
                table += '<td><input type="text" width="60" id="' + es_attrs[i]['id'] + '" name="' +
                        es_attrs[i]['name'] + '" value="' + es_attrs[i]['value']+ '" onchange="change_es_info(this);"></td></tr>';
            }
            table += '</table>';
            sidebar_ctr.innerHTML = sidebar_ctr.innerHTML + table;

            sidebar.show();
        }

        function animate_ESSIM_load() {
            show_loader();
            $.ajax({
		        url: '{{dir_settings.resource_prefix}}load_animation',
                success: function(data){
                    // console.log('succes');
                    // console.log(data);

                    var geoJsonLayer = L.geoJson(data, {
                        style: function(feature) {
                            return {
                                "color": feature.properties.stroke,
                                "weight": feature.properties.strokewidth,
                                "opacity": 1
                            };
                        }
                    });

                    var geoJsonTimeLayer = L.timeDimension.layer.geoJson.geometryCollection(geoJsonLayer, {
                        updateTimeDimension: true,
                        updateTimeDimensionMode: 'replace',
                        duration: 'PT1H',
                    });

                    geoJsonTimeLayer.addTo(sim_layer);
                    hide_loader();
                },
                error: function() {
                    hide_loader();
                    alert("Error in getting load animation from backend");
                },
                dataType: "json"
            });
        }

        var socket;

        // ------------------------------------------------------------------------------------------------------------
        //  Document is ready loading --> all functionality to react on incoming socket messages
        // ------------------------------------------------------------------------------------------------------------
        $(document).ready(function() {
            namespace = '/esdl';
            socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port + namespace, {'timeout':50000, 'connect timeout': 15000, path: "{{dir_settings.socket_prefix}}/socket.io"});

            // tell server we are ready to receive
            socket.emit('initialize');

            // request the list of assets in the EDR
            get_edr_assets('{{dir_settings.resource_prefix}}edr_assets');

            socket.on('connect', function() {
                console.log('connected');
                socket.emit('mngmnt', {data: 'I\'m connected!'});
            });

            socket.on('log', function(msg) {
                $('#log').append('<br>' + $('<div/>').text('Received #' + msg.count + ': ' + msg.data).html());
            });

            socket.on('clear_ui', function(msg) {
                clear_layer = true;
                if (msg == null || msg['layer'] == 'assets') {
                    esdl_layer.clearLayers();
                }
                if (msg == null || msg['layer'] == 'areas') {
                    area_layer.clearLayers();
                }
                if (msg == null || msg['layer'] == 'potentials') {
                    pot_layer.clearLayers();
                }
                if (msg == null || msg['layer'] == 'buildings') {
                    bld_layer.clearLayers();
                }
                if (msg == null || msg['layer'] == 'connections') {
                    connection_layer.clearLayers();
                }
                clear_layer = false;
            });

            socket.on('add_marker', function(point_coords) {
                // console.log(point_coords);

                var marker = L.Marker(point_coords);
                esdl_layer.addLayer(marker); // marker.addTo(map);
            });

            socket.on('add_esdl_objects', function(options) {
                // Format of list items
                // 0         1          2       3           4       5          6       7
                // 'point'   asset      name    id      class_name  [lat,lon]  [ports] capability
                // 'line'    asset      name    id      class_name  [...]      [ports]
                // 'polygon' asset      name    id      class_name  [...]      [ports] capability
                // 'point'   potential  name    id      class_name  [lat,lon]

                // hide_loader();
                console.log(options);
                list = options['asset_pot_list'];
                es_id = options['es_id'];

                for (let i = 0; i<list.length; i++) {
                    $('#log').append('<br>' + list[i][0]+ ', ' + list[i][2] + ': ' + list[i][3] + ' - ' + list[i][4]);

                    if ((list[i][0] == 'point' && list[i][1] == 'asset' && list[i][4] != 'Joint') ||
                        (list[i][0] == 'polygon' && list[i][1] == 'asset' )) {
                        capability = list[i][7];
                        classname = 'circle ' + capability;
                    } else {
                        classname = '';
                    }

                    imgsrc = '{{dir_settings.resource_prefix}}images/' + list[i][4] + '.png';
                    if (!assets_for_icons.includes(list[i][4])) {
                        imgsrc =  drawTextImage(getAbbrevation(list[i][4]));
                    }

                    var divicon = L.divIcon({
                        className: classname,
                        html: '<center><img class="circle-img" width="23" height="23" src="' + imgsrc + '"></img></center>',

                        iconSize:     [30, 30], // size of the icon
                        iconAnchor:   [15, 15], // point of the icon which will correspond to marker's location
                        popupAnchor:  [0, -15] // point from which the popup should open relative to the iconAnchor
                    });

					var title = list[i][4]+': '+list[i][2]+ ' (id='+ list[i][3] + ')';
                    if (list[i][0] == 'point') {
                        var marker = L.marker([list[i][5][0], list[i][5][1]], {icon: divicon, title: title});

                        marker.title = title;
                        marker.id = list[i][3];
                        marker.esid = es_id;
                        marker.name = list[i][2];
                        marker.type = list[i][4];
                        marker.asspot = list[i][1];
                        if (marker.asspot == 'asset') {
                            marker.ports = list[i][6];
                            marker.capability = list[i][7];
                        }

                        set_marker_handlers(marker);
                        esdl_layer.addLayer(marker);
                    }
                    if (list[i][0] == 'polygon') {
                        var coords = list[i][5];
                        var polygon = L.polygon(coords, {color: 'green', weight: 3, draggable:true, title: title});

                        polygon.title = title;
                        polygon.id = list[i][3];
                        polygon.esid = es_id;
                        polygon.name = list[i][2];
                        polygon.type = list[i][4];
                        polygon.asspot = list[i][1];

                        esdl_layer.addLayer(polygon);

                        var polygon_center = calculate_array_polygon_center(coords);
                        var marker = L.marker(polygon_center, {icon: divicon, title: title});

                        marker.title = title;
                        marker.id = list[i][3];
                        marker.esid = es_id;
                        marker.name = list[i][2];
                        marker.type = list[i][4];
                        marker.asspot = list[i][1];
                        marker.polygon = true;
                        if (marker.asspot == 'asset') {
                            marker.ports = list[i][6];
                            marker.capability = list[i][7];
                        }

                        set_marker_handlers(marker);
                        esdl_layer.addLayer(marker);
                    }
                    if (list[i][0] == 'line') {
                        var coords = list[i][5];
                        var lineType = list[i][4];
                        //if (list[i][4] == 'ElectricityCable') linecolor = linecolor_cable
                        //if (list[i][4] == 'Pipe') linecolor = linecolor_pipe

                        var line = L.polyline(coords, {color: colors[lineType], weight: 3, draggable:true, title: title});

                        // line.bindPopup(list[i][4]+': '+list[i][2]+ '('+ list[i][3] + ')');
						line.title = title;
                        line.id = list[i][3];
                        line.esid = es_id;
                        line.ports = list[i][6];
                        line.type = list[i][4];
                        line.name = "";

                        set_line_handlers(line);
                        esdl_layer.addLayer(line);
                    }
                }

                if (list.length > 0 && options['zoom']) {
                    var bounds = esdl_layer.getBounds();
                    map.flyToBounds(bounds, {padding: [50,50], animate: true});
                }
            });

            // update an asset.
            // currently only updates the ports for the context menu
            socket.on('update_asset', function(asset_update) {
                asset_id = asset_update['asset_id'];
                ports = asset_update['ports'];
                layer = find_layer(asset_id);
                layer.ports = ports;
                if (layer instanceof L.Marker) {
                    set_marker_handlers(layer);
                }
                if (layer instanceof L.Polyline) {
                    console.log('Update asset: Polyline not supported, since a line has one InPort and one OutPort');
                }
            });

            // TODO: does not work
            socket.on('esdltxt', function(esdl_text) {
                var div = document.getElementById('esdltxt');
                div.innerHTML = esdl_text;
            });

            socket.on('area_bld_list', function(areas_buildings) {
                var select = document.getElementById('area_bld_select');
                select.innerHTML = '';
                area_bld_list = areas_buildings['area_bld_list']
                for (i=0; i<area_bld_list.length; i++) {
                    var option = document.createElement("option");
                    if (i==0) { option.classList.add("ui-state-active"); }
                    var level = area_bld_list[i][3];
                    option.text = '';
                    if (level > 0) {
                         for (j=0; j<level; j++) option.text = option.text + '-';
                    }
                    option.text = option.text + '- ' + area_bld_list[i][0] + ': ' + area_bld_list[i][2] + ' (' + area_bld_list[i][1] + ')';
                    option.value = area_bld_list[i][1];
                    select.add(option, null);
                }
                $("#area_bld_select").selectmenu("refresh");    // to update the selectmenu based on the selected value
            });

            socket.on('clear_connections', function() {
                clear_layer = true;
                connection_layer.clearLayers();
                clear_layer = false;
            });

            socket.on('add_connections', function(connections) {
                conn_list = connections['conn_list']
                for (i = 0; i<conn_list.length; i++) {
                    var con = conn_list[i];
                    var coords = [con['from-asset-coord'], con['to-asset-coord']];

                    var line = L.polyline(coords, {color: 'gray', weight: 1, dashArray: '3,10', draggable: true});
                    connection_layer.addLayer(line);
                }
            });

            socket.on('add_new_conn', function(connection) {
                var coords = [connection[0], connection[1]];
                // console.log(coords);
                var line = L.polyline(coords, {color: 'gray', weight: 1, dashArray: '3,10', draggable: true});
                connection_layer.addLayer(line);
            });

            socket.on('store_list', function(store_items) {
                sidebar_ctr = sidebar.getContainer();

                sidebar_ctr.innerHTML = '<h1>Load ESDL from store</h1>';
                select = '<select id="load_es_selection">';
                for (i = 0; i<store_items.length; i++) {
                    select += '<option value="'+store_items[i]['id']+'"';
                    if (i==0) { select += ' selected="true" '; }
                    select += '>'+store_items[i]['title']+'</option>';
                }
                select += '</select>';
                sidebar_ctr.innerHTML = sidebar_ctr.innerHTML + select;
                sidebar_ctr.innerHTML += '<button onclick="sidebar.hide();click_load_ESDL_button(this);">Load</button>';

                sidebar.show();
            });

            socket.on('asset_info', function(asset_info) {
                asset_id = asset_info['id'];
                asset_name = asset_info['name'];
                asset_attrs = asset_info['attrs'];
                asset_doc = asset_info['asset_doc']
                connected_to_info = asset_info['connected_to_info'];
                ctrl_strategy = asset_info['ctrl_strategy'];
                //console.log(asset_attrs);
                //console.log(connected_to_info);
                //console.log(ctrl_strategy);

                sidebar_ctr = sidebar.getContainer();

                sidebar_ctr.innerHTML = '<h1 title="' + asset_doc + '">' + asset_name + '</h1>';
                //sidebar_ctr.innerHTML += 'PS. Not all parameters can be set already!';

                let idgen = 0; // generate Unique ID's otherwise jquery-ui will err
                let table = '<table>';
                for (i=0; i<asset_attrs.length; i++) {
                    if (asset_attrs[i]['value'] == null) {
                        value = '';
                    } else {
                        value = asset_attrs[i]['value'];
                    }
                    let title = 'data-html="true" title="';
                    if (asset_attrs[i]['doc'] != null) {
                        title += asset_attrs[i]['doc'];
                    }
                    if (asset_attrs[i]['type'] != null) {
                        title += '<br/>Data type:  ';
                        title += asset_attrs[i]['type'];
                        title += ' ';
                    }
                    if (asset_attrs[i]['default'] != null) {
                        title += '<br/>Default value: ';
                        title += asset_attrs[i]['default'];
                    }
                    title += '"';
                    let edate = "";
                    if (asset_attrs[i]['type'] == 'EDate') {
                        edate = ' edate="true" ';
                    }
                    table += '<tr><td width=180 ' + title + '>' + camelCaseToWords(asset_attrs[i]['name']) + '</td>';

                    if (asset_attrs[i]['type'] == 'EEnum' || asset_attrs[i]['type'] == 'EBoolean') {
                        options = asset_attrs[i]['options'];
                        table += '<td><select width="60" style="width:145px" id="'+ asset_attrs[i]['name']+idgen +'" assetid="' + asset_id + '" name="' +
                            asset_attrs[i]['name'] + '" onchange="change_param(this);">';
                            for (let o=0; o<options.length; o++) {
                                selected = "";
                                if (options[o] == value) selected=" selected";
                                caption = options[o].charAt(0).toUpperCase() + options[o].slice(1).toLowerCase();
                                caption = caption.replace(/_/g, ' '); // replace _ with space to render nicely
                                table += '<option value="' + options[o] + '" '+selected+'>' + caption + '</option>';
                            }
                        table += '</select></td></tr>';
                    } else {
                        table += '<td><input type="text" width="60" id="'+ asset_attrs[i]['name']+idgen +'" assetid="' + asset_id + '" name="' +
                            asset_attrs[i]['name'] + '" value="' + value +'" onchange="change_param(this);" ' + edate + '></td></tr>';
                    }
                    idgen++;
                }
                table += '</table>';
                sidebar_ctr.innerHTML = sidebar_ctr.innerHTML + table;

                sidebar_ctr.innerHTML += '<h2>Add ports:</h2>';
                table = '<table>';
                table += '<tr><td width=180>Name</td><td><input type="text" width="60" id="name_add_port"></td></tr>';
                table += '<tr><td><button onclick="add_port(\'in\', \'' + asset_id +
                    '\'); sidebar.hide();">Add InPort</button><button onclick="add_port(\'out\', \'' +
                    asset_id + '\'); sidebar.hide();">Add OutPort</button></td><td>&nbsp;</td>';
                table += '</table>';
                sidebar_ctr.innerHTML = sidebar_ctr.innerHTML + table;

                sidebar_ctr.innerHTML += '<h2>Current ports:</h2>';
                table = '<table>';
                for (i=0; i<connected_to_info.length; i++) {
                    pname = connected_to_info[i]['pname'];
                    if (pname == '') {
                        pname = 'No name';
                    }
                    pcarr = connected_to_info[i]['pcarr'];
                    if (pcarr == '') {
                        pcarr = 'No carrier';
                    }
                    table += '<tr><td><button onclick="remove_port(\'' + connected_to_info[i]['pid'] + '\'); sidebar.hide();">Del</button></td>';
                    table += '<td title="id: '+ connected_to_info[i]['pid'] +'">'
                        + connected_to_info[i]['ptype'] + ' - ' + pname + ' - ' + pcarr + '</td></tr>';
                }
                table += '</table>';
                sidebar_ctr.innerHTML = sidebar_ctr.innerHTML + table;

                if (ctrl_strategy) {
                    sidebar_ctr.innerHTML += '<h2>Control strategy:</h2>';
                    sidebar_ctr.innerHTML = sidebar_ctr.innerHTML + ctrl_strategy;
                }

                sidebar_ctr.innerHTML += '<h2>Connections:</h2>';
                table = '<table>';
                for (i=0; i<connected_to_info.length; i++) {
                    pname = connected_to_info[i]['pname'];
                    if (pname == '') {
                        pname = 'No name';
                    }
                    table += '<tr><td colspan=4 title="id: '+ connected_to_info[i]['pid'] +'">'
                        + connected_to_info[i]['ptype'] + ' - ' + pname + '</td></tr>';
                    for (j=0; j<connected_to_info[i]['ct_list'].length; j++) {
                        aname = connected_to_info[i]['ct_list'][j]['aname'];
                        if (aname == '') {
                            aname = 'No name';
                        }
                        table += '<tr>';
                        // remove_connection(from_asset_id, from_port_id, to_asset_id, to_port_id)
                        let from_asset_id = asset_id;
                        let from_port_id = connected_to_info[i]['pid'];
                        let to_asset_id = connected_to_info[i]['ct_list'][j]['aid'];
                        let to_port_id = connected_to_info[i]['ct_list'][j]['pid'];
                        table += '<td><button onclick="remove_connection(\'' + from_asset_id + '\',\'' + from_port_id + '\',\'' + to_asset_id + '\',\'' + to_port_id + '\'); sidebar.hide();">Del</button></td>';
                        table += '<td>&nbsp;</td><td title="port id:' + connected_to_info[i]['ct_list'][j]['pid'] + '">'
                            + connected_to_info[i]['ct_list'][j]['atype'] + ' - '
                            + aname + '</td>';
                        table += '</tr>';
                    }
                }
                table += '</table>';
                sidebar_ctr.innerHTML = sidebar_ctr.innerHTML + table;

                // add date picker to date input fields
                $( ":input[edate*='true']" ).datepicker({
                    showOn: "button",
                    dateFormat: "yy-mm-dd",
                    showAnim: "slideDown",
                    changeYear: true,
                    yearRange: "1980:2060",
                    changeMonth: true
                    });
                // let tooltips support html styling
                $('td[title]').tooltip({
                    content: function() {
                        return $(this).attr('title');
                    }
                });
                sidebar.show();
            });

			socket.on('conductor_info', function(asset_info) {
				// console.log('Conductor info: ')
				// console.log(asset_info);
				asset_id = asset_info['id'];
                asset_name = asset_info['name'];
				latlng = asset_info['latlng']; // location of popup send in messagage
                asset_attrs = asset_info['attrs'];

				length = 0;
				for (i=0; i<asset_attrs.length; i++) {
					if (asset_attrs[i][0]=='length') {
						length=asset_attrs[i][1];
					}
				}

				var popup = L.popup().setLatLng(latlng)
						.setContent('<p><b>'+asset_name+'</b><br>Length: '+length+'m<br>id: '+asset_id+'</p>')
						.openOn(map);

			});

            socket.on('port_profile_info', function(port_profile_info) {
                port_profile_info_window(port_profile_info);
            });

            socket.on('es_title', function(title) {
                title_div = document.getElementById('es_title');
                // title_div.innerHTML = '<h1>' + title + '</h1>';
                title_div.innerHTML = '<b>' + title + '<b>';
            });

            socket.on('alert', function(message) {
                hide_loader();      // when backend sends error message, stop displaying loader
                alert(message);
            });

            socket.on('area_boundary', function(area_boundary) {
                geometry = area_boundary['boundary'];
                color = area_boundary['color'];
                fillcolor = area_boundary['fillcolor'];
                info_type = area_boundary['info-type'];
                name = area_boundary['name'];
                boundary_type = area_boundary['boundary_type'];
                crs = area_boundary['crs'];
                // console.log(color)

                if (info_type == 'MP-RD') {
                    // console.log('received MP-RD')
                    var RD = new L.Proj.CRS( 'EPSG:28992','+proj=sterea +lat_0=52.15616055555555 +lon_0=5.38763888888889 +k=0.9999079 +x_0=155000 +y_0=463000 +ellps=bessel +units=m +towgs84=565.2369,50.0087,465.658,-0.406857330322398,0.350732676542563,-1.8703473836068,4.0812 +no_defs', {
                        resolutions: [3440.640, 1720.320, 860.160, 430.080, 215.040, 107.520, 53.760, 26.880, 13.440, 6.720, 3.360, 1.680, 0.840, 0.420, 0.210],
                        bounds: L.bounds([-285401.92, 22598.08], [595401.9199999999, 903401.9199999999]),
                        origin: [-285401.92, 22598.08]
                    });

                    var mp = geometry['coordinates'];
                    // console.log(mp.length);
                    for (i=0; i<mp.length; i++) {
                        polygon = mp[i];

                        var areaBoundary = {
                            type: "Feature",
                            geometry: {
                                type: "Polygon",
                                coordinates: polygon
                            },
                            crs: {
                                type: "name",
                                properties: {
                                    name: "EPSG:28992"
                                }
                            }
                        };
                        // L.Proj.geoJson(areaBoundary).addTo(map);
                        L.Proj.geoJson(areaBoundary, {color: color, fillcolor: fillcolor, weight: 1}).addTo(area_layer);
                    }
                }

                // assume coordinates are in CRS WGS84 (Lat/Lon); default for ESDL
                if (info_type == 'P-WGS84') {
                    // console.log('received P-WGS84')
                    var polygon = geometry['coordinates'];
                    // console.log(polygon);
                    var areaBoundary = {
                        type: "Feature",
                        geometry: {
                            type: "Polygon",
                            coordinates: polygon
                        }
                    };
                    // console.log(areaBoundary);
                    if (boundary_type == 'building') {
                        L.geoJson(areaBoundary, {
                            color: color, fillcolor: fillcolor, weight: 1, name: name
                        }).bindPopup(function (layer) {
                            return 'name:'+layer.options.name}).addTo(bld_layer);
                    } else {
                        L.geoJson(areaBoundary, {
                            color: color, fillcolor: fillcolor, weight: 1, name: name
                        }).bindPopup(function (layer) {
                            return 'name:'+layer.options.name}).addTo(area_layer);
                    }
                }

                // coordinates are in CRS WGS84 (Lat/Lon)
                if (info_type == 'MP-WGS84') {
                    // console.log('received MP-WGS84')
                    var mp = geometry['coordinates'];
                    // console.log(mp);

                    for (i=0; i<mp.length; i++) {
                        polygon = mp[i];

                        var areaBoundary = {
                            type: "Feature",
                            geometry: {
                                type: "Polygon",
                                coordinates: polygon
                            }
                        };
                        // console.log(areaBoundary);
                        L.geoJson(areaBoundary, {color: color, fillcolor: fillcolor, weight: 1}).addTo(area_layer);
                    }
                }

                if (info_type == 'WKT') {
                    console.log(geometry);
                    if (crs == 'EPSG:28992') {
                        geometry = wkt_rd2wgs(geometry);
                    }
                    layer = omnivore.wkt.parse(geometry);
                    layer.setStyle({color: color, weight: 2, name: name});
                    layer.bindPopup(function (layer) {
                            return 'name:'+layer.options.name});
                    layer.addTo(area_layer);
                }
            });

            socket.on('pot_boundary', function(pot_boundary) {
                geometry = pot_boundary['boundary'];
                info_type = pot_boundary['info-type'];
                name = pot_boundary['name'];
                color = pot_boundary['color'];
                crs = pot_boundary['crs'];

                if (info_type == 'WKT') {
                    console.log(geometry);
                    if (crs == 'EPSG:28992') {
                        geometry = wkt_rd2wgs(geometry);
                    }
                    layer = omnivore.wkt.parse(geometry);
                    layer.setStyle({color: color, weight: 2, name: name});
                    layer.bindPopup(function (layer) {
                            return 'name:'+layer.options.name});
                    layer.addTo(pot_layer);
                }
            });

            socket.on('profile_info', function(pa) {
                profile_array = pa;
            });

            socket.on('qau_information', function(qau_info) {
                quantity_and_units_info = qau_info;
            });

            socket.on('control_strategy_config', function(csc) {
                control_strategy_config = csc
            });

            socket.on('storage_strategy_window', function(params) {
                var asset_id = params['asset_id'];
                var mcc = params['mcc'];
                var mdc = params['mdc'];

                storage_strategy_window(asset_id, mcc, mdc)
            });

            socket.on('marginal_costs', function(params) {
                var mc = params['mc'];
                var asset_id = params['asset_id'];

                marginal_costs_window(asset_id, mc)
            });

            socket.on('carrier_list', function(carr_list) {
                update_carrier_list(carr_list['carrier_list']);
            });

            socket.on('sector_list', function(list) {
                set_sector_list(list['sector_list']);
            });

            socket.on('esdl_services', function(list) {
                set_esdl_services_information(list);
            });

            socket.on('wms_layer_list', function(wms_layer_lst) {
                wms_layer_list = wms_layer_lst;
                // console.log(wms_layer_list);

                for (var key in wms_layer_list) {
                    var layer_info = wms_layer_list[key];

                    layer_info.layer_ref = L.tileLayer.wms(layer_info.url, {
                        layers: layer_info.layer_name,
                        format:'image/png',
                        transparent: true
                    });
                    if (layer_info.visible) {
                        layer_info.layer_ref.addTo(map);
                        layer_info.layer_ref.bringToFront();
                    }
                }
            });

            socket.on('and_now_press_download_file', function() {
                $("#download-esdl").click();
            });
{% if 'essim' in role %}
            socket.on('show_simulation_progress_window', function() {
                show_simulation_progress_window();
            });

            socket.on('results_validation_for_ESSIM', function(results) {
                show_validate_for_ESSIM_window(results);
            });

            socket.on('show_ESSIM_KPIs', function(results) {
                hide_loader();
                show_ESSIM_KPIs(results);
            });
{% endif %}
            socket.on('show_es_info', function(es_attrs) {
                // console.log('show es info received');
                // console.log(es_attrs);
                show_es_info(es_attrs);
            });

            // populate the asset menu grouped by capability
            socket.on('capability_list', function(capabilities) {
                $('#asset_menu').empty();
                for (let key in capabilities) {
                    //console.log(key + ' --> ' + capabilities[key])
                    var optgroup = $('<optgroup>');
                    optgroup.attr('label', key);
                    optgroup.style = 'font-face: bold; font-size: 10px'
                    for (let i in capabilities[key]) {
                         let option = $("<option></option>");
                         option.val(capabilities[key][i]);
                         option.text(capabilities[key][i]);
                         optgroup.append(option)
                         // generate icons for markers that do not have an static image png
                         if (!assets_for_icons.includes(capabilities[key][i])){
                            //console.log("Generating marker for" + capabilities[key][i] + ", abbr = " + getAbbrevation(capabilities[key][i]));
                            genIconDataURL = drawTextImage(getAbbrevation(capabilities[key][i]));
                            window[capabilities[key][i] +'Marker'] = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12),
                                iconSize: new L.Point(30, 30), iconUrl: genIconDataURL}});
                         }
                    }
                    $("#asset_menu").append(optgroup);
                }
                $("#asset_menu").attr("size", "15");
                $("#asset_menu-menu").css({'max-height': '600px' });
                $("#asset_menu").selectmenu("refresh");

                //$( "#asset_menu" ).addClass( "overflow" );
            });

            socket.on('place_edr_asset', function(asset_type) {
                $('#asset_menu').val(asset_type);
                $("#asset_menu").selectmenu("refresh");
                socket.emit('command', {'cmd': 'set_asset_drawing_mode', 'mode': 'edr_assets'});
                initiate_draw_asset();
            });

            addGeoJSONListener(socket, map);
        });
    </script>


    <script>

        function initiate_draw_asset() {
            var select_box = document.getElementById('asset_menu');
            var selected_asset = select_box.options[select_box.selectedIndex].value;
            var marker_class_name = window[selected_asset + "Marker"];

            drawControl.setDrawingOptions({
                marker: {
                    icon: new marker_class_name()
                }
            });

            var line_assets = ["ElectricityCable", "Pipe"];
            var area_assets = ["PVParc", "WindParc"];
            if (line_assets.includes(selected_asset)) {
                drawControl._toolbars.draw._modes.polyline.handler.enable();
            } else if (area_assets.includes(selected_asset)) {
                socket.emit('command', {'cmd': 'set_area_drawing_mode', 'mode': 'asset_with_polygon'});
                drawControl._toolbars.draw._modes.polygon.handler.enable();
            } else {
                drawControl._toolbars.draw._modes.marker.handler.enable();
            }
        }

        $(function() {
            $("#asset_menu").selectmenu({ 'width':200, 'max-height': 500 }); //.selectmenu( "menuWidget" ).addClass( "overflow" );
            $("#line_select").selectmenu({ width:200 });
            $("#area_bld_select").selectmenu({ width:500 });
            $("#carrier_select").selectmenu({ width:150 });
            $("#profile_menu").selectmenu({ width:150 });
            $('#boundary-info').button({text: false, icons: {primary: "geometry"}});
            $('#layer-info').button({text: false, icons: {primary: "layers"}});
            $('#import-esdl').button({text: false, icons: {primary: "import"}});

            // changes the icon for the new marker command
            $('#asset_menu').on('selectmenuchange', function (e) {
                socket.emit('command', {'cmd': 'set_asset_drawing_mode', 'mode': 'empty_assets'});
                initiate_draw_asset();
            });

{% if not 'essim' in role %}
            $("#valESSIM").button({disabled: true});
            $("#ESSIM").button({disabled: true});
            $("#ESSIMkpis").button({disabled: true});
            $("#ESSIM_load_animation").button({disabled: true});
{% endif %}

        });

        $(function() {
            $(document).tooltip();
        });
    </script>

    <style>
    /*
    jQuery UI styles
    */
    .ui-widget { font-family: Trebuchet MS, Tahoma, Verdana, Arial, sans-serif; font-size: 11px; }
    .ui-button .ui-icon.graph {
        background-image: url({{dir_settings.resource_prefix}}icons/Graph.png);
        width: 16;
        height: 16;
    }
    .ui-button .ui-icon.geometry{
        background-image: url({{dir_settings.resource_prefix}}icons/AreaGeometry.png);
        width: 25;
        height: 25;
    }
    .ui-button .ui-icon.layers{
        background-image: url({{dir_settings.resource_prefix}}icons/Layers.png);
        width: 25;
        height: 25;
    }
    .ui-button .ui-icon.import{
        background-image: url({{dir_settings.resource_prefix}}icons/Import.png);
        width: 25;
        height: 25;
    }
    </style>


</head>
<body class="flexbox-parent">
    <div class="flexbox-item">
        <div class="header" style="height: 25px">
            <div style="float: left; padding:2px;"><img src="{{dir_settings.resource_prefix}}favicon.ico" height="20"></div>
            <div style="float: left; padding:2px;"><b>ESDL Map Editor:</b></div>
            <div style="float: left; padding:2px;" id="es_title"></div>
        </div>

        <div id="ctrl" style="clear: left; position: relative; padding:3px;">
            <button id="new-esdl" onclick="new_ESDL();" title="New energysystem" class="ui-button ui-widget ui-corner-all ui-button-icon-only"><span class="ui-icon ui-icon-document"></span>New</button>
            <button onclick="document.querySelector('.inputFile').click();" title="Load ESDL File" class="ui-button ui-widget ui-corner-all ui-button-icon-only"><span class="ui-icon ui-icon-folder-open"></span>Open</button>
            <input class="inputFile" type="file" style="display: none;" onchange="open_ESDL(event);">
            <button id="import-esdl" onclick="document.querySelector('.inputImportFile').click();" title="Import ESDL File" class="ui-button ui-widget ui-corner-all ui-button-icon-only">Import</button>
            <input class="inputImportFile" type="file" style="display: none;" onchange="import_ESDL(event);">

            <button id="save-esdl" onclick="save_ESDL(this);" title="Save ESDL to file" class="ui-button ui-widget ui-corner-all ui-button-icon-only"><span class="ui-icon ui-icon-disk"></span>Save</button>
            <button id="load-esdl" onclick="send_cmd_load_ESDL();" title="Load from ESDL store" class="ui-button ui-widget ui-corner-all"><span class="ui-icon ui-icon-folder-open"></span>Store</button>
            <button id="es-info" onclick="get_es_info();" title="Generic energy system information" class="ui-button ui-widget ui-corner-all ui-button-icon-only"><span class="ui-icon ui-icon-info"></span>Info</button>
            <button id="EC" onclick="energy_carrier_info();" title="Energy carriers and commodities" class="ui-button ui-widget ui-corner-all">ECs</button>
            <button id="sector-btn" onclick="sector_info();" title="Sectors" class="ui-button ui-widget ui-corner-all">S</button>
            <!--button id="store-esdl" onclick="send_cmd_store_ESDL();" title="Save to ESDL Store" class="ui-button ui-widget ui-corner-all"><span class="ui-icon ui-icon-disk"></span>Store</button-->
            <button id="boundary-info" onclick="boundary_info_window();" title="Get boundary information for region (and subregions)" class="ui-button ui-widget ui-corner-all ui-button-icon-only">Boundary</button>

            <button id="edr-asset-btn" onclick="select_edr_asset_window();" title="EDR assets" class="ui-button ui-widget ui-corner-all">EDR assets</button>
            <select id="asset_menu" style='position:relative;z-index:100'>
                <option value="Battery">Battery</option>
                <option value="CHP">Combined Heat and Power</option>
                <option value="EConnection">EConnection</option>
                <option value="ElectricityDemand">ElectricityDemand</option>
                <option value="ElectricityNetwork">ElectricityNetwork</option>
                <option value="Electrolyzer">Electrolyzer</option>
                <option value="FuelCell">FuelCell</option>
                <option value="GConnection">GConnection</option>
                <option value="GasHeater">GasHeater</option>
                <option value="GasNetwork">GasNetwork</option>
                <option value="GenericConsumer">GenericConsumer</option>
                <option value="GenericConversion">GenericConversion</option>
                <option value="GenericProducer">GenericProducer</option>
                <option value="GeothermalSource">GeothermalSource</option>
                <option value="HeatingDemand">HeatingDemand</option>
                <option value="HeatNetwork">HeatNetwork</option>
                <option value="HeatPump">HeatPump</option>
                <option value="Joint">Joint</option>
                <option value="MobilityDemand">MobilityDemand</option>
                <option value="PowerPlant">PowerPlant</option>
                <option value="PVInstallation">PVInstallation</option>
                <option value="PVParc">PVParc</option>
                <option value="Transformer">Transformer</option>
                <option value="UTES">UTES</option>
                <option value="WindTurbine">WindTurbine</option>
                <!-- option value="ResidualHeatSourcePotential">ResidualHeatSourcePotential</option-->
            </select>

            <select id="line_select">
                <option value="ElectricityCable">ElectricityCable</option>
                <option value="Pipe">Pipe</option>
            </select>

            <select id="area_bld_select"></select>
            <!-- <select id="carrier_select"></select> -->

            <button id="esdl_services" onclick="esdl_services_info();" title="ESDL Services" class="ui-button ui-widget ui-corner-all">ESDL Services</button>
            <button id="layer-info" onclick="show_layers();" title="Show layers" class="ui-button ui-widget ui-corner-all"><span class="ui-button ui-widget ui-corner-all ui-button-icon-only"></span>Layers</button>
            <!-- <button id="button_shapefile" onclick="show_add_shapefile();" title="Add a shapefile" class="ui-button ui-widget ui-corner-all">SHP</button> -->

{% if 'essim' in role %}
            <button id="valESSIM" onclick="validate_for_ESSIM();" title="Validate before ESSIM simulation" class="ui-button ui-widget ui-corner-all"><span class="ui-icon ui-icon-check"></span>Validate</button>
            <button id="ESSIM" onclick="run_ESSIM_simulation();" title="Run an ESSIM simulation" class="ui-button ui-widget ui-corner-all"><span class="ui-icon ui-icon-circle-triangle-e"></span>Simulate</button>
            <button id="ESSIMkpis" onclick="calculate_ESSIM_KPIs();" title="KPIs" class="ui-button ui-widget ui-corner-all">K</button>
            <button id="ESSIM_load_animation" onclick="animate_ESSIM_load();" title="Animate load" class="ui-button ui-widget ui-corner-all"><span class="ui-icon ui-icon-video"></span></button>
{% endif %}

            <a href="/logout"><button id="logout" class="ui-button ui-widget ui-corner-all">Logout</button></a>
        </div>
    </div>
    <!--div id="mapid" style="float: left; width: 100%; height: 100%; position:relative; z-index:10"></div-->
    <div id="mapid" class="flexbox-item flexbox-item-grow" style="z-index:10"></div>

    <div id="sidebar"></div>
    <div id="loader"></div>
</body>
</html>

<script>

    var osmUrl = location.protocol + '//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            osmAttrib = '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            osm = L.tileLayer(osmUrl, { maxZoom: 19, attribution: osmAttrib });

    var map = new L.Map('mapid', {
        center: new L.LatLng(52.1, 5.8),
        zoom: 8,
        timeDimensionControl: true,
        timeDimensionControlOptions: {
            loopButton: true,
        },
        timeDimension: true,
        timeDimensionOptions: {
            timeInterval: "2015-01-01T00:00:00Z/2016-01-01T00:00:00Z",
            period: "PT1H"
        }
    });

    var esdl_layer = L.featureGroup().addTo(map),
            area_layer = L.featureGroup().addTo(map),
            bld_layer = L.featureGroup().addTo(map),
            pot_layer = L.featureGroup().addTo(map),
            connection_layer = L.featureGroup().addTo(map),
            sim_layer = L.featureGroup().addTo(map);

    connection_layer.bringToFront();

    // var geo = L.geoJson({features:[]},{onEachFeature:function popUp(f,l){
    // 		var out = [];
    // 		if (f.properties){
    //    		for(var key in f.properties){
    //        	out.push(key+": "+f.properties[key]);
    //        }
    //        l.bindPopup(out.join("<br />"));
    //    }
    // }}).addTo(map);

	// shp('http://localhost:8111/prov.zip').then(function(data){
	//    geo.addData(data);
	// }, function(a){
	//    console.log(a)
	// });

    L.control.layers(
        {
            'OpenStreetMap': osm.addTo(map),
            "Google": L.tileLayer('http://www.google.cn/maps/vt?lyrs=s@189&gl=cn&x={x}&y={y}&z={z}', {
                attribution: 'Google'
            })
        },
        {
            'Assets': esdl_layer,
            'Area boundaries': area_layer,
            'Building boundaries': bld_layer,
            'Potential boundaries': pot_layer,
            'Connections': connection_layer,
            'Simulation results': sim_layer
        },
        //, 'wms': wms_layer, 'wms2': wms_layer2 },
        { position: 'topleft', collapsed: false }
    ).addTo(map);

    // List of assets that have a dedicated icon. For others they are generated based on capital letters in the name.
    var assets_for_icons = ["Battery", "Bus", "CHP", "EConnection", "ElectricityCable", "ElectricityDemand", "ElectricityNetwork", "Electrolyzer", "FermentationPlant",
        "FuelCell", "GConnection", "GasHeater", "GasNetwork", "GasStorage", "GConnection", "GenericConsumer", "GenericConversion", "GenericProducer", "GenericTransport",
        "GeothermalSource", "HConnection", "HeatingDemand", "HeatNetwork", "HeatPump", "HeatStorage", "Joint", "MobilityDemand", "PowerPlant",
        "PVInstallation", "PVPanel", "PVParc", "ResidualHeatSourcePotential", "SinkConsumer", "SourceProducer", "Transformer",
        "UTES", "WindTurbine"];

    // rest of the markers are generated when the capabilities are send to the browser
    for (var i=0; i < assets_for_icons.length; i++) {
        var ass_name = assets_for_icons[i];
        window[ass_name+'Marker'] = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12),
            iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/' + ass_name +'.png'}});
    }

    var drawControl = new L.Control.Draw({
        edit: {
            featureGroup: esdl_layer,
            poly: {
                allowIntersection: true
            }
        },
        draw: {
            polygon: {
                allowIntersection: true,
                showArea: true
            },
            circle: false,
            polyline: {
                repeatMode: true
            },
            marker: {
                icon: new WindTurbineMarker(),
                repeatMode: true
            }
        }
    })
    map.addControl(drawControl);

    sidebar = L.control.sidebar('sidebar', {
        position: 'right',
        closeButton: true
    });
    map.addControl(sidebar);

    // the 'dragend' event of Polyline does not work, this is an alternative solution
    map.on('draw:edited', function (e) {
        var layers = e.layers;
        layers.eachLayer(function (layer) {
            if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)) {
                polyline_length = calculate_length(layer);
                socket.emit('update-line-coord', {id: layer.id, polyline: layer.getLatLngs(), length: polyline_length});
            }
            if (layer instanceof L.Polygon) {

                // Find marker belonging to Polygon and recalculate center
                esdl_objects = esdl_layer.getLayers();
                for (let i=0; i<esdl_objects.length; i++) {
                    esdl_object = esdl_objects[i];
                    if (esdl_object.id == layer.id && esdl_object instanceof L.Marker) {
                        polygon_center = calculate_leaflet_polygon_center(layer.getLatLngs()[0]);
                        var newLatLng = new L.LatLng(polygon_center[0], polygon_center[1]);
                        esdl_object.setLatLng(newLatLng);

                        // send updated coordinates to backend to update port_to_asset_mapping and update connections
                        socket.emit('update-coord', {id: layer.id, lat: polygon_center[0], lng: polygon_center[1], asspot: layer.asspot});
                    }
                }

                // recalculate area
                polygon_area = calculate_area(layer);
                socket.emit('update-polygon-coord', {id: layer.id, polygon: layer.getLatLngs(), polygon_area: polygon_area});
            }
        });
    });

    // To prevent the onclick functionality when removing objects
	map.on(L.Draw.Event.DELETESTART, function (event) {
        deleting_objects = true;
	});

	map.on(L.Draw.Event.DELETESTOP, function (event) {
        deleting_objects = false;
	});

    // To prevent the onclick functionality when editing objects
	map.on(L.Draw.Event.EDITSTART, function (event) {
        editing_objects = true;
	});

	map.on(L.Draw.Event.EDITSTOP, function (event) {
        editing_objects = false;
	});

    map.on('contextmenu.select', function(e) {
        // this event is fired for all contextmenu clicks
        // TODO: how to filter add profile in a better way???
        menu_item_text = e.el.innerText;
        // console.log(e);

//        if (menu_item_text.substring(0, 11) == 'Set profile') {
//            port_id = menu_item_text.substring(menu_item_text.indexOf('(')+1, menu_item_text.indexOf(')'));
//            // console.log(port_id);
//            socket.emit('command', {'cmd': 'get_port_profile_info', 'port_id': port_id});
//        }

//        if (menu_item_text.substring(0, 8) ==  'Connect ') {
//            port_id = menu_item_text.substring(menu_item_text.indexOf('(')+1, menu_item_text.indexOf(')'));
//            // console.log('In contextmenu select eventhandler:');
//            // console.log(port_id);
//            if (connect_ports != null) {
//                socket.emit('command', {'cmd': 'connect_ports', port1id: connect_ports, port2id: port_id});
//                connect_ports = null;
//            } else {
//                connect_ports = port_id;
//            }
//        }

//        if (menu_item_text.substring(0, 10) ==  'Set Driven') {
//            port_id = menu_item_text.substring(menu_item_text.indexOf('(')+1, menu_item_text.indexOf(')'));
//            asset_id = menu_item_text.substring(menu_item_text.indexOf('[')+1, menu_item_text.indexOf(']'));
//
//            if (menu_item_text.substring(4, 14) ==  'DrivenByDemand') {
//                set_driven_by_demand(asset_id, port_id);
//            }
//            if (menu_item_text.substring(4, 14) ==  'DrivenBySupply') {
//                set_driven_by_supply(asset_id, port_id);
//            }
//        }

        if (menu_item_text.substring(0, 11) ==  'Set Storage') {
            asset_id = menu_item_text.substring(menu_item_text.indexOf('[')+1, menu_item_text.indexOf(']'));
            socket.emit('command', {'cmd': 'get_storage_strategy_info', 'asset_id': asset_id});
        }
    });

    map.on(L.Draw.Event.CREATED, function (event) {
        let layer = event.layer;
        let type = event.layerType;
        layer.id = uuidv4();

        selected_area_bld_index = document.getElementById("area_bld_select").selectedIndex;
        selected_area_bld_options = document.getElementById("area_bld_select").options;
        selected_area_bld_id = selected_area_bld_options[selected_area_bld_index].value;
        // console.log('selected area/building id: ' + selected_area_bld_id);

        if (type === 'marker') {
            selection = document.getElementById("asset_menu").selectedIndex;
            asset_options = document.getElementById("asset_menu").options;
            selected_asset = asset_options[selection].value;
            // console.log('selected option: ' + selection);
            // console.log('selected asset: ' + selected_asset);

            layer.name = selected_asset + '_' + layer.id.substring(0,4);
            socket.emit('command', {cmd: 'add_asset', area_bld_id: selected_area_bld_id, asset: selected_asset, asset_name: layer.name, asset_id: layer.id, lat: layer.getLatLng().lat, lng: layer.getLatLng().lng});
        }
        if (type === 'polyline') {
            line_type = document.getElementById("line_select").value;
            //console.log('selected line type: ' + line_type);
            layer.type = line_type;
            layer.name = line_type + '_' + layer.id.substring(0,4);
            layer.title = layer.name;
            polyline_length = calculate_length(layer);
            socket.emit('command', {cmd: 'add_asset', area_bld_id: selected_area_bld_id, asset: line_type, asset_name: layer.name, asset_id: layer.id, polyline: layer.getLatLngs(), length: polyline_length});
        }
        if (type === 'polygon' || type === 'rectangle') {
            // TODO: What to do with drawing polygon for an ESDL Area (e.g. a 'bedrijventerrein')
            // socket.emit('command', {cmd: 'set_area_bld_polygon', area_bld_id: selected_area_bld_id, polygon: layer.getLatLngs()});
            // area_layer.addLayer(layer, true);

            selection = document.getElementById("asset_menu").selectedIndex;
            asset_options = document.getElementById("asset_menu").options;
            selected_asset = asset_options[selection].value;
            // console.log('selected option: ' + selection);
            // console.log('selected asset: ' + selected_asset);

            layer.name = selected_asset + '_' + layer.id.substring(0,4);
            polygon_area = calculate_area(layer);
            socket.emit('command', {cmd: 'add_asset', area_bld_id: selected_area_bld_id, asset: selected_asset, asset_name: layer.name, asset_id: layer.id, polygon: layer.getLatLngs(), polygon_area: polygon_area});
        }
    });

    map.on('click', function(e) {
        map.contextmenu.hide();
    });


</script>
