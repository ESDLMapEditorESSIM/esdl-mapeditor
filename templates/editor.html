<!--
  This work is based on original code developed and copyrighted by TNO 2020.
  Subsequent contributions are licensed to you by the developers of such code and are
  made available to the Project under one or several contributor license agreements.

  This work is licensed to you under the Apache License, Version 2.0.
  You may obtain a copy of the license at

      http://www.apache.org/licenses/LICENSE-2.0

  Contributors:
      TNO         - Initial implementation
  Manager:
      TNO
  -->

<!DOCTYPE HTML>
<html>
<head>
    <title>ESDL Map Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="./vendor/use.fontawesome.com/releases/v5.13.0/css/all.css">
    <link rel="stylesheet" href="./vendor/use.fontawesome.com/releases/v5.13.0/css/v4-shims.css">

    <link rel="shortcut icon" href="./favicon.ico" />
    <link rel="stylesheet" href="./vendor/unpkg.com/leaflet@1.6.0/dist/leaflet.css" crossorigin="" type="text/css"/>
    <script type="text/javascript" src="./vendor/unpkg.com/leaflet@1.6.0/dist/leaflet.js" crossorigin=""></script>
    <!--link rel="stylesheet" href="./plugins/leaflet.css" crossorigin=""/-->
    <!--script src="./plugins/leaflet.js" crossorigin=""></script-->

    <script type="text/javascript" src="./vendor/cdnjs.cloudflare.com/ajax/libs/lodash.js/3.5.0/lodash.min.js" crossorigin=""></script>

<!--    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" type="text/css"/>-->
<!--    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>-->
    <link rel="stylesheet" href="./plugins/leaflet.draw.css" />
    <script src="./plugins/leaflet.draw-custom.js"></script>
    <script src="./utils/draw_state.js"></script>

    <link rel="stylesheet" href="./vendor/cdn.jsdelivr.net/npm/leaflet-toolbar@0.4.0-alpha.2/dist/leaflet.toolbar.css" type="text/css"/>
    <script src="./vendor/cdn.jsdelivr.net/npm/leaflet-toolbar@0.4.0-alpha.2/dist/leaflet.toolbar.min.js"></script>

    <script type="text/javascript" src="./vendor/cdnjs.cloudflare.com/ajax/libs/leaflet-polylinedecorator/1.1.0/leaflet.polylineDecorator.min.js"></script>

    <link rel="stylesheet" href="./plugins/L.Control.Sidebar.css" type="text/css"/>
    <script type="text/javascript" src="./plugins/L.Control.Sidebar.js"></script>
    <link rel="stylesheet" href="./plugins/L.Control.Sidebar-b.css" type="text/css"/>
    <script type="text/javascript" src="./plugins/L.Control.Sidebar-b.js"></script>

    <link rel="stylesheet" href="./plugins/L.Control.MousePosition.css" type="text/css"/>
    <script type="text/javascript" src="./plugins/L.Control.MousePosition.js"></script>

    <link rel="stylesheet" href="./vendor/jjimenezshaw/L.Control.Layers.Tree.css" type="text/css"/>
    <script type="text/javascript" src="./vendor/jjimenezshaw/L.Control.Layers.Tree.js"></script>

    <!-- downloaded from https://github.com/kartena/Proj4Leaflet -->
    <script type="text/javascript" src="./plugins/proj4.js"></script>
    <!--script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.5.0/proj4.js"></script-->
    <script type="text/javascript" src="./plugins/proj4leaflet.js"></script>

    <!--script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.slim.js"></script-->
    <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.4/socket.io.min.js"></script> -->
    <script type="text/javascript" src="./vendor/cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.min.js"></script>

    <link rel="stylesheet" href="./vendor/code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" type="text/css">
    <script type="text/javascript" src="./vendor/code.jquery.com/jquery-1.12.4.js"></script>
<!--    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>-->
    <script src="./vendor/makinacorpus/leaflet.textpath.js" type="text/javascript"></script>

    <link href="./vendor/stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

    <!-- SmartMenus jQuery Bootstrap 4 Addon CSS -->
    <link href="./vendor/smartmenus/addons/bootstrap-4/jquery.smartmenus.bootstrap-4.css" rel="stylesheet">

    <script src="./vendor/cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="./vendor/maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" crossorigin="anonymous"></script>

    <!-- SmartMenus jQuery plugin -->
    <script type="text/javascript" src="./vendor/smartmenus/jquery.smartmenus.js"></script>
    <!-- SmartMenus jQuery Bootstrap 4 Addon -->
    <script type="text/javascript" src="./vendor/smartmenus/addons/bootstrap-4/jquery.smartmenus.bootstrap-4.js"></script>

    <!-- Edwin: Load JQuery-ui after bootstrap to prevent errors with tooltip -->
    <script type="text/javascript" src="./vendor/code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <link rel="stylesheet" href="./vendor/cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
    <script src="./vendor/cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>

    <!--script type="text/javascript" src="./plugins/socket.io.min.js"></script-->
    <!--script type="text/javascript" src="./plugins/jquery-1.4.2.min.js"></script-->

    <link href="./plugins/leaflet.contextmenu.css" rel="stylesheet" type="text/css" />
    <script src="./plugins/leaflet.contextmenu.js" type="text/javascript"></script>

    <link href="./plugins/Leaflet.Dialog.css" rel="stylesheet" type="text/css" />
    <script src="./plugins/Leaflet.Dialog.js" type="text/javascript"></script>
    <link rel="stylesheet" href="./plugins/pure-table.css" type="text/css"/>

    <script type="text/javascript" src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>

    <!-- <script type="text/javascript" src="https://unpkg.com/jsts@1.6.1/dist/jsts.min.js"></script> -->
    <script src='https://unpkg.com/@turf/turf@6.3.0/turf.min.js'></script>
{% if 'table-do-not-include-this' in role %}
    <link href="./plugins/multi-dropdown-with-search.css" rel="stylesheet" type="text/css" />
    <script src="./plugins/multi-dropdown-with-search.js" type="text/javascript"></script>
{% endif %}

    <link href="./plugins/DonutCharts.css" rel="stylesheet" type="text/css" />
    <script src="./plugins/DonutCharts.js" type="text/javascript"></script>

    <!-- <script src='https://unpkg.com/shpjs@latest/dist/shp.js'></script> -->
    <script type="text/javascript" src="./plugins/shp.js"></script>
    <script type="text/javascript" src="./plugins/rainbowvis.js"></script>
    <script type="text/javascript" src="./plugins/html-escaper.js"></script>

    <script type="text/javascript" src="./utils/shape_util.js"></script>
    <script type="text/javascript" src="./utils/multi_esdl.js"></script>
    <script type="text/javascript" src="./utils/utils.js"></script>
    <script type="text/javascript" src="./utils/heatnetwork.js"></script>
    <script type="text/javascript" src="./utils/area_building_layer.js"></script>
    <script type="text/javascript" src="./utils/sectors.js"></script>
    <script type="text/javascript" src="./utils/carriers.js"></script>
    <script type="text/javascript" src="./utils/profiles.js"></script>
    <script type="text/javascript" src="./utils/asset_from_edr.js"></script>
    <script type="text/javascript" src="./utils/esdl_services.js"></script>
    <script type="text/javascript" src="./utils/wkt_rd2wgs.js"></script>
    <script type="text/javascript" src="./utils/esdl_store.js"></script>
    <script type="text/javascript" src="./utils/esdl_compare.js"></script>
    <script type="text/javascript" src="./utils/esdl_merge.js"></script>
    <script type="text/javascript" src="./utils/esdl_browser.js"></script>
    <script type="text/javascript" src="./utils/esdl_drive.js"></script>
    <script type="text/javascript" src="./utils/check_status.js"></script>
    <link rel="stylesheet" href="./utils/esdl_drive.css" type="text/css"/>

{% if 'table' in role %}
    <script type="text/javascript" src="./utils/es_table_editor.js"></script>
{% endif %}

{% if essim_enabled and 'essim' in role %}
    <script type="text/javascript" src="./utils/essim.js"></script>
    <script type="text/javascript" src="./utils/essim_sensitivity.js"></script>
{% endif %}
    <link href="./css/custom.css" rel="stylesheet" type="text/css" />

    <link rel="stylesheet" href="./vendor/rawgit.com/socib/Leaflet.TimeDimension/master/dist/leaflet.timedimension.control.min.css" type="text/css"/>
    <script type="text/javascript" src="./vendor/rawgit.com/nezasa/iso8601-js-period/master/iso8601.min.js"></script>
    <!-- <script type="text/javascript" src="https://rawgit.com/socib/Leaflet.TimeDimension/master/dist/leaflet.timedimension.src.withlog.js"></script> -->
    <script type="text/javascript" src="./vendor/socib/leaflet.timedimension.src.js"></script>

    <script type="text/javascript" src="./plugins/animate.js"></script>

    <script type="text/javascript" src="./plugins/leaflet.shpfile.js"></script>
    <script type="text/javascript" src="./vendor/cdn.jsdelivr.net/npm/leaflet-easyprint@2.1.9/dist/bundle.min.js"></script>
    <script type="text/javascript" src="./vendor/cdnjs.cloudflare.com/ajax/libs/leaflet-dvf/0.3.1/leaflet-dvf.js"></script>

    <script type="text/javascript" src="./utils/file_command.js"></script>
    <script type="text/javascript" src="./utils/area_map_handler.js"></script>
    <script type="text/javascript" src="./utils/building_map_handler.js"></script>

    <script type="text/javascript" src="./utils/boundary_service.js"></script>
{% if 'ielgas' in role or 'opera' in role %}
    <script type="text/javascript" src="./utils/time_dimension.js"></script>
    <script type="text/javascript" src="./utils/ielgas.js"></script>
{% endif %}

    <script type="text/javascript" src="./utils/wms_layers.js"></script>
    <script type="text/javascript" src="./utils/shapefiles.js"></script>
    <script type="text/javascript" src="./utils/asset_map_utils.js"></script>
    <script type="text/javascript" src="./utils/building_editor.js"></script>
    <script type="text/javascript" src="./utils/esdl_api.js"></script>
    <script type="text/javascript" src="./utils/layer_control.js"></script>

    <link rel="stylesheet" href="./utils/L.Control.KPICharts.css" type="text/css"/>
    <script type="text/javascript" src="./utils/L.Control.KPICharts.js"></script>
    <script type="text/javascript" src="./utils/kpis.js"></script>

    <script src="./vendor/cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <link rel="stylesheet" href="./utils/L.Control.LoadDurationCurve.css" type="text/css"/>
    <script type="text/javascript" src="./utils/L.Control.LoadDurationCurve.js"></script>
    <script type="text/javascript" src="./utils/ldc.js"></script>
{% if essim_enabled and 'essim' in role %}
    <script type="text/javascript" src="./utils/L.Control.ESSIMControl.js"></script>

    <link rel="stylesheet" href="./utils/L.Control.ESSIMKPIs.css" type="text/css"/>
    <script type="text/javascript" src="./utils/L.Control.ESSIMKPIs.js"></script>
    <script type="text/javascript" src="./utils/essim_kpis.js"></script>
{% endif %}
    <script type="text/javascript" src="./utils/vesta.js"></script>
    <script type="text/javascript" src="./utils/es_statistics.js"></script>
    <script type="text/javascript" src="./utils/shapefile_converter.js"></script>
    <script type="text/javascript" src="./utils/port_handlers.js"></script>

    <link rel="stylesheet" href="./css/user_messages.css" type="text/css"/>
    <script type="text/javascript" src="./utils/user_messages.js"></script>

    <script type="text/javascript" src="./utils/profiles_mngmnt.js"></script>
    <script type="text/javascript" src="./utils/etm_local.js"></script>
    <script type="text/javascript" src="./utils/port_profile_viewer.js"></script>
    <script type="text/javascript" src="./utils/esdl_services_mngmnt.js"></script>
    <script type="text/javascript" src="./utils/pico_rooftoppv_potential.js"></script>
    <script type="text/javascript" src="./utils/spatial_operations.js"></script>
    <script type="text/javascript" src="./utils/notes.js"></script>
    <script type="text/javascript" src="./utils/view_modes.js"></script>
    <script type="text/javascript" src="./utils/ui_information.js"></script>
    <script type="text/javascript" src="./utils/select_asset.js"></script>
    <script type="text/javascript" src="./utils/assets.js"></script>
    <script type="text/javascript" src="./utils/asset_draw_toolbar.js"></script>
    <script type="text/javascript" src="./utils/spatial_buffers.js"></script>

    <link rel="stylesheet" href="./vendor/cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta2/css/regular.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script type="text/javascript" src="./utils/MapEditorDialog.js"></script>
    <link rel="stylesheet" href="./utils/MapEditorDialog.css" type="text/css"/>
    <script type="text/javascript" src="./utils/table_editor.js"></script>

    <script type="text/javascript" src="./utils/esdl_file_io.js"></script>
    <script type="text/javascript" src="./utils/custom_icons.js"></script>

    <!-- These should be the last ones -->
    <script type="text/javascript" src="./utils/ui_settings.js"></script>
    <script type="text/javascript" src="./utils/app_settings.js"></script>

    <script type="text/javascript" charset="utf-8">

        var version = "{{ version }}";

        var sidebar;
        var sidebar_b;
        var dialog;
        var kpicharts = null;
        var ldc_control;            // load duration curve
        var ielgas_chart;

        var user_info;              // to store information about the logged in user
        var user_settings;          // to store settings per user for ui behaviour

        var profile_array;
        var quantity_and_units_info;
        var control_strategy_config;
        var wms_layer_list;
        var leaflet_layers = {};
        var cap_pot_list;

        //var connecting_assets = false;
        var first_clicked = false;
        var first_clicked_id;

        var area_before_building_edit;  // to store the active area/building when the building_editor is opened

        var connect_ports;

        var clear_layer = false;        // to indicate if esdl items need to be removed too (or only UI clear)
        var deleting_objects = false;   // to indicate if objects are being deleted (to prevent on click)
        var editing_objects = false;    // to indicate if objects are being edited (to prevent on click)

        var extensions = [];            // list of extensions
        var resource_uri = '';          // make the resource_prefix accessible by extensions

        var services_enabled = {
            'edr': {% if edr_enabled %}true{% else %}false{% endif %},
            'store': {% if store_enabled %}true{% else %}false{% endif %},
            'boundary_service': {% if boundary_service_enabled %}true{% else %}false{% endif %},
            'bag_service': {% if bag_service_enabled %}true{% else %}false{% endif %},
            'ibis_service': {% if ibis_service_enabled %}true{% else %}false{% endif %},
            'statistics_service': {% if statistics_service_enabled %}true{% else %}false{% endif %},
        };

        // globally define the colors of the lines/conductors on the map
        var colors = {};
        colors['ElectricityCable'] = '#ff9090';
        colors['ElectricityCable_hoover'] = '#906060';
        colors['Pipe'] = 'blue';
        colors['Pipe_hoover'] = '#9999ff';

        colors['Consumer'] = 'blue';
        colors['Producer'] = 'green';
        colors['Storage'] = 'red';
        colors['Transport'] = 'yellow';
        colors['Conversion'] = 'purple';
        colors['Potential'] = 'grey';


        // ------------------------------------------------------------------------------------------------------------
        //
        // ------------------------------------------------------------------------------------------------------------
        function update_title(title) {
            title_div = document.getElementById('es_title');
            title_div.innerHTML = '<b>' + title + '<b>';
        }

        function show_loader() {
            document.getElementById("loader").style.display = "block";
        }

        function hide_loader() {
            document.getElementById("loader").style.display = "none";
        }

        function select_area_bld_list(id) {
            var select = document.getElementById('area_bld_select');
            select.value = id;
            $("#area_bld_select").selectmenu("refresh");    // to update the selectmenu based on the selected value
        }

        function get_area_bld_list_selection() {
            var select = document.getElementById('area_bld_select');
            return select.value;
        }

        function edit_building_contents(e, asset_id) {
            console.log('edit building contents for building with ID: '+asset_id);
            area_before_building_edit = get_area_bld_list_selection();
            select_area_bld_list(asset_id);
            socket.emit('command', {cmd: 'building_editor', id: asset_id});
        }

        function set_building_handlers(marker) {
            let asset_id = marker.id
            set_building_contextmenu(marker, asset_id);

            marker.on('dragend', function(e) {
                var marker = e.target;
                var pos = marker.getLatLng();
                update_marker_ports(marker);
                socket.emit('update-coord', {id: marker.id, coordinates: pos, asspot: 'building'});
            });

            // TODO replace this with map.on("draw:deleted") as then undo function works
            // Now it deletes everything even when you press cancel.
            marker.on('remove', function(e) {
                // console.log('remove marker');
                // marker.options.icon.tooltip('destroy');
                $(".ui-tooltip-content").parents('div').remove();

                if (deleting_objects == true) {
                    // Remove polygon that belongs to marker, if one is present
                    if (marker.polygon) {
                       // all_layers = esdl_layer.getLayers();
                       all_layers = get_layers(active_layer_id, 'esdl_layer').getLayers();
                       for (let i=0; i<all_layers.length; i++) {
                            layer = all_layers[i];
                            if (layer.id == asset_id && layer instanceof L.Polygon) {
                                // esdl_layer.removeLayer(layer);
                                remove_object_from_layer(active_layer_id, 'esdl_layer', layer);
                            }
                       }
                    }
                    // don't know yet how to delete connections here... (building)
                    socket.emit('command', {cmd: 'remove_object', id: marker.id, asspot: 'asset'});
                }
            });

            marker.on('click', function(e) {
                var marker = e.target;
                if (!e.originalEvent.shiftKey && !e.originalEvent.ctrlKey && !e.originalEvent.altKey &&
                        !e.originalEvent.metaKey) {
                    if (deleting_objects == false && editing_objects == false) {        // do not execute when removing/editing objects
                        var marker = e.target;
                        var id = marker.id;

                        // socket.emit('command', {cmd: 'get_object_info', id: id, asspot: 'asset'});
                        object_properties_window(id);
                    }
                }
            });
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Marginal costs (used by ESSIM)
        // ------------------------------------------------------------------------------------------------------------
        function set_marginal_costs(asset_id) {
            mc = document.getElementById('marg_costs').value;
            // console.log(mc);
            socket.emit('command', {cmd: 'set_marg_costs', asset_id: asset_id, marg_costs: mc});
        }

        function marginal_costs_window(asset_id, mc) {
            // console.log(typeof(mc));
            // console.log(mc);
            if (mc == null) { mc = ''; }

            sidebar_ctr = sidebar.getContainer();

            sidebar_ctr.innerHTML = '<h1>Set marginal costs:</h1>';

            table = '<table>';
            table = table + '<tr><td width=180>Marginal costs</td>';
            table = table + '<td><input type="text" width="60" id="marg_costs" value="' + mc + '"></td></tr>';
            table += '</table>';
            sidebar_ctr.innerHTML += table;

            sidebar_ctr.innerHTML += '<p><button onclick="sidebar.hide();set_marginal_costs(\''+ asset_id + '\');">Set costs</button></p>';
            sidebar.show();
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Storage strategies (used by ESSIM)
        // ------------------------------------------------------------------------------------------------------------
        function set_driven_by_demand(asset_id, port_id) {
            socket.emit('command', {'cmd': 'set_control_strategy', 'strategy': 'DrivenByDemand', 'asset_id': asset_id, 'port_id': port_id});
        }

        function set_driven_by_supply(asset_id, port_id) {
            socket.emit('command', {'cmd': 'set_control_strategy', 'strategy': 'DrivenBySupply', 'asset_id': asset_id, 'port_id': port_id});
        }

        function set_storage_strategy(asset_id) {
            mcc = document.getElementById('marg_ch_costs').value;
            mdc = document.getElementById('marg_disch_costs').value;
            socket.emit('command', {cmd: 'set_control_strategy', asset_id: asset_id, strategy: 'StorageStrategy', marg_ch_costs: mcc, marg_disch_costs: mdc});
        }

        function storage_strategy_window(asset_id, mcc, mdc) {
            sidebar_ctr = sidebar.getContainer();

            sidebar_ctr.innerHTML = '<h1>Storage Strategy:</h1>';

            table = '<table>';
            table = table + '<tr><td width=180>Marginal charge costs</td>';
            table = table + '<td><input type="text" width="60" id="marg_ch_costs" value="' + mcc + '"></td></tr>';
            table = table + '<tr><td width=180>Marginal discharge costs</td>';
            table = table + '<td><input type="text" width="60" id="marg_disch_costs" value="' + mdc + '"></td></tr>';
            table += '</table>';
            sidebar_ctr.innerHTML += table;

            sidebar_ctr.innerHTML += '<p><button onclick="sidebar.hide();set_storage_strategy(\''+ asset_id + '\');">Set costs</button></p>';
            sidebar.show();
        }

        function set_curtailment_strategy(asset_id) {
            max_power = document.getElementById('curt_max_power').value;
            socket.emit('command', {cmd: 'set_control_strategy', asset_id: asset_id, strategy: 'CurtailmentStrategy', max_power: max_power});
        }

        function curtailment_strategy_window(asset_id, max_power) {
            sidebar_ctr = sidebar.getContainer();

            sidebar_ctr.innerHTML = '<h1>Curtailment Strategy:</h1>';

            table = '<table>';
            table = table + '<tr><td width=180>Maximum power (in Watt)</td>';
            table = table + '<td><input type="text" width="60" id="curt_max_power" value="' + max_power + '"></td></tr>';
            table += '</table>';
            sidebar_ctr.innerHTML += table;

            sidebar_ctr.innerHTML += '<p><button onclick="sidebar.hide();set_curtailment_strategy(\''+ asset_id + '\');">Set strategy</button></p>';
            sidebar.show();
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Energy System information
        // ------------------------------------------------------------------------------------------------------------
        function get_es_info() {
            socket.emit('command', {cmd: 'get_es_info'});
        }

        function change_es_info(obj) {
            es_info_param_id = obj.id;
            es_info_param_name = obj.name;
            es_info_param_value = obj.value;

            socket.emit('command', {cmd: 'set_es_info_param', id: es_info_param_id, name: es_info_param_name, value: es_info_param_value});
        }

        function show_es_info(es_attrs) {
            // console.log(es_attrs);

            sidebar_ctr = sidebar.getContainer();

            sidebar_ctr.innerHTML = '<h1>Energy system information</h1>';

            table = '<table>';
            for (i=0; i<es_attrs.length; i++) {
                if (es_attrs[i][1] == null) {
                    value = '';
                } else {
                    value = es_attrs[i][1];
                }
                table += '<tr><td width=180>' + es_attrs[i]['name'] + '</td>';
                table += '<td><input type="text" width="60" id="' + es_attrs[i]['id'] + '" name="' +
                        es_attrs[i]['name'] + '" value="' + es_attrs[i]['value']+ '" onchange="change_es_info(this);"></td></tr>';
            }
            table += '</table>';
            sidebar_ctr.innerHTML = sidebar_ctr.innerHTML + table;

            sidebar.show();
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Update the select element to indicate to what area or building to add assets
        // ------------------------------------------------------------------------------------------------------------
        function update_area_bld_list_select() {
            let select = document.getElementById('area_bld_select');
            select.innerHTML = '';

            let option = document.createElement("option");
            option.classList.add("ui-state-active");
            option.text = 'Add assets to Area based on location';
            option.value = 'find_area_location_based';
            select.add(option, null);

            area_bld_list = get_area_bld_list(active_layer_id);
            if (area_bld_list) {
                for (i=0; i<area_bld_list.length; i++) {
                    let option = document.createElement("option");
                    let level = area_bld_list[i][3];
                    option.text = '';
                    if (level > 0) {
                         for (j=0; j<level; j++) option.text = option.text + '-';
                    }
                    option.text = option.text + '- ' + area_bld_list[i][0] + ': ' + area_bld_list[i][2] + ' (' + area_bld_list[i][1] + ')';
                    option.value = area_bld_list[i][1];
                    select.add(option, null);
                }
            }
            $("#area_bld_select").selectmenu("refresh");    // to update the selectmenu based on the selected value
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Function to check if a user has a certain role (can be used in extensions too)
        // ------------------------------------------------------------------------------------------------------------
        function check_role(role) {
            let user_roles = [{% for r in role %}"{{ r }}", {% endfor %}];
            return (user_roles.includes(role))
        }

        var socket;

        // ------------------------------------------------------------------------------------------------------------
        //  Document is ready loading --> all functionality to react on incoming socket messages
        // ------------------------------------------------------------------------------------------------------------
        $(document).ready(function() {
            namespace = '/esdl';
            socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port + namespace, {'timeout':50000, 'connect timeout': 15000, path: "/socket.io"});

            // add_handler();
            add_geojson_listener(socket, map);
            add_area_map_handlers(socket, map);

            // tell server we are ready to receive
            socket.emit('initialize');

            // request the list of assets in the EDR
            get_edr_assets('edr_assets');

            // ------------------------------------------------------------------------------------------------------------
            //  Initialization
            // ------------------------------------------------------------------------------------------------------------
            socket.on('connect', function() {
                console.log('connected');
                socket.emit('mngmnt', {data: 'I\'m connected!'});
                // let extensions know client is connected
                // and socket variable is available
                for (let i=0; i<extensions.length; i++) {
                    updatefun = extensions[i];
                    updatefun({type: 'client_connected'});
                }
            });

            socket.on('user_info', function(ui) {
                user_info = ui;
            });

            socket.on('user_settings', function(us) {
                user_settings = us;
                window.PubSubManager.broadcast('USER_SETTINGS', us);
            });

            socket.on('profile_info', function(pa) {
                profile_array = pa;
            });

            socket.on('qau_information', function(qau_info) {
                quantity_and_units_info = qau_info;
            });

            socket.on('control_strategy_config', function(csc) {
                control_strategy_config = csc
            });

            socket.on('esdl_services', function(list) {
                set_esdl_services_information(list);
            });

            socket.on('wms_layer_list', function(wms_layer_lst) {
                wms_layer_list = wms_layer_lst;
                // console.log(wms_layer_list);

                for (var key in wms_layer_list['layers']) {
                    var layer_info = wms_layer_list['layers'][key];

                    layer_info.layer_ref = L.tileLayer.wms(layer_info.url, {
                        layers: layer_info.layer_name,
                        format: 'image/png',
                        transparent: true,
                        attribution: layer_info.attribution
                    });
                    if (layer_info.visible) {
                        layer_info.layer_ref.addTo(map);
                        layer_info.layer_ref.bringToFront();
                    }
                }
            });

            // populate the asset menu grouped by capability
            socket.on('cap_pot_list', function(obj_list) {
                cap_pot_list = obj_list;
                build_asset_menu('asset_menu', true, obj_list);
            });

            socket.on('carrier_color_dict', function(color_dict) {
                set_carrier_color_dict(color_dict);
            });


            // ------------------------------------------------------------------------------------------------------------
            //  Generic functions
            // ------------------------------------------------------------------------------------------------------------
            socket.on('alert', function(message) {
                hide_loader();      // when backend sends error message, stop displaying loader
                alert(message);
            });

            // ------------------------------------------------------------------------------------------------------------
            //  Map functions
            // ------------------------------------------------------------------------------------------------------------
            function clear_ui(msg) {
                clear_layer = true;
                if (msg == null || msg['layer'] == 'assets') {
                    // esdl_layer.clearLayers();
                    clear_layers(active_layer_id, 'esdl_layer');
                }
                if (msg == null || msg['layer'] == 'areas') {
                    // area_layer.clearLayers();
                    clear_layers(active_layer_id, 'area_layer');
                }
                if (msg == null || msg['layer'] == 'potentials') {
                    // pot_layer.clearLayers();
                    clear_layers(active_layer_id, 'pot_layer');
                }
                if (msg == null || msg['layer'] == 'buildings') {
                    // bld_layer.clearLayers();
                    clear_layers(active_layer_id, 'bld_layer');
                }
                if (msg == null || msg['layer'] == 'connections') {
                    // connection_layer.clearLayers();
                    clear_layers(active_layer_id, 'connection_layer');
                }
                clear_layer = false;
            }
            window.clear_ui = clear_ui;

            socket.on('clear_ui', clear_ui)

            socket.on('clear_esdl_layer_list', function() {
                clear_esdl_layer_list();
                active_layer_id = null;
            });

            socket.on('create_new_esdl_layer', function(message) {
                title = message['title'];
                es_id = message['es_id'];

                create_new_esdl_layer(es_id, title);
                // add_select_esdl();      // update list with esdl layers
                add_layer_control();    // add jstree layer control
                // title_div = document.getElementById('es_title');
                // title_div.innerHTML = '<b>' + title + '<b>';
            });

            socket.on('set_active_layer_id', function(id) {
                // console.log('add_draw_control');
                active_layer_id = id;
                update_area_bld_list_select();            // update the list of areas and buildings to add assets to
                draw_control = add_draw_control(draw_control, map);                 // couple draw_control to active layer
                // console.log(draw_control);

                update_title(esdl_list[active_layer_id].title);
                // set_selected_layer(active_layer_id);
            });

            // ------------------------------------------------------------------------------------------------------------
            //  ESDL object functions
            // ------------------------------------------------------------------------------------------------------------
            socket.on('add_esdl_objects', function(options) {
                // Format of list items
                // 0         1          2     3   4           5          6      7      8        9           10
                // 'point'   asset      name  id  class_name  [lat,lon]  attrs  state  [ports]  capability  extra_attrs
                // 'line'    asset      name  id  class_name  [...]      attrs  state  [ports]
                // 'polygon' asset      name  id  class_name  [...]      attrs  state  [ports]  capability  extra_attrs
                // 'point'   potential  name  id  class_name  [lat,lon]
                // 'polygon' potential  name  id  class_name  [...]

                // hide_loader();
                // console.log(options);
                list = options['asset_pot_list'];
                add_to_building = options['add_to_building'];
                es_id = options['es_id'];
                carrier_info_mapping = get_carrier_info_mapping(es_id);

                tt_format = get_tooltip_format();

                es_bld_id = es_id;
                if (add_to_building) {
                   es_bld_id = bld_edit_id;
                }

                for (let i = 0; i<list.length; i++) {
                    add_asset(es_bld_id, list[i], add_to_building, carrier_info_mapping, tt_format);
                }
                if (!add_to_building) {
                    spatial_buffers_plugin.bring_spatial_buffers_to_back();
                }

                // make HTML titles possible in popup or tooltip when moving the mouse over an asset.
                $('div[title]').tooltip({
                    content: function() {
                        return $(this).attr('title');
                    }
                });

                if (list.length > 0 && options['zoom'] && !add_to_building) {
                    // var bounds = esdl_layer.getBounds();
                    var bounds = L.latLngBounds();
                    bounds.extend(get_layers(active_layer_id, 'esdl_layer').getBounds());
                    bounds.extend(get_layers(active_layer_id, 'bld_layer').getBounds());
                    bounds.extend(get_layers(active_layer_id, 'pot_layer').getBounds());
                    map.flyToBounds(bounds, {padding: [50,50], animate: false});  // true});
                }

                // Ewoud: should also work with building editor now...
                set_leaflet_sizes();
            });

            // deletes an esdl_object in the active layer
            // TODO: search in all esdl layers
            socket.on('delete_esdl_object', function(message) {
                object_id = message['asset_id'];
                layer = find_layer_by_id(active_layer_id, 'esdl_layer', object_id);
                if (layer !== undefined) {
                    remove_object_from_layer(active_layer_id, 'esdl_layer', layer);
                }
            });

            socket.on('add_building_objects', function(options) {
                // Format of list items
                // 0         1           2         3                    4                             5                   6     7
                // 'point'   asset.name  asset.id  type(asset).__name__ [shape['lat'], shape['lng']]] building_has_assets KPIs  extra_attrs
                // 'polygon' asset.name  asset.id  type(asset).__name__ coords                        building_has_assets KPIs  extra_attrs

                // hide_loader();
                // console.log(options);
                list = options['building_list'];
                es_id = options['es_id'];

                var geojson_list = [];

                for (let i = 0; i<list.length; i++) {
                    classname = 'zoom circle Building';
                    imgsrc = 'images/' + list[i][3] + '.png';
                    if (custom_icons_plugin.custom_icons) {
                        let custom_icon = custom_icons_plugin.get_icon_for(list[i][3], list[i][7]);
                        if (custom_icon) {
                            imgsrc = 'data:' + custom_icon.contentType + ';base64,' + custom_icon.imageData;
                        }
                    }
                    var divicon = L.divIcon({
                        className: classname,
                        html: '<div class="image-div" style="font-size:0px"><img class="zoom circle-img" src="' + imgsrc + '"></img></div>',
                        iconSize: null
                    });

                    if (list[i][1] == null) list[i][1] = 'No name';
					var title = list[i][3]+': '+list[i][1];
                    if (list[i][0] == 'point') {
                        var marker = L.marker([list[i][4][0], list[i][4][1]], {icon: divicon, title: title});

                        marker.title = title;
                        marker.id = list[i][2];
                        marker.esid = es_id;
                        marker.name = list[i][1];
                        marker.type = list[i][3];

                        set_building_handlers(marker);
                        add_object_to_layer(es_id, 'esdl_layer', marker);
                    }
                    if (list[i][0] == 'polygon') {
                        // var coords = list[i][4];
                        // var polygon = L.polygon(coords, {color: 'black', weight: 1, draggable:true, title: title});
                        // polygon.title = title;
                        // polygon.id = list[i][2];
                        // polygon.esid = es_id;
                        // polygon.name = list[i][1];
                        // polygon.type = list[i][3];
                        // add_object_to_layer(es_id, 'bld_layer', polygon);

                        var geojson_coords = list[i][4];
                        var KPIs = list[i][6];

                        geojson_list.push({
                            "type": "Feature",
                            "geometry": {
                                "type": "Polygon",
                                "coordinates": geojson_coords
                            },
                            "properties": {
                                "id": list[i][2],
                                "name": list[i][1],
                                "KPIs": KPIs
                            }
                        });

                        // only add building icon, if building contains assets
                        if (list[i][5]) {
                            var coords = list[i][4];
                            var polygon_center = calculate_array_polygon_center(coords[0]);
                            // exchange coordinates, geojson and leaflet use different order
                            polygon_center = [polygon_center[1], polygon_center[0]];
                            var marker = L.marker(polygon_center, {icon: divicon, title: title});

                            marker.title = title;
                            marker.id = list[i][2];
                            marker.esid = es_id;
                            marker.name = list[i][1];
                            marker.type = list[i][3];
                            // marker.polygon = polygon;    // building has no polygon, but a geojson layer...

                            set_building_handlers(marker);
                            add_object_to_layer(es_id, 'esdl_layer', marker);
                        }
                    }
                }

                add_building_geojson_layer_with_legend(geojson_list);
                set_leaflet_sizes();
            });

            socket.on('area_bld_list', function(areas_buildings) {
                es_id = areas_buildings['es_id'];
                area_bld_list = areas_buildings['area_bld_list'];
                set_area_bld_list(es_id, area_bld_list);
                update_area_bld_list_select();
            });

            socket.on('clear_connections', function(message) {
                let id = active_layer_id;
                if (message && message.id) {
                    id = message.id;
                    console.log("Clear connections for id:", id);
                }
                console.log('clear_connections', id)
                clear_layer = true;
                clear_layers(id, 'connection_layer');
                clear_layer = false;
            });

            socket.on('add_connections', function(connections) {
                conn_list = connections['conn_list']
                es_id = connections['es_id'];

                add_to_building = connections['add_to_building'];

                es_bld_id = es_id;
                if (add_to_building) {
                   es_bld_id = bld_edit_id; // global variable indicating the currently edited building
                }

                carrier_info_mapping = get_carrier_info_mapping(es_id);

                var linecolor = 0;
                var linewidth = 2;

                for (i = 0; i<conn_list.length; i++) {
                    var con = conn_list[i];
                    var coords = [con['from-asset-coord'], con['to-asset-coord']];
                    var title = '';

                    if (con['from-port-carrier'] == con['to-port-carrier']) {
                        linewidth = 2;
                        if (con['from-port-carrier']) {          // same carrier specified
                            linecolor = carrier_info_mapping[con['from-port-carrier']]['color'];
                            title = "Carrier: " + carrier_info_mapping[con['from-port-carrier']]['name'];
                        } else {                                 // no carrier specified
                            linecolor = carrier_info_mapping[0]['color'];
                            title = "Carrier: " + carrier_info_mapping[0]['name'];
                        }
                    } else {                                    // conflicting carriers
                        linewidth = 4;
                        linecolor = carrier_info_mapping[1]['color'];
                        title = carrier_info_mapping[1]['name'];
                    }

                    let line = L.polyline(coords, {color: linecolor, weight: linewidth, dashArray: '3,10', draggable: true, title: title});
                    if (title) {
                        let popup = L.popup();
                        popup.setContent(title);
                        line.bindPopup(popup);

                        line.on('mouseover', function (e) {
                            var popup = e.target.getPopup();
                            var this_map = e.sourceTarget._map;     // can be area map and building map
                            popup.setLatLng(e.latlng).openOn(this_map);
                            e.target.setStyle({dashArray:'1', weight: linewidth+2});
                        });

                        line.on('mouseout', function(e) {
                            e.target.closePopup();
                            e.target.setStyle({dashArray:'3,10', weight: linewidth});
                        });

                        line.on('mousemove', function (e) {
                            e.target.closePopup();
                            var this_map = e.sourceTarget._map;     // can be area map and building map
                            var popup = e.target.getPopup();
                            popup.setLatLng(e.latlng).openOn(this_map);
                        });

                        line.bindContextMenu({
                            contextmenu: true,
                            contextmenuWidth: 140,
                            contextmenuItems: [],
                            contextmenuInheritItems: false
                        });
                        line.options.contextmenuItems.push({
                            icon: 'icons/Delete.png',
                            text: 'Delete connection',
                            callback: function(e) {
                                //console.log(e, line, bld_edit_id);
                                socket.emit('command', {'cmd': 'remove_connection_portids',
                                    'from_port_id': line.from_port_id, 'to_port_id': line.to_port_id,
                                    'building_id': bld_edit_id});
                                    // building_id defines if the building editor is open or not.
                            }
                       });
                    }
                    // TODO: Should this be es_bld_is instead of es_id
                    line.es_id = es_id;
                    line.id = con['from-port-id'] + con['to-port-id']
                    line.from_port_id = con['from-port-id'];
                    line.to_port_id = con['to-port-id'];
                    add_object_to_layer(es_bld_id, 'connection_layer', line);
                }
            });

            socket.on('remove_single_connection', function(message) {
                let from_id = message['from-port-id'];
                let to_id = message['to-port-id'];
                let es_id = message['es_id'];
                remove_single_connection(from_id, to_id, es_id);
            });


            /* not used anymore (Ewoud)
            socket.on('add_new_conn', function(connection) {
                var new_conn = connection['new_conn'];
                var es_id = connection['es_id'];
                add_to_building = connection['add_to_building'];
                console.log('Add to building', add_to_building);

                es_bld_id = es_id;
                if (add_to_building) {
                   es_bld_id = bld_edit_id;
                }

                var coords = [new_conn[0], new_conn[1]];
                // console.log(coords);
                var line = L.polyline(coords, {color: 'gray', weight: 1, dashArray: '3,10', draggable: true});
                line.es_id = es_id
                line.id = connection['from-port-id'] + connection['to-port-id'];
                add_object_to_layer(es_bld_id, 'connection_layer', line);
            });
            */

            socket.on('carrier_list', function(carr_list) {
                set_carrier_list(carr_list['es_id'], carr_list['carrier_list']);
            });

            socket.on('sector_list', function(list) {
                set_sector_list(list['es_id'], list['sector_list']);
            });

            // ------------------------------------------------------------------------------------------------------------
            //  Received ESDL via API
            // ------------------------------------------------------------------------------------------------------------
            socket.on('received_esdl', function(message) {
                received_esdl_window(message);
            });

            // ------------------------------------------------------------------------------------------------------------
            //  User ESDL actions
            // ------------------------------------------------------------------------------------------------------------
            socket.on('asset_info', function(asset_info) {
                asset_id = asset_info['id'];
                asset_name = asset_info['name'];
                asset_class = asset_info['class'];
                asset_attrs = asset_info['attrs'];
                asset_doc = asset_info['asset_doc']
                connected_to_info = asset_info['connected_to_info'];
                ctrl_strategy = asset_info['ctrl_strategy'];
                //console.log(asset_attrs);
                //console.log(connected_to_info);
                //console.log(ctrl_strategy);

                sidebar_ctr = sidebar.getContainer();

                sidebar_ctr.innerHTML = '<h1 title="' + asset_doc + '">' + asset_name + '</h1>';

                let idgen = 0; // generate Unique ID's otherwise jquery-ui will err
                let table = '<table>';
                for (i=0; i<asset_attrs.length; i++) {
                    if (asset_attrs[i]['value'] == null) {
                        value = '';
                    } else {
                        value = asset_attrs[i]['value'];
                    }
                    let title = 'data-html="true" title="';
                    if (asset_attrs[i]['doc'] != null) {
                        title += asset_attrs[i]['doc'];
                    }
                    if (asset_attrs[i]['type'] != null) {
                        title += '<br/>Data type:  ';
                        title += asset_attrs[i]['type'];
                        title += ' ';
                    }
                    if (asset_attrs[i]['default'] != null) {
                        title += '<br/>Default value: ';
                        title += asset_attrs[i]['default'];
                    }
                    title += '"';
                    let edate = "";
                    if (asset_attrs[i]['type'] == 'EDate') {
                        edate = ' edate="true" ';
                    }
                    table += '<tr><td width=180 ' + title + '>' + camelCaseToWords(asset_attrs[i]['name']) + '</td>';

                    if (asset_attrs[i]['type'] == 'EEnum' || asset_attrs[i]['type'] == 'EBoolean') {
                        options = asset_attrs[i]['options'];
                        table += '<td><select width="60" style="width:145px" id="'+ asset_attrs[i]['name']+idgen +'" assetid="' + asset_id + '" name="' +
                            asset_attrs[i]['name'] + '" onchange="change_param(this);">';
                            for (let o=0; o<options.length; o++) {
                                selected = "";
                                if (options[o] == value) selected=" selected";
                                caption = options[o].charAt(0).toUpperCase() + options[o].slice(1).toLowerCase();
                                caption = caption.replace(/_/g, ' '); // replace _ with space to render nicely
                                table += '<option value="' + options[o] + '" '+selected+'>' + caption + '</option>';
                            }
                        table += '</select></td></tr>';
                    } else {
                        table += '<td><input type="text" width="60" id="'+ asset_attrs[i]['name']+idgen +'" assetid="' + asset_id + '" name="' +
                            asset_attrs[i]['name'] + '" value="' + value +'" onchange="change_param(this);" ' + edate + '></td></tr>';
                    }
                    idgen++;
                }
                table += '</table>';
                sidebar_ctr.innerHTML = sidebar_ctr.innerHTML + table;

                if (asset_class == 'EnergyAsset') {
                    sidebar_ctr.innerHTML += '<h2>Add ports:</h2>';
                    table = '<table>';
                    table += '<tr><td width=180>Name</td><td><input type="text" width="60" id="name_add_port"></td></tr>';
                    table += '<tr><td><button onclick="add_port(\'in\', \'' + asset_id +
                        '\'); sidebar.hide();">Add InPort</button><button onclick="add_port(\'out\', \'' +
                        asset_id + '\'); sidebar.hide();">Add OutPort</button></td><td>&nbsp;</td>';
                    table += '</table>';
                    sidebar_ctr.innerHTML = sidebar_ctr.innerHTML + table;

                    sidebar_ctr.innerHTML += '<h2>Current ports:</h2>';
                    table = '<table>';
                    for (i=0; i<connected_to_info.length; i++) {
                        pname = connected_to_info[i]['pname'];
                        if (pname == '') {
                            pname = 'No name';
                        }
                        pcarr = connected_to_info[i]['pcarr'];
                        if (pcarr == '') {
                            pcarr = 'No carrier';
                        }
                        table += '<tr><td><button onclick="remove_port(\'' + connected_to_info[i]['pid'] + '\'); sidebar.hide();">Del</button></td>';
                        table += '<td title="id: '+ connected_to_info[i]['pid'] +'">'
                            + connected_to_info[i]['ptype'] + ' - ' + pname + ' - ' + pcarr + '</td></tr>';
                    }
                    table += '</table>';
                    sidebar_ctr.innerHTML = sidebar_ctr.innerHTML + table;

                    if (ctrl_strategy) {
                        sidebar_ctr.innerHTML += '<h2>Control strategy:</h2>';
                        sidebar_ctr.innerHTML = sidebar_ctr.innerHTML + ctrl_strategy;
                    }

                    sidebar_ctr.innerHTML += '<h2>Connections:</h2>';
                    table = '<table>';
                    for (i=0; i<connected_to_info.length; i++) {
                        pname = connected_to_info[i]['pname'];
                        if (pname == '') {
                            pname = 'No name';
                        }
                        table += '<tr><td colspan=4 title="id: '+ connected_to_info[i]['pid'] +'">'
                            + connected_to_info[i]['ptype'] + ' - ' + pname + '</td></tr>';
                        for (j=0; j<connected_to_info[i]['ct_list'].length; j++) {
                            aname = connected_to_info[i]['ct_list'][j]['aname'];
                            if (aname == '') {
                                aname = 'No name';
                            }
                            table += '<tr>';
                            // remove_connection(from_asset_id, from_port_id, to_asset_id, to_port_id)
                            let from_asset_id = asset_id;
                            let from_port_id = connected_to_info[i]['pid'];
                            let to_asset_id = connected_to_info[i]['ct_list'][j]['aid'];
                            let to_port_id = connected_to_info[i]['ct_list'][j]['pid'];
                            table += '<td><button onclick="remove_connection(\'' + from_asset_id + '\',\'' + from_port_id + '\',\'' + to_asset_id + '\',\'' + to_port_id + '\'); sidebar.hide();">Del</button></td>';
                            table += '<td>&nbsp;</td><td title="port id:' + connected_to_info[i]['ct_list'][j]['pid'] + '">'
                                + connected_to_info[i]['ct_list'][j]['atype'] + ' - '
                                + aname + '</td>';
                            table += '</tr>';
                        }
                    }
                    table += '</table>';
                    sidebar_ctr.innerHTML = sidebar_ctr.innerHTML + table;
                }

                // add date picker to date input fields
                $( ":input[edate*='true']" ).datepicker({
                    showOn: "button",
                    dateFormat: "yy-mm-dd",
                    showAnim: "slideDown",
                    changeYear: true,
                    yearRange: "1980:2060",
                    changeMonth: true
                    });
                // let tooltips support html styling
                $('td[title]').tooltip({
                    content: function() {
                        return $(this).attr('title');
                    }
                });
                sidebar.show();
            });

			// socket.on('conductor_info', function(asset_info) {
				// console.log('Conductor info: ')
				// console.log(asset_info);
				// asset_id = asset_info['id'];
                // asset_name = asset_info['name'];
				// latlng = asset_info['latlng']; // location of popup send in messagage
                // asset_attrs = asset_info['attrs'];

				// length = 0;
				// for (i=0; i<asset_attrs.length; i++) {
				// 	if (asset_attrs[i][0]=='length') {
				// 		length=asset_attrs[i][1];
				// 	}
				// }

				// var popup = L.popup().setLatLng(latlng)
				// 		.setContent('<p><b>'+asset_name+'</b><br>Length: '+length+'m<br>id: '+asset_id+'</p>')
				// 		.openOn(map);
			// });

            socket.on('place_edr_asset', function(asset_type) {
                if (asset_type == 'Pipe' || asset_type == 'ElectricityCable') {
                    update_line_asset_menu(asset_type);
                    initiate_draw_asset(draw_control, 'line_select');
                } else {
                    update_asset_menu(asset_type);
                    initiate_draw_asset(draw_control, 'asset_menu');
                }
                socket.emit('command', {'cmd': 'set_asset_drawing_mode', 'mode': 'edr_assets'});
            });

            socket.on('port_profile_info', function(port_profile_info) {
                port_profile_info_window(port_profile_info);
            });

            // update an asset - called after adding and removing ports
            // currently only updates the ports for the context menu
            socket.on('update_asset', function(asset_update) {
                asset_id = asset_update['asset_id'];
                ports = asset_update['ports'];
                layer = find_layer_by_id(active_layer_id, 'esdl_layer', asset_id);
                layer.ports = ports;
                if (layer instanceof L.Marker) {
                    set_marker_handlers(layer);
                }
                if (layer instanceof L.Polyline) {
                    set_line_handlers(layer);
                    update_line_color(layer);
                }
            });

            socket.on('storage_strategy_window', function(params) {
                var asset_id = params['asset_id'];
                var mcc = params['mcc'];
                var mdc = params['mdc'];

                storage_strategy_window(asset_id, mcc, mdc)
            });

            socket.on('curtailment_strategy_window', function(params) {
                var asset_id = params['asset_id'];
                var max_power = params['max_power'];

                curtailment_strategy_window(asset_id, max_power);
            });

            socket.on('marginal_costs', function(params) {
                var mc = params['mc'];
                var asset_id = params['asset_id'];

                marginal_costs_window(asset_id, mc)
            });

            // ------------------------------------------------------------------------------------------------------------
            //  User Menu actions
            // ------------------------------------------------------------------------------------------------------------
            socket.on('store_list', function(store_items) {
                sidebar_ctr = sidebar.getContainer();

{% if 'mondaine' in role %}
                sidebar_ctr.innerHTML = '<h1>Load ESDL from Mondaine Hub</h1>';
{% else %}
                sidebar_ctr.innerHTML = '<h1>Load ESDL from store</h1>';
{% endif %}
                select = '<select id="load_es_selection">';
                for (i = 0; i<store_items.length; i++) {
                    select += '<option value="'+store_items[i]['id']+'"';
                    if (i==0) { select += ' selected="true" '; }
                    select += '>'+store_items[i]['title']+'</option>';
                }
                select += '</select>';
                sidebar_ctr.innerHTML = sidebar_ctr.innerHTML + select;
                sidebar_ctr.innerHTML += '<button onclick="sidebar.hide();click_load_ESDL_button(this);">Load</button>';
                sidebar_ctr.innerHTML += '<button onclick="sidebar.hide();click_import_ESDL_button(this);">Import</button>';

                sidebar.show();
            });

            socket.on('store_item_metadata', function(data) {
                process_store_item_metadata(data);
            });

            socket.on('show_es_info', function(es_attrs) {
                // console.log('show es info received');
                // console.log(es_attrs);
                //show_es_info(es_attrs);
                esdl_browser.open_browser(active_layer_id);
            });

{% if 'table' in role %}
            socket.on('table_editor', function(asset_info_list) {
                open_es_table_editor(dialog, asset_info_list);
            });
{% endif %}

            socket.on('building_information', function(bld_info) {
                open_building_editor(dialog, bld_info);
            });

            // ------------------------------------------------------------------------------------------------------------
            //  ESSIM functions
            // ------------------------------------------------------------------------------------------------------------
{% if essim_enabled and 'essim' in role %}
            socket.on('simulation_not_started', function() {
                simulation_not_started();
            });

            socket.on('results_validation_for_ESSIM', function(results) {
                show_validate_for_ESSIM_window(results);
            });

            socket.on('show_ESSIM_KPIs', function(results) {
                hide_loader();
                show_ESSIM_KPIs(results);
            });
{% endif %}

            // ------------------------------------------------------------------------------------------------------------
            //  ESDL services functions
            // ------------------------------------------------------------------------------------------------------------
            socket.on('esdl_service_result', function(results) {
                hide_loader();
                if (results.esdl_service_result) {
                    process_service_results(results.esdl_service_result)
                }
            });

        });
    </script>


    <script>
        // ------------------------------------------------------------------------------------------------------------
        //  Function to trigger the right drawing tool based on the selected energy asset
        // ------------------------------------------------------------------------------------------------------------
        function initiate_draw_asset(dc, menu_id) {
            var select_box = document.getElementById(menu_id);
            var selected_asset = select_box.options[select_box.selectedIndex].value;

            var line_assets = ["ElectricityCable", "Pipe"];
            var polygon_assets = ["PVPark", "WindPark"];
            if (line_assets.includes(selected_asset)) {
                if (menu_id == 'asset_menu') update_line_asset_menu(selected_asset);
                dc._toolbars.draw._modes.polyline.handler.enable();
            } else if (selected_asset == "Area") {
                dc._toolbars.draw._modes.polygon.handler.enable();
            } else {
                var marker_class_name = window[selected_asset + "Marker"];

                dc.setDrawingOptions({
                    marker: {
                        icon: new marker_class_name()
                    }
                });
                if (polygon_assets.includes(selected_asset)) {
                    socket.emit('command', {'cmd': 'set_area_drawing_mode', 'mode': 'asset_with_polygon'});
                    dc._toolbars.draw._modes.polygon.handler.enable();
                } else {
                    dc._toolbars.draw._modes.marker.handler.enable();
                }
            }
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Top menu configuration (width, icons, and so on...)
        // ------------------------------------------------------------------------------------------------------------
        $(function() {
            $("#asset_menu").selectmenu({ 'width': '200px', 'max-height': '500px' }); //.selectmenu( "menuWidget" ).addClass( "overflow" );
            $("#line_select").selectmenu({ width:200 });
            $("#area_bld_select").selectmenu({ width:500 });
            //$("#area_bld_select-menu").css({ 'max-height': '600px' });
            $("#carrier_select").selectmenu({ width:150 });
            $("#profile_menu").selectmenu({ width:150 });
            $('#boundary-info').button({text: false, icons: {primary: "geometry"}});
            $('#layer-info').button({text: false, icons: {primary: "layers"}});
            $('#import-esdl').button({text: false, icons: {primary: "import"}});
            $('#compare-esdl').button({text: false, icons: {primary: "compare"}});

            // changes the icon for the new marker command
            $('#asset_menu').on('selectmenuchange', function (e) {
                socket.emit('command', {'cmd': 'set_asset_drawing_mode', 'mode': 'empty_assets'});
                // console.log('selectmenuchange');
                // console.log(draw_control);
                initiate_draw_asset(draw_control, 'asset_menu');
            });

{% if not 'essim' in role %}
            $("#valESSIM").button({disabled: true});
            $("#ESSIM").button({disabled: true});
            $("#ESSIMkpis").button({disabled: true});
            $("#ESSIM_load_animation").button({disabled: true});
{% endif %}

        });

        function update_asset_menu(value) {
            let am = $('#asset_menu');
            am.val(value);
            $("#asset_menu").selectmenu("refresh").change();
        }
        function update_line_asset_menu(value) {
            let lam = $('#line_select');
            lam.val(value);
            $("#line_select").selectmenu("refresh").change();
        }

        function remove_tooltip() {
            $(".ui-tooltip-content").parents('div').remove();  // remove tooltip as it is shown when clicking
        }

        $(function() {
            $(document).tooltip();
        });

        function show_or_hide_kpicharts_bar(object) {
            if (object.childNodes[1].classList.contains("ui-icon-check")) {
                // hide kpicharts bar; remove checkmark
                $('.leaflet-kpicharts').hide();

                object.childNodes[1].classList.remove("ui-icon-check");
                object.childNodes[1].classList.remove("ui-icon");
            } else {
                // show kpicharts bar; add checkmark
                $('.leaflet-kpicharts').show();
                kpis.show_all_kpis();
                object.childNodes[1].classList.add("ui-icon-check");
                object.childNodes[1].classList.add("ui-icon");
            }
        };

        function refresh_esdl(e) {
            drawState.reset();
            sidebar.hide();
            window.draw_control._toolbars.draw._modes.polyline.handler.stopDrawing()
            window.draw_control._toolbars.draw._modes.polygon.handler.stopDrawing()
            window.draw_control._toolbars.draw._modes.marker.handler.stopDrawing();
            window.draw_control._toolbars.draw._modes.rectangle.handler.stopDrawing();
            window.draw_control._toolbars.edit._modes.edit.handler.disable();
            window.draw_control._toolbars.edit._modes.remove.handler.disable();
            socket.emit('command', {cmd: 'refresh_esdl', es_id: active_layer_id});
        }

    </script>

    <style>
    /*
    jQuery UI styles
    */
    .ui-widget { font-family: Trebuchet MS, Tahoma, Verdana, Arial, sans-serif; font-size: 11px; }
    .ui-button .ui-icon.graph {
        background-image: url(icons/Graph.png);
        width: 16;
        height: 16;
    }
    .ui-button .ui-icon.geometry{
        background-image: url(icons/AreaGeometry.png);
        width: 25;
        height: 25;
    }
    .ui-button .ui-icon.layers{
        background-image: url(icons/Layers.png);
        width: 25;
        height: 25;
    }
    .ui-button .ui-icon.import{
        background-image: url(icons/Import.png);
        width: 25;
        height: 25;
    }
    .ui-button .ui-icon.compare{
        background-image: url(icons/Compare.png);
        width: 25;
        height: 25;
    }

    ul { z-index:20000 !important; }
    </style>

    <!--    // z-index for jstree context menu, sidebar has 2000-->
    <!--    .vakata-context { z-index:20000 !important; }-->
    <!--    .jstree ul { z-index:20000 !important; }-->
    <!--    .jstree li > a > .jstree-icon {  display:none !important; }-->

</head>
<body class="flexbox-parent">
    <div class="flexbox-item topmenu">
        <div class="header">
            <div class="header-logo" ><img src="favicon.ico" height="20"></div>
            <div class="header-title" ><b>ESDL Map Editor - </b></div>
            <div class="header-title" id="es_title"></div>
            <div class="header-logout"><a href="/logout"><button id="logout" class="ui-button ui-widget ui-corner-all">Logout</button></a></div>
        </div>

        <div id="menu" style="float: left; position: relative;">

            <!-- Navbar -->
            <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
                <div class="container">
                    <div class="collapse navbar-collapse" id="navbarNavDropdown">

                        <!-- Left nav -->
                        <ul class="nav navbar-nav mr-auto">
                            <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#">File</a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="new_ESDL();">
                                        <span class="menu-icon ui-icon ui-icon-document"></span>
                                        New ESDL...</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="document.querySelector('.inputFile').click();">
                                        <span class="menu-icon ui-icon ui-icon-folder-open"></span>
                                        Load ESDL(s)...</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="document.querySelector('.inputImportFile').click();">
                                        <div class="menu-icon" id="menu_import"></div>
                                        Import ESDL...</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="save_ESDL(this, '.');">
                                        <div class="menu-icon ui-icon ui-icon-disk"></div>
                                        Save ESDL...</a></li>
{% if store_enabled %}
{% if 'mondaine' in role %}
                                    <li><a class="dropdown-item" href="#" onclick="send_cmd_load_ESDL();">
                                        <div class="menu-icon ui-icon ui-icon-folder-open"></div>
                                        Load ESDL from Mondaine Hub...</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="send_cmd_store_ESDL();">
                                        <div class="menu-icon ui-icon ui-icon-disk">&nbsp;</div>
                                        Save ESDL to Mondaine Hub...</a></li>
{% else %}
                                    <li><a class="dropdown-item" href="#" onclick="send_cmd_load_ESDL();">
                                        <div class="menu-icon ui-icon ui-icon-folder-open">&nbsp;</div>
                                        Load ESDL from ESDL Store...</a></li>
{% endif %}
{% endif %}
{% if esdl_drive_enabled %}
                                    <li><a class="dropdown-item" href="#" onclick="esdlDrive.file_open_dialog();">
                                        <div class="menu-icon ui-icon ui-icon-folder-open"></div>
                                        Load from ESDL Drive...</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="esdlDrive.file_save_dialog();">
                                        <div class="menu-icon ui-icon ui-icon-folder-open"></div>
                                        Save to ESDL Drive...</a></li>
{% endif %}
                                    <li><a class="dropdown-item" href="#" onclick="export_as_shapefiles(this, '.');">
                                        <div class="menu-icon ui-icon ui-icon-folder-open"></div>
                                        Export as shapefiles</a></li>

                                </ul>
                            </li>
                            <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#">Edit</a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="table_editor.open()"><div class="menu-icon ui-icon ui-icon-calculator">&nbsp;</div>ESDL table editor...</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="get_es_info();"><div class="menu-icon ui-icon ui-icon-info">&nbsp;</div>ESDL browser...</a></li>
<!--                                    <li><a class="dropdown-item" href="#" onclick="energy_carrier_info();"><div class="menu-icon">&nbsp;</div>Energy carriers</a></li> -->
                                    <li><a class="dropdown-item" href="#" onclick="carriers_window();"><div class="menu-icon">&nbsp;</div>Energy carriers...</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="sector_info();"><div class="menu-icon">&nbsp;</div>Sectors...</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="environmental_profiles();"><div class="menu-icon ui-icon ui-icon-star">&nbsp;</div>Environmental profiles...</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="shapefile_converter_window.open_window();"><div class="menu-icon ui-icon ui-icon-image">&nbsp;</div>Shapefile converter...</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="search_assets_window();"><div class="menu-icon ui-icon ui-icon-search">&nbsp;</div>Search assets...</a></li>
                                </ul>
                            </li>

                            <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#">Services</a>
                                <ul class="dropdown-menu">
{% if statistics_service_enabled %}
                                    <li><a class="dropdown-item" href="#" onclick="es_statistics.open_window();"><div class="menu-icon">&nbsp</div>Energy system statistics...</a></li>
{% endif %}
                                    <li><a class="dropdown-item" href="#" onclick="esdl_services_info();"><div class="menu-icon">&nbsp;</div>External ESDL Services...</a></li>
{% if boundary_service_enabled or ibis_service_enabled %}
                                    <li><a class="dropdown-item" href="#" onclick="boundary_info_window();"><div class="menu-icon" id="menu_areaboundary">&nbsp;</div>Get boundary information...</a></li>
{% endif %}
{% if essim_enabled and 'essim' in role %}
                                    <li class="dropdown"><a class="dropdown-item dropdown-toggle" href="#"><div class="menu-icon"></div>ESSIM
                                        simulation</a>
                                        <ul class="dropdown-menu">
{% if 'table' in role %}
                                            <li><a class="dropdown-item" href="#" onclick="send_table_editor_request();"><div class="menu-icon ui-icon ui-icon-calculator">&nbsp;</div>ESDL table editor</a></li>
{% endif %}
                                            <li><a class="dropdown-item" href="#" onclick="validate_for_ESSIM();"><div class="menu-icon ui-icon ui-icon-help">&nbsp;</div>Validate</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="run_ESSIM_simulation_window();"><div class="menu-icon ui-icon ui-icon-circle-triangle-e">&nbsp;</div>Simulate</a></li>
<!--                                            <li><a class="dropdown-item" href="#" onclick="calculate_ESSIM_KPIs();"><div class="menu-icon ui-icon ui-icon-lightbulb">&nbsp;</div>ESSIM KPI results</a></li>-->
<!--                                            <li><a class="dropdown-item" href="#" onclick="AddErrorMessage('test', 'error'); animate_ESSIM_load();"><div class="menu-icon ui-icon ui-icon-video">&nbsp;</div>ESSIM animate load</a></li>-->
                                        </ul>
                                    </li>
{% endif %}
                                    <li class="dropdown"><a class="dropdown-item dropdown-toggle" href="#"><div class="menu-icon"></div>Load animation</a>
                                        <ul class="dropdown-menu">
{% if 'ielgas' in role %}
                                            <li><a class="dropdown-item" href="#" onclick="time_dimension.initialize('i-elgas', 'start_test_run', []);"><div class="menu-icon" id="menu_td_ielgas">&nbsp;</div>I-ELGAS model NL - all</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="time_dimension.initialize('i-elgas', 'start_test_run', ['electricity_network']);"><div class="menu-icon" id="menu_td_ielgas-e">&nbsp;</div>I-ELGAS model NL - electricity</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="time_dimension.initialize('i-elgas', 'start_test_run', ['gas_network']);"><div class="menu-icon" id="menu_td_ielgas-g">&nbsp;</div>I-ELGAS model NL - methane</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="time_dimension.initialize('i-elgas', 'start_test_run', ['hydrogen_network']);"><div class="menu-icon" id="menu_td_ielgas-h">&nbsp;</div>I-ELGAS model NL - hydrogen</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="time_dimension.initialize('i-elgas-eu', 'start_test_run', []);"><div class="menu-icon" id="menu_td_ielgaseu">&nbsp;</div>I-ELGAS model EU - all</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="time_dimension.initialize('i-elgas-eu', 'start_test_run', ['electricity_network']);"><div class="menu-icon" id="menu_td_ielgaseu-e">&nbsp;</div>I-ELGAS model EU - electricity</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="time_dimension.initialize('i-elgas-eu', 'start_test_run', ['gas_network']);"><div class="menu-icon" id="menu_td_ielgaseu-g">&nbsp;</div>I-ELGAS model EU - methane</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="time_dimension.initialize('i-elgas-eu', 'start_test_run', ['hydrogen_network']);"><div class="menu-icon" id="menu_td_ielgaseu-h">&nbsp;</div>I-ELGAS model EU - hydrogen</a></li>
{% endif %}
{% if 'opera' in role %}
                                            <li><a class="dropdown-item" href="#" onclick="time_dimension.initialize('opera_results', 'opera_test_run', []);"><div class="menu-icon" id="menu_td_opera">&nbsp;</div>Opera model - all</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="time_dimension.initialize('opera_results', 'opera_test_run', ['electricity_network']);"><div class="menu-icon" id="menu_td_opera-e">&nbsp;</div>Opera model - electricity</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="time_dimension.initialize('opera_results', 'opera_test_run', ['gas_network']);"><div class="menu-icon" id="menu_td_opera-g">&nbsp;</div>Opera model - methane</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="time_dimension.initialize('opera_results', 'opera_test_run', ['hydrogen_network']);"><div class="menu-icon" id="menu_td_opera-h">&nbsp;</div>Opera model - hydrogen</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="time_dimension.initialize('opera_results', 'opera_test_run2', []);"><div class="menu-icon" id="menu_td_opera2">&nbsp;</div>Opera model - 2 - all</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="time_dimension.initialize('opera_results', 'opera_test_run2', ['electricity_network']);"><div class="menu-icon" id="menu_td_opera2-e">&nbsp;</div>Opera model -2  - electricity</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="time_dimension.initialize('opera_results', 'opera_test_run2', ['gas_network']);"><div class="menu-icon" id="menu_td_opera2-g">&nbsp;</div>Opera model - 2 - methane</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="time_dimension.initialize('opera_results', 'opera_test_run2', ['hydrogen_network']);"><div class="menu-icon" id="menu_td_opera2-h">&nbsp;</div>Opera model - 2 - hydrogen</a></li>
{% endif %}
                                        </ul>
                                    </li>

                                    <li><a class="dropdown-item" href="#" onclick="continue_service_workflow();"><div class="menu-icon">&nbsp;</div>Continue active workflow</a></li>

                                    <li><a class="dropdown-item" href="#" onclick="compare_esdl_window();"><div class="menu-icon" id="menu_compare">&nbsp;</div>ESDL compare</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="merge_esdl_window();"><div class="menu-icon" id="menu_merge">&nbsp;</div>ESDL merge</a></li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#">View</a>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="refresh_esdl();">
                                            <div id="menu_option_refresh_esdl" class="menu-icon" style="margin-top:0px" title="Refresh the view of the ESDL (Ctrl+R)"><i class="fa fa-refresh fa-fw"></i></div>
                                            Refresh view (Ctrl+R)
                                        </a>
                                    </li>
                                    <li><a class="dropdown-item" href="#" onclick="show_layers();"><div class="menu-icon" id="menu_layers">&nbsp;</div>WMS layers</a></li>
                                    <li class="dropdown-divider">&nbsp;</li>
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="time_dimension.toggle_animation_toolbar_visibility();">
                                            <div id="menu_option_animation_bar" class="menu-icon ui-icon ui-icon-check">&nbsp;</div>
                                            Show/hide animation bar
                                        </a>
                                    </li>
                                    <li id="vue_toggle_show_asset_draw_toolbar"></li>
                                    <li id="vue_toggle_show_services_toolbar"></li>
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="show_or_hide_kpicharts_bar(this);">
                                            <div id="menu_option_kpi_window" class="menu-icon">&nbsp;</div>
                                            Show/hide KPIs
                                        </a>
                                    </li>
                                    <li id="vue_toggle_long_process_view"></li>
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="clear_layers(active_layer_id, 'sim_layer');">
                                            <div id="menu_option_clear_sim_layer" class="menu-icon">&nbsp;</div>
                                            Clear simulation results
                                        </a>
                                    </li>

<!--                                    <li><a class="dropdown-item" href="#" onclick="show_kpis();"><div class="menu-icon">&nbsp;</div>KPIs</a></li>-->
                                    <li><a class="dropdown-item" href="#" onclick="app_settings.open_window();"><div id="menu_settings" class="menu-icon" style="margin-top:0px"><i class="fa fa-cog" aria-hidden="true"></i></div>Settings</a></li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#">Help</a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="https://esdl-mapeditor-documentation.readthedocs.io/" target="#"><div class="menu-icon" id="menu_doc" style="margin-top:0px"><i class="fa fa-book" aria-hidden="true"></i></div>Documentation</a></li>
                                    <li id="vue_show_release_notes"></li>
                                    <li id="vue_show_about_box"></li>
<!--                                    <li><a class="dropdown-item" href="#" onclick="show_about_box();"><div class="menu-icon" id="menu_about">&nbsp;</div>About</a></li> -->
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>

        <div id="ctrl" style="float: right; position: relative; padding:3px;">
<!--            <input class="inputFile" type="file" style="display: none;" onchange="open_ESDL(event);"> -->
            <input class="inputFile" type="file" style="display: none;" onchange="loas_esdl_files(event);" onclick="this.value=null;" multiple>
            <input class="inputImportFile" type="file" style="display: none;" onchange="import_ESDL(event);" onclick="this.value=null;">

{% if edr_enabled %}
            <button id="edr-asset-btn" onclick="edr_asset_window();" title="EDR assets" class="ui-button ui-widget ui-corner-all">EDR assets</button>
{% endif %}
            <select id="asset_menu" style='position:relative;z-index:100'></select>

            <select id="line_select">
                <option value="ElectricityCable">ElectricityCable</option>
                <option value="Pipe">Pipe</option>
            </select>

            <select id="area_bld_select"></select>
        </div>
    </div>
    <div id="mapid" class="flexbox-item flexbox-item-grow" style="z-index:10"></div>

    <div id="sidebar"></div>
    <div id="sidebar_b"></div>
    <div id="loader"></div>
    <div id="kpicharts"></div>
    <div id="ldccontrol"></div>
    <div id="ielgascontrol"></div>
    <div id="essim_kpis_control"></div>
    <div id="vuemodal"></div>

    <div id="userMessages" class="userMessages userMessages-hidden"><p id="userMessage">There is a message</p></div>

    <div id="messagesContainer" class="Messages messages-hidden">
        <span id="introText">Log:</span>
        <span id="deleteLogItems" onclick="deleteLogItems()">Delete all</span>
        <div id="messages"></div>
    </div>
</div>

</body>
</html>

<script>

    var osmUrl = location.protocol + '//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            osmAttrib = '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            osm = L.tileLayer(osmUrl, { maxZoom: 25, maxNativeZoom:19, attribution: osmAttrib });

    var map = new L.Map('mapid', {
        center: new L.LatLng(52.1, 5.8),
        zoom: 8,
        timeDimensionControl: false,
        timeDimensionControlOptions: {
            loopButton: true,
            timeZones: ["UTC","Local"],
            playerOptions: {
                transitionTime: 100
            }
        },
        timeDimension: true,
        timeDimensionOptions: {
            timeInterval: "2015-01-01T00:00+01:00/2016-01-01T00:00+01:00",
            period: "PT1H"
        },
        contextmenu: true,
        contextmenuItems: [],
    });

    map.on('keyup', function(e) {
        if (e.keyCode === 27) {
            console.log('esc pressed!')
        }
    })

    map.on('zoomend', function() {
        set_leaflet_sizes();                /* Markers, joints, and lines */
    });

    // use a pane to control line selection overlay with a different zIndex
    init_selection_pane(map); // from asset.js

    select_assets.add_map_handler(map);

    baseTree = {
        label: 'Base layers',
        children: [
            {
                label: 'OpenStreetMap',
                layer: osm.addTo(map)
            },
            {
                label: 'Google Streets',
                layer: L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                    maxZoom: 20,
                    subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                    attribution: 'Google'
                })
            },
            {
                label: 'Google Satellite',
                layer: L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
                    maxZoom: 20,
                    subdomains:['mt0','mt1','mt2','mt3'],
                    attribution: 'Google'
                })
            },
            {
                label: 'No map',
                layer: L.imageOverlay('', [[50.803721015, 3.31497114423], [53.5104033474, 7.09205325687]])
            }
        ]
    };

    overlaysTree = {
        label: 'ESDL',
        children: []
    };

    // layer_ctrl_tree = L.control.layers.tree(baseTree, overlaysTree, { position: 'topright', collapsed: false }).addTo(map);
    L.control.mousePosition().addTo(map);

    L.easyPrint({
        title: 'Export',
        exportOnly: true,
        filename: 'ESDL_map'
    }).addTo(map);

    // List of assets that have a dedicated icon. For others they are generated based on capital letters in the name.
    var assets_for_icons = ["AggregatedBuilding", "ATES", "Battery", "Building", "Bus", "CheckValve", "CHP",
        "CoolingDemand", "EConnection", "ElectricityCable", "ElectricityDemand", "ElectricityNetwork", "Electrolyzer",
        "EVChargingStation", "Export", "FermentationPlant",  "FuelCell", "GasHeater", "GasNetwork",
        "GasStorage", "GConnection", "GenericConsumer", "GenericConversion", "GenericProducer", "GenericTransport",
        "GeothermalSource", "HConnection", "HeatExchange", "HeatingDemand", "HeatNetwork", "HeatPump", "HeatStorage",
        "Import", "Joint", "MobilityDemand", "Pipe", "PowerPlant", "Pump", "PVInstallation", "PVPanel", "PVPark",
        "ResidualHeatSource", "ResidualHeatSourcePotential", "Sensor", "SinkConsumer", "SolarCollector",
        "SourceProducer", "Transformer", "UTES", "Valve", "WaterBuffer", "WindPark", "WindTurbine"
    ];

    // rest of the markers are generated when the capabilities are send to the browser
    for (var i=0; i < assets_for_icons.length; i++) {
        var ass_name = assets_for_icons[i];
        window[ass_name+'Marker'] = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12),
            iconSize: new L.Point(30, 30), iconUrl: 'images/' + ass_name +'.png'}});
    }

    sidebar = L.control.sidebar('sidebar', {
        position: 'right',
        closeButton: true
    });
    map.addControl(sidebar);

    sidebar_b = L.control.sidebar_b('sidebar_b', {
        position: 'bottom',
        closeButton: true
    });
    map.addControl(sidebar_b);

    let dialog_options = {
        size: [ 1100, 700 ],
        minSize: [ 100, 100 ],
        maxSize: [ 2000, 800 ],
        anchor: [ 10, 50 ],
        initOpen: false
    };

    dialog = L.control.dialog(dialog_options);
    map.addControl(dialog);

    let table_editor_dialog_options = {
        size: [ 1100, 700 ],
        minSize: [ 100, 100 ],
        maxSize: [ 4000, 2000 ],
        anchor: [ 10, 50 ],
        initOpen: false
    };
    var table_editor = new TableEditorDialog(table_editor_dialog_options);
    map.addControl(table_editor);

{% if essim_enabled and 'essim' in role %}
    L.control.essim_control().addTo(map);
{% endif %}

    notesToolbarControl().addTo(map);

</script>

{% if debug %}
<script type="text/javascript" src="./dist/index.umd.js"></script>
{% else %}
<script type="text/javascript" src="./dist/index.umd.min.js"></script>
<link rel="stylesheet" href="./dist/index.css" type="text/css"/>
{% endif %}
