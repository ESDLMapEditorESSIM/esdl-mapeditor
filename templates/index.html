<!DOCTYPE HTML>
<html>
<head>
    <title>ESDL editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="shortcut icon" href="http://geis.hesi.energy/webeditor/favicon.ico" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg==" crossorigin=""></script>
    <!--link rel="stylesheet" href="./plugins/leaflet.css" crossorigin=""/-->
    <!--script src="./plugins/leaflet.js" crossorigin=""></script-->

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>
    <!--link rel="stylesheet" href="./plugins/leaflet.draw.css"/-->
    <!--script src="./plugins/leaflet.draw.js"></script-->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-polylinedecorator/1.1.0/leaflet.polylineDecorator.min.js"></script>

    <link rel="stylesheet" href=".{{dir_settings.plugin_prefix}}/plugins/L.Control.Sidebar.css"/>
    <script src=".{{dir_settings.plugin_prefix}}/plugins/L.Control.Sidebar.js"></script>

    <!-- downloaded from https://github.com/kartena/Proj4Leaflet -->
    <script src=".{{dir_settings.plugin_prefix}}/plugins/proj4.js"></script>
    <script src=".{{dir_settings.plugin_prefix}}/plugins/proj4leaflet.js"></script>

    <!--script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.slim.js"></script-->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>

    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <!--script type="text/javascript" src="./plugins/socket.io.min.js"></script-->
    <!--script type="text/javascript" src="./plugins/jquery-1.4.2.min.js"></script-->

    <link href=".{{dir_settings.plugin_prefix}}/plugins/leaflet.contextmenu.css" rel="stylesheet" type="text/css" />
    <script src=".{{dir_settings.plugin_prefix}}/plugins/leaflet.contextmenu.js" type="text/javascript"></script>

    <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>

    <!-- <script src='https://unpkg.com/shpjs@latest/dist/shp.js'></script> -->
    <script type="text/javascript" charset="utf-8">

        var sidebar;

        var profile_array;
        var carrier_list;
        var control_strategy_config;
        var wms_layer_list;
        var leaflet_layers = {};

        var connecting_assets = false;
        var first_clicked = false;
        var first_clicked_id;

        var connect_ports;

        var clear_layer = false;        // to indicate if esdl items need to be removed too (or only UI clear)
        var deleting_objects = false;   // to indicate if objects are being deleted (to prevent on click)
        var editing_objects = false;    // to indicate if objects are being edited (to prevent on click)

        // globally define the colors of the lines/conductors on the map
        var colors = {}
        colors['ElectricityCable'] = '#ff9090'
        colors['ElectricityCable_hoover'] = '#906060'
        colors['Pipe'] = 'blue'
        colors['Pipe_hoover'] = '#9999ff'

        // ------------------------------------------------------------------------------------------------------------
        //
        // ------------------------------------------------------------------------------------------------------------
        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // ------------------------------------------------------------------------------------------------------------
        //
        // ------------------------------------------------------------------------------------------------------------
        function calculate_length(layer) {
            var previousPoint;
            var polyline_length = 0;

            // http://leafletjs.com/reference.html#polyline-getlatlngs
            layer.getLatLngs().forEach(function (latLng) {
                 // http://leafletjs.com/reference.html#latlng-distanceto
                if (previousPoint) polyline_length += previousPoint.distanceTo(latLng);
                previousPoint = latLng;
            });

            return polyline_length;
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Splitting conductors (cables or pipes)
        // ------------------------------------------------------------------------------------------------------------
        splitConductorCallback = function(e) {
            splitConductor(e.relatedTarget.options.id, e.latlng, 'no_connect');
            // only remove conductor from UI, let server side remove conductor in ESDL
            clear_layer = true;
            esdl_layer.removeLayer(e.relatedTarget);
            clear_layer = false;
        }

        splitConductorConnectCallback = function(e) {
            splitConductor(e.relatedTarget.options.id, e.latlng, 'connect');
            // only remove conductor from UI, let server side remove conductor in ESDL
            clear_layer = true;
            esdl_layer.removeLayer(e.relatedTarget);
            clear_layer = false;
        }

        splitConductorAddJointCallback = function(e) {
            splitConductor(e.relatedTarget.options.id, e.latlng, 'add_joint');
            // only remove conductor from UI, let server side remove conductor in ESDL
            clear_layer = true;
            esdl_layer.removeLayer(e.relatedTarget);
            clear_layer = false;
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Handlers for clicking on an asset or potential
        // ------------------------------------------------------------------------------------------------------------
        function set_marker_handlers(marker) {
            let asset_id = marker.id
            if (marker.ports) {

                if (marker.ports.length > 0) {
                    marker.bindContextMenu({
                        contextmenu: true,
                        contextmenuWidth: 140,
                        contextmenuItems: []
                    });

                    for (let p=0; p<marker.ports.length; p++) {
                        let port_id = ''+marker.ports[p].id;
                        marker.options.contextmenuItems.push({
                            icon: '{{dir_settings.resource_prefix}}icons/Connect.png',
                            text: 'Connect ' + marker.ports[p].type + ' (' + port_id + '): ' + marker.ports[p].name,
                            callback: function(e) { connectAsset(e, asset_id, port_id); }
                        });
                    }
                    marker.options.contextmenuItems.push('-');

                    for (let p=0; p<marker.ports.length; p++) {
                        let port_id = marker.ports[p].id;
                        marker.options.contextmenuItems.push({
                            icon: '{{dir_settings.resource_prefix}}icons/Graph.png',
                            text: 'Set profile of ' + marker.ports[p].type + ' (' + port_id + '): ' + marker.ports[p].name,
                            callback: function(e) { setPortProfile(e, asset_id, port_id); }
                        });
                    }

                    marker.options.contextmenuItems.push('-');
                    marker.options.contextmenuItems.push({ text: 'Set carrier', icon: '{{dir_settings.resource_prefix}}icons/Connect.png', callback: setCarrier });

                    if (marker.capability == 'Conversion') {
                        marker.options.contextmenuItems.push('-');
                        for (p=0; p<marker.ports.length; p++) {
                            let port_id = marker.ports[p].id

                            if (marker.ports[p].type == 'OutPort') {
                                menu_item_txt = 'Set DrivenByDemand for [' + asset_id + ']: ' + marker.ports[p].type + ' (' + port_id + '): ' + marker.ports[p].name;
                                callback_function = function(e) {
                                    set_driven_by_demand(asset_id, port_id);
                                }
                            } else {
                                menu_item_txt = 'Set DrivenBySupply for [' + asset_id + ']: ' + marker.ports[p].type + ' (' + port_id + '): ' + marker.ports[p].name;
                                callback_function = function(e) {
                                    set_driven_by_supply(asset_id, port_id);
                                }
                            }

                            marker.options.contextmenuItems.push({
                                icon: '{{dir_settings.resource_prefix}}icons/Graph.png',
                                text: menu_item_txt,
                                callback: callback_function
                            });
                        }
                    }

                    if (marker.capability == 'Storage') {
                        marker.options.contextmenuItems.push('-');
                        marker.options.contextmenuItems.push({
                            icon: '{{dir_settings.resource_prefix}}icons/Graph.png',
                            text: 'Set StorageStrategy for [' + marker.id + ']',
                            callback: function(e) {
                                // set_storage_strategy(asset_id);
                            }
                        });
                    }

                    if (marker.capability == 'Consumer' || marker.capability == 'Producer') {
                        marker.options.contextmenuItems.push('-');
                        marker.options.contextmenuItems.push({
                            icon: '{{dir_settings.resource_prefix}}icons/Graph.png',
                            text: 'Set marginal costs for [' + asset_id + ']',
                            callback: function(e) {
                                socket.emit('command', {cmd: 'set_marginal_costs_get_info', asset_id: asset_id})
                                //marginal_costs_window(asset_id);
                            }
                        });
                    }

                    marker.options.contextmenuItems.push('-');
                    marker.options.contextmenuItems.push({text: 'Cancel'});
                }
            }

            marker.on('dragend', function(e) {
                var marker = e.target;
                var pos = marker.getLatLng();
                socket.emit('update-coord', {id: marker.id, lat: pos.lat, lng: pos.lng, asspot: marker.asspot});
                // console.log(e.oldLatLng.lat);
                // console.log(pos.lat + ', ' + pos.lng );
            });

            marker.on('remove', function(e) {
                // console.log('remove marker');
                // marker.options.icon.tooltip('destroy');
                if (clear_layer == false) socket.emit('command', {cmd: 'remove_object', id: marker.id, asspot: marker.asspot});
            });

            marker.on('click', function(e) {
                var marker = e.target;
                if (deleting_objects == false && editing_objects == false) {        // do not execute when removing/editing objects
                    // console.log('marker clicked');
                    var marker = e.target;
                    var id = marker.id;

                    if (connecting_assets) {
                        if (marker.asspot == 'asset') {
                            connectAssets(marker);
                        } else {
                            alert('Cannot connect to potential');
                        }
                    } else {
                        socket.emit('command', {cmd: 'get_object_info', id: id, asspot: marker.asspot});
                    }
                }
            });
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Handlers for clicking on a pipe or cable
        // ------------------------------------------------------------------------------------------------------------
        function set_line_handlers(line) {
            line.bindContextMenu({
                contextmenu: true,
                contextmenuWidth: 140,
                contextmenuItems: []
            });
            line.options.contextmenuItems.push(
                { text: 'Split', icon: '{{dir_settings.resource_prefix}}icons/SplitLine.png', callback: splitConductorCallback });
            line.options.contextmenuItems.push(
                { text: 'Split and connect', icon: '{{dir_settings.resource_prefix}}icons/SplitLine.png', callback: splitConductorConnectCallback });
            line.options.contextmenuItems.push(
                { text: 'Split and add joint', icon: '{{dir_settings.resource_prefix}}icons/SplitLine.png', callback: splitConductorAddJointCallback });
            line.options.contextmenuItems.push('-');

            //{ text: 'Connect', icon: '{{dir_settings.resource_prefix}}icons/Connect.png', disabled: true, callback: connectConductor },
            let line_id = line.id;
            for (let p=0; p<line.ports.length; p++) {
                let port_id = ''+line.ports[p].id;
                line.options.contextmenuItems.push({
                    icon: '{{dir_settings.resource_prefix}}icons/Connect.png',
                    text: 'Connect ' + line.ports[p].type + ' (' + port_id + '): ' + line.ports[p].name,
                    callback: function (e) { connectAsset(e, line_id, port_id); }
                });
            }

            line.options.contextmenuItems.push('-');
            line.options.contextmenuItems.push(
                { text: 'Set carrier', icon: '{{dir_settings.resource_prefix}}icons/Connect.png', callback: setCarrier });
            line.options.contextmenuItems.push('-');
            line.options.contextmenuItems.push({ text: 'Cancel' });

            line.on('remove', function(e) {
                if (layer.mouseOverArrowHead !== undefined) {
                    map.removeLayer(layer.mouseOverArrowHead)
                    delete layer.mouseOverArrowHead;
                }
                if (clear_layer == false) socket.emit('command', {cmd: 'remove_object', id: line.id});
            });

            line.on('click', function(e) {
                if (deleting_objects == false && editing_objects == false) {
                    var line = e.target;
                    var id = line.id;
                    console.log('line clicked: ' + line.title + '(' + line.type + ')');

                    if (connecting_assets) {
                        connectAssets(line);
                    } else {
                        // show popup after getting conductor info
                        socket.emit('command', {cmd: 'get_conductor_info', id: line.id, latlng: e.latlng});
                    }
                }
            });

            line.on('mouseover', function(e) {

                var layer = e.target;
                if (layer.type === undefined) {
                    layer.type = 'ElectricityCable';
                }
                layer.setStyle({
                    color: colors[layer.type + '_hoover'],
                    opacity: 1,
                    weight: 4
                });
                let lineType = layer.type;
                let lineColorHoover = colors[lineType + '_hoover']
                let arrowHead = L.polylineDecorator(layer, {
                            patterns: [
                                {
                                    offset: '1%',
                                    repeat: '49%',
                                    symbol: L.Symbol.arrowHead({pixelSize: 12, polygon: true, pathOptions: {stroke: true, color: lineColorHoover, fillOpacity: 1, weight: 1}})
                                }
                            ]
                        }).addTo(map);
                line.mouseOverArrowHead = arrowHead; // make sure we can removed it later in the mouseOut event
            });

            line.on('mouseout', function(e) {
                var layer = e.target;
                layer.setStyle({
                    color: colors[layer.type],
                    opacity: 1,
                    weight: 3
                });
                if (layer.mouseOverArrowHead !== undefined) {
                    map.removeLayer(layer.mouseOverArrowHead)
                    delete layer.mouseOverArrowHead;
                }
            });
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Connecting assets (This way of connecting is not used now and button currently disabled)
        // ------------------------------------------------------------------------------------------------------------
        function connectAssets(object) {
            console.log('this object is either a line or a marker: ');
            console.log(object);
            if (first_clicked) {
                first_clicked = false;
                if (first_clicked_id == object.id) {       // clicked same asset twice
                    console.log('first clicked cancelled');
                } else {                            // connect two assets
                    document.getElementById('conn_asset_id2').innerHTML = object.id;
                    document.getElementById('conn_asset_name2').innerHTML = object.name;
                    document.getElementById('conn_asset_type2').innerHTML = object.type;
                    document.getElementById('conn_asset_result').innerHTML = first_clicked_id + ' and ' + object.id + ' are now connected.';
                    document.getElementById('conn_asset_action').innerHTML = 'Click first asset...!';

                    console.log('second clicked' + object.id + ', connecting...');
                    socket.emit('command', {cmd: 'connect_assets', id1: first_clicked_id, id2: object.id});

                    // TODO: timer to clear sidebar?
                }
                first_clicked_id = 0;
            } else {
                first_clicked = true;
                first_clicked_id = object.id;

                document.getElementById('conn_asset_id1').innerHTML = object.id;
                document.getElementById('conn_asset_name1').innerHTML = object.name;
                document.getElementById('conn_asset_type1').innerHTML = object.type;
                document.getElementById('conn_asset_result').innerHTML = '';
                document.getElementById('conn_asset_action').innerHTML = 'Click second asset...!';

                console.log('first clicked ' + first_clicked_id);
            }
        }

        function conn_assets_window() {
            sidebar_ctr = sidebar.getContainer();
            sidebar_ctr.innerHTML = '<h1>Connect assets</h1>';

            par = '<p id="conn_asset_result"></p>';
            par += '<p><h2 style="color:blue;" id="conn_asset_action">Click first asset!</h2></p>';
            sidebar_ctr.innerHTML += par;

            table = '<table>';
            table += '<tr><td width=180><b>First asset:</b></td><td>&nbsp;</td></tr>';
            table += '<tr><td width=180>Id:</td><td id="conn_asset_id1">&nbsp;</td></tr>';
            table += '<tr><td width=180>Name:</td><td id="conn_asset_name1">&nbsp;</td></tr>';
            table += '<tr><td width=180>Type:</td><td id="conn_asset_type1">&nbsp</td></tr>';
            table += '<tr><td>&nbsp;</td><td>&nbsp;</td></tr>';
            table += '<tr><td width=180><b>Second asset:</b></td><td>&nbsp;</td></tr>';
            table += '<tr><td width=180>Id:</td><td id="conn_asset_id2">&nbsp;</td></tr>';
            table += '<tr><td width=180>Name:</td><td id="conn_asset_name2">&nbsp;</td></tr>';
            table += '<tr><td width=180>Type:</td><td id="conn_asset_type2">&nbsp</td></tr>';
            table += '</table>';

            sidebar_ctr.innerHTML += table;

            sidebar.show();
        }

        function conn_disconn_assets() {
            var button = document.getElementById('conn-disconn-assets');
            first_clicked = false;
            if (connecting_assets) {
                connecting_assets = false;
                button.innerHTML = 'Connect assets';
                sidebar.hide();
            } else {
                conn_assets_window();
                connecting_assets = true;
                button.innerHTML = 'Stop connecting assets';
            }
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Boundary information from GEIS boundary service
        // ------------------------------------------------------------------------------------------------------------
        function boundary_info_window() {
            sidebar_ctr = sidebar.getContainer();

            sidebar_ctr.innerHTML = '<h1>Boundary Information:</h1>';

            table = '<table>';
            table = table + '<tr><td width=180>Scope</td>';
            <!-- table = table + '<td><input type="text" width="60" id="scope" value="district"></td></tr>'; -->

            table = table + '<td><select id="scope">';
            table = table + '<option value="country">country</option>';
            table = table + '<option value="province">province</option>';
            table = table + '<option value="region">region</option>';
            table = table + '<option value="municipality" selected>municipality</option>';
            table = table + '<option value="district">district</option>';
            table = table + '<option value="neighbourhood">neighbourhood</option>';
            table = table + '</select></td></tr>';

            table = table + '<tr><td width=180>Subscope</td>';
            <!-- table = table + '<td><input type="text" width="60" id="subscope" value="neighbourhood"></td></tr>'; -->

            table = table + '<td><select id="subscope">';
            table = table + '<option value="country">country</option>';
            table = table + '<option value="province">province</option>';
            table = table + '<option value="region">region</option>';
            table = table + '<option value="municipality">municipality</option>';
            table = table + '<option value="district">district</option>';
            table = table + '<option value="neighbourhood" selected>neighbourhood</option>';
            table = table + '</select></td></tr>';

            table = table + '<tr><td width=180>Identifier</td>';
            table = table + '<td><input type="text" width="60" id="identifier" value="GM0060"></td></tr>';
            table = table + '<tr><td width=180>Initialize energysystem</td>';
            table = table + '<td><input type="checkbox" id="initialize_ES" checked></td></tr>';
            table = table + '<tr><td width=180>Add boundaries to energysystem</td>';
            table = table + '<td><input type="checkbox" id="add_boundary_to_ESDL" checked></td></tr>';
            table = table + '</table>';
            sidebar_ctr.innerHTML += table;

            sidebar_ctr.innerHTML += '<p><button onclick="sidebar.hide();get_boundary_info(this);">Request</button></p>';

            sidebar.show();
        }

        function get_boundary_info(obj) {
            identifier = document.getElementById('identifier').value;
            scope = document.getElementById('scope').value;
            subscope = document.getElementById('subscope').value;
            initialize_ES = document.getElementById('initialize_ES').checked;
            add_boundary_to_ESDL = document.getElementById('add_boundary_to_ESDL').checked;

            socket.emit('get_boundary_info', {identifier: identifier, scope: scope, subscope: subscope,
                initialize_ES: initialize_ES, add_boundary_to_ESDL: add_boundary_to_ESDL});
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Carriers and commodities
        // ------------------------------------------------------------------------------------------------------------
        setCarrier = function(e) {
            asset_id = e.relatedTarget.id;
            // console.log(asset_id);

            carrier_index = document.getElementById("carrier_select").selectedIndex;
            carrier_options = document.getElementById("carrier_select").options;
            carrier_id = carrier_options[carrier_index].value;

            // console.log(carrier_id);
            socket.emit('command', {cmd: 'set_carrier', asset_id: asset_id, carrier_id: carrier_id});
        }

        function add_carrier() {
            carr_type_index = document.getElementById('add_carrier_type').selectedIndex;
            carr_type_options = document.getElementById('add_carrier_type').options;
            carr_type = carr_type_options[carr_type_index].value;

            carr_name = document.getElementById('add_carrier_name').value;
            if (carr_type == 'en_carr') {
                carr_emission = document.getElementById('add_carrier_emission').value;
                carr_encont = document.getElementById('add_carrier_encont').value;

                carr_encunit_index = document.getElementById('add_carrier_encunit').selectedIndex;
                carr_encunit_options = document.getElementById('add_carrier_encunit').options;
                carr_encunit = carr_encunit_options[carr_encunit_index].value;

                carr_sofm_index = document.getElementById('add_carrier_sofm').selectedIndex;
                carr_sofm_options = document.getElementById('add_carrier_sofm').options;
                carr_sofm = carr_sofm_options[carr_sofm_index].value;

                carr_rentype_index = document.getElementById('add_carrier_rentype').selectedIndex;
                carr_rentype_options = document.getElementById('add_carrier_rentype').options;
                carr_rentype = carr_rentype_options[carr_rentype_index].value;

                socket.emit('command', {cmd: 'add_carrier', type: carr_type, name: carr_name, emission: carr_emission,
                    encont: carr_encont, encunit: carr_encunit, sofm: carr_sofm, rentype: carr_rentype});
            }
            if (carr_type == 'el_comm') {
                carr_voltage = document.getElementById('add_carrier_voltage').value;
                socket.emit('command', {cmd: 'add_carrier', type: carr_type, name: carr_name, voltage: carr_voltage});
            }
            if (carr_type == 'g_comm') {
                carr_pressure = document.getElementById('add_carrier_pressure').value;
                socket.emit('command', {cmd: 'add_carrier', type: carr_type, name: carr_name, pressure: carr_pressure});
            }
            if (carr_type == 'h_comm') {
                carr_suptemp = document.getElementById('add_carrier_suptemp').value;
                carr_rettemp = document.getElementById('add_carrier_rettemp').value;
                socket.emit('command', {cmd: 'add_carrier', type: carr_type, name: carr_name, suptemp: carr_suptemp,
                    rettemp: carr_rettemp});
            }
            if (carr_type == 'en_comm') {
                socket.emit('command', {cmd: 'add_carrier', type: carr_type, name: carr_name});
            }
        }

        function select_other_carrier() {
            carr_type_index = document.getElementById('add_carrier_type').selectedIndex;
            carr_type_options = document.getElementById('add_carrier_type').options;
            carr_type = carr_type_options[carr_type_index].value;

            document.getElementById('voltage_row').style.display = 'none';
            document.getElementById('pressure_row').style.display = 'none';
            document.getElementById('suptemp_row').style.display = 'none';
            document.getElementById('rettemp_row').style.display = 'none';
            document.getElementById('emission_row').style.display = 'none';
            document.getElementById('encont_row').style.display = 'none';
            document.getElementById('sofm_row').style.display = 'none';
            document.getElementById('rentype_row').style.display = 'none';

            if (carr_type == 'en_carr') {
                document.getElementById('emission_row').style.display = '';
                document.getElementById('encont_row').style.display = '';
                document.getElementById('sofm_row').style.display = '';
                document.getElementById('rentype_row').style.display = '';
            }
            if (carr_type == 'el_comm') {
                document.getElementById('voltage_row').style.display = '';
            }
            if (carr_type == 'g_comm') {
                document.getElementById('pressure_row').style.display = '';
            }
            if (carr_type == 'h_comm') {
                document.getElementById('suptemp_row').style.display = '';
                document.getElementById('rettemp_row').style.display = '';
            }
            if (carr_type == 'en_comm') {
            }
        }

        function energy_carrier_info() {
            sidebar_ctr = sidebar.getContainer();

            sidebar_ctr.innerHTML = '<h1>Energy Carriers and Commodities:</h1>';

            table = '<table>';
            for (i=0; i<carrier_list.length; i++) {
                // type, id, name
                table += '<tr><td><button onclick="remove_carrier(\'' + carrier_list[i]['id'] +
                    '\');">Del</button></td><td title="' + carrier_list[i]['id'] + '">' + carrier_list[i]['name'] + '</td><td>' +
                    carrier_list[i]['type'] + '</td></tr>';
            }
            table += '</table>';
            sidebar_ctr.innerHTML += table;

            sidebar_ctr.innerHTML += '<h2>Add carrier:</h2>';
            table = '<table>';
            table += '<tr><td width=180>Carrier type</td><td><select id="add_carrier_type" onchange="select_other_carrier();">';
            table += '<option value="en_carr">Energy carrier</option>';
            table += '<option value="el_comm">Electricity commodity</option>';
            table += '<option value="g_comm">Gas commodity</option>';
            table += '<option value="h_comm">Heat commodity</option>';
            table += '<option value="en_comm">Energy commodity</option>';
            table += '</select></td>';

            table += '<tr><td>Name</td><td><input type="text" width="60" id="add_carrier_name"></td></tr>';
            table += '<tr id="voltage_row" style="display:none"><td>Voltage</td><td><input type="text" width="20" id="add_carrier_voltage"></td></tr>';
            table += '<tr id="pressure_row" style="display:none"><td>Pressure</td><td><input type="text" width="20" id="add_carrier_pressure"></td></tr>';
            table += '<tr id="suptemp_row" style="display:none"><td>Supply temperature</td><td><input type="text" width="20" id="add_carrier_suptemp"></td></tr>';
            table += '<tr id="rettemp_row" style="display:none"><td>Return temperature</td><td><input type="text" width="20" id="add_carrier_rettemp"></td></tr>';
            table += '<tr id="emission_row"><td>Emission [kg/GJ]</td><td><input type="text" width="20" id="add_carrier_emission"></td></tr>';
            table += '<tr id="encont_row"><td>Energy content</td><td><input type="text" width="20" id="add_carrier_encont">';
            table += '<select id="add_carrier_encunit">';
            table += '<option value="MJpkg">MJ/kg</option>';
            table += '<option value="MJpNm3">MJ/Nm3</option>';
            table += '<option value="MJpMJ">MJ/MJ</option>';
            table += '</select></td></tr>';
            table += '<tr id="sofm_row"><td>State of matter</td><td><select id="add_carrier_sofm">';
            table += '<option value="UNDEFINED">UNDEFINED</option>';
            table += '<option value="SOLID">SOLID</option>';
            table += '<option value="LIQUID">LIQUID</option>';
            table += '<option value="GASEOUS">GASEOUS</option>';
            table += '</select></td></tr>';
            table += '<tr id="rentype_row"><td>Renewable type</td><td><select id="add_carrier_rentype">';
            table += '<option value="UNDEFINED">UNDEFINED</option>';
            table += '<option value="RENEWABLE">RENEWABLE</option>';
            table += '<option value="FOSSIL">FOSSIL</option>';
            table += '</select></td></tr>';
            table += '</table>';
            sidebar_ctr.innerHTML += table;

            sidebar_ctr.innerHTML += '<button onclick="sidebar.hide();add_carrier();">Add carrier</button>';

            sidebar.show();
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Marginal costs (used by ESSIM)
        // ------------------------------------------------------------------------------------------------------------
        function set_marginal_costs(asset_id) {
            mc = document.getElementById('marg_costs').value;
            console.log(mc);
            socket.emit('command', {cmd: 'set_marg_costs', asset_id: asset_id, marg_costs: mc});
        }

        function marginal_costs_window(asset_id, mc) {
            console.log(typeof(mc));
            console.log(mc);
            if (mc == null) { mc = ''; }

            sidebar_ctr = sidebar.getContainer();

            sidebar_ctr.innerHTML = '<h1>Set marginal costs:</h1>';

            table = '<table>';
            table = table + '<tr><td width=180>Marginal costs</td>';
            table = table + '<td><input type="text" width="60" id="marg_costs" value="' + mc + '"></td></tr>';
            table += '</table>';
            sidebar_ctr.innerHTML += table;

            sidebar_ctr.innerHTML += '<p><button onclick="sidebar.hide();set_marginal_costs(\''+ asset_id + '\');">Set costs</button></p>';
            sidebar.show();
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Storage strategies (used by ESSIM)
        // ------------------------------------------------------------------------------------------------------------
        function set_driven_by_demand(asset_id, port_id) {
            socket.emit('command', {'cmd': 'set_control_strategy', 'strategy': 'DrivenByDemand', 'asset_id': asset_id, 'port_id': port_id});
        }

        function set_driven_by_supply(asset_id, port_id) {
            socket.emit('command', {'cmd': 'set_control_strategy', 'strategy': 'DrivenBySupply', 'asset_id': asset_id, 'port_id': port_id});
        }

        function set_storage_strategy(asset_id) {
            mcc = document.getElementById('marg_ch_costs').value;
            mdc = document.getElementById('marg_disch_costs').value;
            socket.emit('command', {cmd: 'set_control_strategy', asset_id: asset_id, strategy: 'StorageStrategy', marg_ch_costs: mcc, marg_disch_costs: mdc});
        }

        function storage_strategy_window(asset_id, mcc, mdc) {
            sidebar_ctr = sidebar.getContainer();

            sidebar_ctr.innerHTML = '<h1>Storage Strategy:</h1>';

            table = '<table>';
            table = table + '<tr><td width=180>Marginal charge costs</td>';
            table = table + '<td><input type="text" width="60" id="marg_ch_costs" value="' + mcc + '"></td></tr>';
            table = table + '<tr><td width=180>Marginal discharge costs</td>';
            table = table + '<td><input type="text" width="60" id="marg_disch_costs" value="' + mdc + '"></td></tr>';
            table += '</table>';
            sidebar_ctr.innerHTML += table;

            sidebar_ctr.innerHTML += '<p><button onclick="sidebar.hide();set_storage_strategy(\''+ asset_id + '\');">Set costs</button></p>';
            sidebar.show();
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Functions for starting a new ESDL file, loading and saving an ESDL file
        // ------------------------------------------------------------------------------------------------------------
        function new_ESDL() {
            sidebar_ctr = sidebar.getContainer();
            sidebar_ctr.innerHTML = '<h1>New ESDL energysystem</h1>';

            table = '<table>';
            table += '<tr><td width=180>Title</td><td><input type="text" width="60" id="new_title"></td></tr>';
            table += '<tr><td width=180>Description</td><td><input type="text" width="60" id="new_description"></td></tr>';
            table += '<tr><td width=180>Email address</td><td><input type="text" width="60" id="new_email"></td></tr>';
            table += '<tr><td width=180></td><td></td></tr>';
            table += '<tr><td width=180>Top-level area name</td><td><input type="text" width="60" id="new_area_name"></td></tr>';
            table += '</table>';

            sidebar_ctr.innerHTML += table;
            sidebar_ctr.innerHTML += '<p><button onclick="sidebar.hide();click_new_ESDL_button(this);">Create</button></p>';

            sidebar.show();
        }

        function click_new_ESDL_button(obj) {
            new_title = document.getElementById('new_title').value;
            new_description = document.getElementById('new_description').value;
            new_email = document.getElementById('new_email').value;
            new_top_area_name = document.getElementById('new_area_name').value;

            socket.emit('file_command', {cmd: 'new_esdl', title: new_title, description: new_description,
                email: new_email, top_area_name: new_top_area_name});
        }

        function open_ESDL(event) {
            // getting a hold of the file reference
            var file = event.target.files[0];

            // setting up the reader
            var reader = new FileReader();
            reader.readAsText(file); // this is reading as data url

            // here we tell the reader what to do when it's done reading...
            reader.onload = readerEvent => {
                var content = readerEvent.target.result; // this is the content!
                socket.emit('file_command', {cmd: 'load_esdl_from_file', file_content: content});
            }
        }

        function send_cmd_load_ESDL() {
            socket.emit('file_command', {cmd: 'get_list_from_store'});
        }

        function click_load_ESDL_button(obj) {
            select = document.getElementById('load_es_selection');
            es_id = select.options[select.selectedIndex].value;
            es_title = select.options[select.selectedIndex].innerHTML;
            // console.log(es_id);

            title_div = document.getElementById('es_title');
            title_div.innerHTML = '<h1>' + es_title + '</h1>';

            socket.emit('file_command', {cmd: 'load_esdl_from_store', id: es_id});
        }

        function save_ESDL() {
            socket.emit('file_command', {cmd: 'save_esdl'});
        }

        function send_cmd_store_ESDL() {
            socket.emit('file_command', {cmd: 'store_esdl'});
        }

        function send_download_ESDL() {
            socket.emit('file_command', {cmd: 'download_esdl'});
        }

        // ------------------------------------------------------------------------------------------------------------
        //
        // ------------------------------------------------------------------------------------------------------------
        setPortProfile = function(e, marker_id, port_id) {
            console.log('setPortProfile(marker_id=' + marker_id + ', port_id=' + port_id + ')');
            socket.emit('command', {'cmd': 'get_port_profile_info', 'port_id': port_id});
        }

        function add_profile_to_port() {
            port_id = document.getElementById('profile_port_id').value;
            multiplier = document.getElementById('profile_multiplier').value;
            profile_type = document.getElementById('profile_type').value;
            profile_class_select = document.getElementById('profile_class');
            profile_class_id = profile_class_select.options[profile_class_select.selectedIndex].value;

            socket.emit('command', {cmd: 'add_profile_to_port', port_id: port_id, multiplier: multiplier,
                profile_type: profile_type, profile_class: profile_class_id});
        }

        function add_port(direction, asset_id) {
            // get name
            pname = document.getElementById('name_add_port').value;
            socket.emit('command', {cmd: 'add_port', direction: direction, asset_id: asset_id, pname: pname});
        }

        function remove_port(pid) {
            socket.emit('command', {cmd: 'remove_port', port_id: pid});
        }

        function remove_connection(from_asset_id, from_port_id, to_asset_id, to_port_id) {
            socket.emit('command', {cmd: 'remove_connection', from_asset_id:from_asset_id, from_port_id:from_port_id, to_asset_id:to_asset_id, to_port_id:to_port_id});
        }

        function change_param(obj) {
            asset_id = obj.id;
            asset_param_name = obj.name;
            asset_param_value = obj.value;

            socket.emit('command', {cmd: 'set_asset_param', id: asset_id, param_name: asset_param_name, param_value: asset_param_value});
        }

        function ClickMarker(e) {
            // alert (e.latlng);
        }

        function connectAsset(e, feature_id, port_id) {
            console.log('connectAsset(feature_id=' + feature_id + ', port_id=' + port_id + ')');
            //console.log(e);
            if (connect_ports != null) {
                socket.emit('command', {'cmd': 'connect_ports', port1id: connect_ports, port2id: port_id});
                connect_ports = null;
            } else {
                connect_ports = port_id;
            }
        }

        function connectConductor(e) {
            // alert (e.latlng);
        }

        function splitConductor(id, location, mode) {
            socket.emit('command', {cmd: 'split_conductor', id: id, location: location, mode: mode});
        }

        // ------------------------------------------------------------------------------------------------------------
        //
        // ------------------------------------------------------------------------------------------------------------
        function validate_for_ESSIM() {
            socket.emit('command', {cmd: 'validate_for_ESSIM'});
        }

        function show_validate_for_ESSIM_window(results) {
            sidebar_ctr = sidebar.getContainer();

            sidebar_ctr.innerHTML = '<h1>ESSIM Validation results:</h1>';

            table = '<table>';
            for (i=0; i<results.length; i++) {
                table += '<tr><td>' + results[i] + '</td></tr>'
            }
            table += '</table>';
            sidebar_ctr.innerHTML += table;

            sidebar_ctr.innerHTML += '<p id="button_close_validation_dialog"><button onclick="sidebar.hide();">Close</button></p>';

            sidebar.show();
        }

        // ------------------------------------------------------------------------------------------------------------
        //
        // ------------------------------------------------------------------------------------------------------------
        function run_ESSIM_simulation() {
            socket.emit('command', {cmd: 'run_ESSIM_simulation'});
        }

        function cancel_ESSIM_simulation() {
            socket.emit('command', {cmd: 'cancel_ESSIM_simulation'});
        }

        function poll_simulation_progress() {
            $.ajax({
		        url: '{{dir_settings.resource_prefix}}simulation_progress',
                success: function(data){
                    // console.log(data);

                    if (data["percentage"] == "1") {
                        dashboardURL = data["url"];
                        // console.log(dashboardURL);
                        progress = document.getElementById('progress_percentage');
                        progress.innerHTML = 'Simulation finsihed';
                        dbURL_location = document.getElementById('dashboard_url');
                        dbURL_location.innerHTML = 'Go to <a href="' + dashboardURL + '" target="#">dashboard</a>';

                        button_show = document.getElementById('button_close_simulation_dialog');
                        button_show.style.display = "block";
                        button_hide = document.getElementById('button_cancel_simulation');
                        button_hide.style.display = "none";

                    } else {
                        percentage = Math.round(parseFloat(data["percentage"]) * 100);
                        progress = document.getElementById('progress_percentage');
                        progress.innerHTML =  percentage + '%';
                        setTimeout(poll_simulation_progress, 1000);
                    }
                },
                dataType: "json"
            });
        }

        function show_simulation_progress_window() {
            sidebar_ctr = sidebar.getContainer();

            sidebar_ctr.innerHTML = '<h1>ESSIM Simulation</h1>';

            table = '<table>';
            table = table + '<tr><td width=180>Progress</td>';
            table = table + '<td id="progress_percentage">0%</td></tr>';
            table += '</table>';
            sidebar_ctr.innerHTML += table;

            sidebar_ctr.innerHTML += '<p id="dashboard_url"></p>';

            sidebar_ctr.innerHTML += '<p id="button_cancel_simulation"><button onclick="cancel_ESSIM_simulation(); sidebar.hide();">Cancel simulation</button></p>';
            sidebar_ctr.innerHTML += '<p id="button_close_simulation_dialog" hidden><button onclick="sidebar.hide();">Close</button></p>';

            sidebar.show();
            setTimeout(poll_simulation_progress, 1000)
        }

        // ------------------------------------------------------------------------------------------------------------
        //  Shapefile functions - Not working at the moment
        // ------------------------------------------------------------------------------------------------------------
        function load_shapefile() {
        	var files = document.getElementById('shapefile').files;
            if (files.length == 0) {
                console.log('filelength is zero');
                return; //do nothing if no file given yet
            }

            var file = files[0];

            if (file.name.slice(-3) != 'zip') {             // Only accept .zip. All others, return.
                document.getElementById('warning').innerHTML = 'Select .zip file';
                return;
            } else {
                document.getElementById('warning').innerHTML = ''; //clear warning message.
                handleZipFile(file);
            }
        };

        //More info: https://developer.mozilla.org/en-US/docs/Web/API/FileReader
        function handleZipFile(file){
            console.log('handle zip file');
            var reader = new FileReader();
            reader.onload = function() {
                if (reader.readyState != 2 || reader.error){
                    console.log("error");
                    return;
                } else {
                    console.log("no error");
                    convertShapefileToLayer(reader.result);
                }
            }
            reader.readAsArrayBuffer(file);
        }

        function convertShapefileToLayer(buffer) {
            shp(buffer).then(function(geojson) {	            //More info: https://github.com/calvinmetcalf/shapefile-js
                console.log('shapefile addto map');
                var layer = L.shapefile(geojson).addTo(map);       //More info: https://github.com/calvinmetcalf/leaflet.shapefile
                console.log(layer);
            });
        }

        function show_add_shapefile() {
            sidebar_ctr = sidebar.getContainer();

            sidebar_ctr.innerHTML = '<h1>Add shapefile</h1>';
            sidebar_ctr.innerHTML += '<p><label for="input">Select a zipped shapefile:</label><input type="file" id="shapefile"></p>';
            sidebar_ctr.innerHTML += '<button onclick="sidebar.hide();load_shapefile();">Load shapefile</button></p>';
            sidebar_ctr.innerHTML += '<span id="warning"></span>';

            sidebar.show();
        }

        // ------------------------------------------------------------------------------------------------------------
        //  WMS Layer functionality
        // ------------------------------------------------------------------------------------------------------------
        function add_layer() {
            layer_descr = document.getElementById('layer_descr').value;
            layer_url = document.getElementById('layer_url').value;
            layer_name = document.getElementById('layer_name').value;
            layer_id = uuidv4();

            socket.emit('command', {cmd: 'add_layer', id: layer_id, descr: layer_descr, url: layer_url, name: layer_name, visible: true});
            wms_layer_list[layer_id] = { description: layer_descr, url: layer_url, layer_name: layer_name }

            wms_layer_list[layer_id].layer_ref = L.tileLayer.wms(layer_url, {
                layers: layer_name,
                format:'image/png',
                transparent: true
            });
            wms_layer_list[layer_id].layer_ref.addTo(map);
            wms_layer_list[layer_id].layer_ref.bringToFront();
            wms_layer_list[id].visible = true;
        }

        function remove_layer(id) {
            socket.emit('command', {cmd: 'remove_layer', id: id});
            console.log('remove layer: '+id);
            map.removeLayer(wms_layer_list[id].layer_ref);
            delete wms_layer_list[id];
        }

        function click_layer(id) {
            checkbox = document.getElementById('cb_'+id);
            if (checkbox.checked) {
                console.log('add layer to map: '+id);
                wms_layer_list[id].layer_ref.addTo(map);
                wms_layer_list[id].layer_ref.bringToFront();
                wms_layer_list[id].visible = true;
            } else {
                console.log('remove layer from map: '+id);
                map.removeLayer(wms_layer_list[id].layer_ref);
                wms_layer_list[id].visible = false;
            }
        }

        function show_layers() {
            sidebar_ctr = sidebar.getContainer();

            sidebar_ctr.innerHTML = '<h1>Layers</h1>';
            table = '<table>';
            for (var key in wms_layer_list) {
                let value = wms_layer_list[key];

                table += '<tr><td><input type="checkbox" id="cb_'+ key +'" name="' +value.description+ '" onclick="click_layer(\''+key+'\');"';
                if (value.visible) { table += ' checked'; }
                table +='>';
                table += '<label for="'+value.id+'">'+value.description+'</label></td>';
                table += '<td><button onclick="remove_layer(\'' + key + '\');">Del</button></td></tr>';
            }
            table += '</table>';
            sidebar_ctr.innerHTML += table;

            sidebar_ctr.innerHTML += '<h2>Add layers:</h2>';
            table = '<table>';
            table += '<tr><td width=180>Description</td><td><input type="text" width="60" id="layer_descr"></td></tr>';
            table += '<tr><td width=180>URL</td><td><input type="text" width="60" id="layer_url"></td></tr>';
            table += '<tr><td width=180>Layer name</td><td><input type="text" width="60" id="layer_name"></td></tr>';
            table += '<tr><td><button onclick="add_layer();">Add layer</button></td><td>&nbsp;</td>';
            table += '</table>';
            sidebar_ctr.innerHTML = sidebar_ctr.innerHTML + table;

            sidebar.show();
        }

        var socket;

        // ------------------------------------------------------------------------------------------------------------
        //  Document is ready loading --> all functionality to react on incoming socket messages
        // ------------------------------------------------------------------------------------------------------------
        $(document).ready(function() {
            namespace = '/esdl';
            socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port + namespace, {'timeout':5000, 'connect timeout': 5000, path: "{{dir_settings.socket_prefix}}/socket.io"});

            socket.on('connect', function() {
                console.log('connected');
                socket.emit('mngmnt', {data: 'I\'m connected!'});
            });

            socket.on('log', function(msg) {
                $('#log').append('<br>' + $('<div/>').text('Received #' + msg.count + ': ' + msg.data).html());
            });

            socket.on('clear_ui', function(msg) {
                clear_layer = true;
                if (msg == null || msg['layer'] == 'assets') {
                    esdl_layer.clearLayers();
                }
                if (msg == null || msg['layer'] == 'areas') {
                    area_layer.clearLayers();
                }
                if (msg == null || msg['layer'] == 'potentials') {
                    pot_layer.clearLayers();
                }
                if (msg == null || msg['layer'] == 'buildings') {
                    bld_layer.clearLayers();
                }
                if (msg == null || msg['layer'] == 'connections') {
                    connection_layer.clearLayers();
                }
                clear_layer = false;
            });

            socket.on('add_marker', function(point_coords) {
                console.log(point_coords);

                var marker = L.Marker(point_coords);
                esdl_layer.addLayer(marker); // marker.addTo(map);
            });

            socket.on('add_esdl_objects', function(options) {
                // Format of list items
                // 0        1          2       3           4       5       6       7        8
                // 'point'  asset      name    id      class_name  lat     lon     [ports]  capability
                // 'line'   asset      name    id      class_name  [...]   [ports]
                // 'point'  potential  name    id      class_name  lat     lon

                list = options['list'];

                for (i = 0; i<list.length; i++) {
                    $('#log').append('<br>' + list[i][0]+ ', ' + list[i][2] + ': ' + list[i][3] + ' - ' + list[i][4]);

                    if (list[i][0] == 'point' && list[i][1] == 'asset' && list[i][4] != 'Joint') {
                        capability = list[i][8];
                        classname = 'circle ' + capability;
                    } else {
                        classname = '';
                    }

                    var divicon = L.divIcon({
                        className: classname,
                        html: '<center><img class="circle-img" width="23" height="23" src="{{dir_settings.resource_prefix}}images/' + list[i][4] + '.png"></img></center>',

                        iconSize:     [30, 30], // size of the icon
                        iconAnchor:   [15, 15], // point of the icon which will correspond to marker's location
                        popupAnchor:  [0, -15] // point from which the popup should open relative to the iconAnchor
                    });

                    var ESDLicon = L.icon({
                        iconUrl: '{{dir_settings.resource_prefix}}images/' + list[i][4] + '.png',

                        iconSize:     [30, 30], // size of the icon
                        iconAnchor:   [15, 15], // point of the icon which will correspond to marker's location
                        popupAnchor:  [0, -15] // point from which the popup should open relative to the iconAnchor
                    });

					var title = list[i][4]+': '+list[i][2]+ ' (id='+ list[i][3] + ')';
                    if (list[i][0] == 'point') {
                        var marker = L.marker([list[i][5], list[i][6]], {icon: divicon, title: title});

                        marker.title = title;
                        marker.id = list[i][3];
                        marker.name = list[i][2];
                        marker.type = list[i][4];
                        marker.asspot = list[i][1];
                        if (marker.asspot == 'asset') {
                            marker.ports = list[i][7];
                            marker.capability = list[i][8];
                        }

                        set_marker_handlers(marker);
                        esdl_layer.addLayer(marker);
                    }
                    if (list[i][0] == 'line') {
                        var coords = list[i][5];
                        var lineType = list[i][4];
                        //if (list[i][4] == 'ElectricityCable') linecolor = linecolor_cable
                        //if (list[i][4] == 'Pipe') linecolor = linecolor_pipe

                        var line = L.polyline(coords, {color: colors[lineType], weight: 3, draggable:true, title: title});

                        // line.bindPopup(list[i][4]+': '+list[i][2]+ '('+ list[i][3] + ')');
						line.title = title;
                        line.id = list[i][3];
                        line.ports = list[i][6];
                        line.type = list[i][4];
                        line.name = "";

                        set_line_handlers(line);
                        esdl_layer.addLayer(line);
                    }
                }

                if (list.length > 0 && options['zoom']) {
                    var bounds = esdl_layer.getBounds();
                    map.flyToBounds(bounds, {padding: [50,50], animate: true});
                }
            });

            // TODO: does not work
            socket.on('esdltxt', function(esdl_text) {
                var div = document.getElementById('esdltxt');
                div.innerHTML = esdl_text;
            });

            socket.on('area_bld_list', function(areas_buildings) {
                var select = document.getElementById('area_bld_select');
                select.innerHTML = '';
                for (i=0; i<areas_buildings.length; i++) {
                    var option = document.createElement("option");
                    if (i==0) { option.classList.add("ui-state-active"); }
                    var level = areas_buildings[i][3];
                    option.text = '';
                    if (level > 0) {
                         for (j=0; j<level; j++) option.text = option.text + '-';
                    }
                    option.text = option.text + '- ' + areas_buildings[i][0] + ': ' + areas_buildings[i][2] + ' (' + areas_buildings[i][1] + ')';
                    option.value = areas_buildings[i][1];
                    select.add(option, null);
                }
                $("#area_bld_select").selectmenu("refresh");    // to update the selectmenu based on the selected value
            });

            socket.on('clear_connections', function() {
                clear_layer = true;
                connection_layer.clearLayers();
                clear_layer = false;
            });

            socket.on('add_connections', function(connections) {
                for (i = 0; i<connections.length; i++) {
                    var con = connections[i];
                    var coords = [con['from-asset-coord'], con['to-asset-coord']];

                    var line = L.polyline(coords, {color: 'gray', weight: 1, dashArray: '3,10', draggable: true});
                    connection_layer.addLayer(line);
                }
            });

            socket.on('add_new_conn', function(connection) {
                var coords = [connection[0], connection[1]];
                // console.log(coords);
                var line = L.polyline(coords, {color: 'gray', weight: 1, dashArray: '3,10', draggable: true});
                connection_layer.addLayer(line);
            });

            socket.on('store_list', function(store_items) {
                sidebar_ctr = sidebar.getContainer();

                sidebar_ctr.innerHTML = '<h1>Load ESDL from store</h1>';
                select = '<select id="load_es_selection">';
                for (i = 0; i<store_items.length; i++) {
                    select += '<option value="'+store_items[i]['id']+'"';
                    if (i==0) { select += ' selected="true" '; }
                    select += '>'+store_items[i]['title']+'</option>';
                }
                select += '</select>';
                sidebar_ctr.innerHTML = sidebar_ctr.innerHTML + select;
                sidebar_ctr.innerHTML += '<button onclick="sidebar.hide();click_load_ESDL_button(this);">Load</button>';

                sidebar.show();
            });

            socket.on('asset_info', function(asset_info) {
                asset_id = asset_info['id'];
                asset_name = asset_info['name'];
                asset_attrs = asset_info['attrs'];
                connected_to_info = asset_info['connected_to_info'];
                // console.log(asset_attrs);

                sidebar_ctr = sidebar.getContainer();

                sidebar_ctr.innerHTML = '<h1>' + asset_name + '</h1>';
                sidebar_ctr.innerHTML += 'PS. Not all parameters can be set already!';

                table = '<table>';
                for (i=0; i<asset_attrs.length; i++) {
                    if (asset_attrs[i][1] == null) {
                        value = '';
                    } else {
                        value = asset_attrs[i][1];
                    }
                    table += '<tr><td width=180>' + asset_attrs[i][0] + '</td>';
                    table += '<td><input type="text" width="60" id="' + asset_id + '" name="' +
                            asset_attrs[i][0] + '" value="' + value + '" onchange="change_param(this);"></td></tr>';
                }
                table += '</table>';
                sidebar_ctr.innerHTML = sidebar_ctr.innerHTML + table;

                sidebar_ctr.innerHTML += '<h2>Add ports:</h2>';
                table = '<table>';
                table += '<tr><td width=180>Name</td><td><input type="text" width="60" id="name_add_port"></td></tr>';
                table += '<tr><td><button onclick="add_port(\'in\', \'' + asset_id +
                    '\'); sidebar.hide();">Add InPort</button><button onclick="add_port(\'out\', \'' +
                    asset_id + '\'); sidebar.hide();">Add OutPort</button></td><td>&nbsp;</td>';
                table += '</table>';
                sidebar_ctr.innerHTML = sidebar_ctr.innerHTML + table;

                sidebar_ctr.innerHTML += '<h2>Remove ports:</h2>';
                table = '<table>';
                for (i=0; i<connected_to_info.length; i++) {
                    pname = connected_to_info[i]['pname'];
                    if (pname == '') {
                        pname = 'No name';
                    }
                    table += '<tr><td><button onclick="remove_port(\'' + connected_to_info[i]['pid'] + '\'); sidebar.hide();">Del</button></td>';
                    table += '<td title="id: '+ connected_to_info[i]['pid'] +'">'
                        + connected_to_info[i]['ptype'] + ' - ' + pname + '</td></tr>';
                }
                table += '</table>';
                sidebar_ctr.innerHTML = sidebar_ctr.innerHTML + table;

                sidebar_ctr.innerHTML += '<h2>Connections:</h2>';
                table = '<table>';
                for (i=0; i<connected_to_info.length; i++) {
                    pname = connected_to_info[i]['pname'];
                    if (pname == '') {
                        pname = 'No name';
                    }
                    table += '<tr><td colspan=4 title="id: '+ connected_to_info[i]['pid'] +'">'
                        + connected_to_info[i]['ptype'] + ' - ' + pname + '</td></tr>';
                    for (j=0; j<connected_to_info[i]['ct_list'].length; j++) {
                        aname = connected_to_info[i]['ct_list'][j]['aname'];
                        if (aname == '') {
                            aname = 'No name';
                        }
                        table += '<tr>';
                        // remove_connection(from_asset_id, from_port_id, to_asset_id, to_port_id)
                        let from_asset_id = asset_id;
                        let from_port_id = connected_to_info[i]['pid'];
                        let to_asset_id = connected_to_info[i]['ct_list'][j]['aid'];
                        let to_port_id = connected_to_info[i]['ct_list'][j]['pid'];
                        table += '<td><button onclick="remove_connection(\'' + from_asset_id + '\',\'' + from_port_id + '\',\'' + to_asset_id + '\',\'' + to_port_id + '\'); sidebar.hide();">Del</button></td>';
                        table += '<td>&nbsp;</td><td title="port id:' + connected_to_info[i]['ct_list'][j]['pid'] + '">'
                            + connected_to_info[i]['ct_list'][j]['atype'] + ' - '
                            + aname + '</td>';
                        table += '</tr>';
                    }
                }
                table += '</table>';
                sidebar_ctr.innerHTML = sidebar_ctr.innerHTML + table;

                sidebar.show();
            });

			socket.on('conductor_info', function(asset_info) {
				// console.log('Conductor info: ')
				// console.log(asset_info);
				asset_id = asset_info['id'];
                asset_name = asset_info['name'];
				latlng = asset_info['latlng']; // location of popup send in messagage
                asset_attrs = asset_info['attrs'];

				length = 0;
				for (i=0; i<asset_attrs.length; i++) {
					if (asset_attrs[i][0]=='length') {
						length=asset_attrs[i][1];
					}
				}

				var popup = L.popup().setLatLng(latlng)
						.setContent('<p><b>'+asset_name+'</b><br>Length: '+length+'m<br>id: '+asset_id+'</p>')
						.openOn(map);

			});

            socket.on('port_profile_info', function(port_profile_info) {
                profile_info = port_profile_info['profile_info'];
                port_id = port_profile_info['port_id'];

                profile_class = profile_info['class'];
                profile_type = profile_info['type'];
                if (profile_class == 'SingleValue') {
                    profile_value_or_multiplier = profile_info['value'];
                    profile_uiname = 'SingleValue';
                } else if (profile_class == 'InfluxDBProfile') {
                    profile_value_or_multiplier = profile_info['multiplier'];
                    profile_uiname = profile_info['uiname'];
                } else if (profile_class == 'DateTimeProfile') {
                    profile_value_or_multiplier = 0;
                    profile_uiname = 'DateTimeProfile';
                }

                sidebar_ctr = sidebar.getContainer();

                sidebar_ctr.innerHTML = '<h1>Set profile of port:</h1>';
                table = '<table>';
                table += '<tr><td width=180>Profile class</td>';
                table += '<td><select id="profile_class"><option value="SingleValue"';
                if (profile_uiname == 'SingleValue') { table += ' selected'; }
                table += '>Single Value</option>';
                table += '<option value="DateTimeProfile"';
                if (profile_uiname == 'DateTimeProfile') { table += ' selected'; }
                table += '>DateTime Profile</option>';
                for (p=0; p<profile_array.length; p++) {
                    table += '<option value="'+profile_array[p]["profile_uiname"]+'"';
                    if (profile_uiname == profile_array[p]["profile_uiname"]) { table += ' selected'; }
                    table += '>'+profile_array[p]["profile_uiname"]+'</option>';
                }
                table += '</select></td></tr>';
                table += '<tr><td width=180>Multiplier or value</td>';
                table += '<td><input type="text" width="60" id="profile_multiplier" value="'+profile_value_or_multiplier+'"></td></tr>';
                table += '<tr><td width=180>Profile Type</td>';
                table += '<td><input type="text" width="60" id="profile_type" value="'+profile_type+'">';
                table += '<input type="hidden" id="profile_port_id" value="'+port_id+'"></td></tr>';
                table += '</table>'

                sidebar_ctr.innerHTML += table;
                sidebar_ctr.innerHTML += '<button onclick="sidebar.hide();add_profile_to_port();">Add</button>';

                sidebar.show();
            });

            socket.on('es_title', function(title) {
                title_div = document.getElementById('es_title');
                // title_div.innerHTML = '<h1>' + title + '</h1>';
                title_div.innerHTML = '<b>' + title + '<b>';
            });

            socket.on('alert', function(message) {
                alert(message);
            });

            socket.on('area_boundary', function(area_boundary) {
                geometry = area_boundary['boundary']
                color = area_boundary['color']
                fillcolor = area_boundary['fillcolor']
                info_type = area_boundary['info-type']
                name = area_boundary['name']
                boundary_type = area_boundary['boundary_type']
                // console.log(color)

                if (info_type == 'MP-RD') {
                    // console.log('received MP-RD')
                    var RD = new L.Proj.CRS( 'EPSG:28992','+proj=sterea +lat_0=52.15616055555555 +lon_0=5.38763888888889 +k=0.9999079 +x_0=155000 +y_0=463000 +ellps=bessel +units=m +towgs84=565.2369,50.0087,465.658,-0.406857330322398,0.350732676542563,-1.8703473836068,4.0812 +no_defs', {
                        resolutions: [3440.640, 1720.320, 860.160, 430.080, 215.040, 107.520, 53.760, 26.880, 13.440, 6.720, 3.360, 1.680, 0.840, 0.420, 0.210],
                        bounds: L.bounds([-285401.92, 22598.08], [595401.9199999999, 903401.9199999999]),
                        origin: [-285401.92, 22598.08]
                    });

                    var mp = geometry['coordinates'];
                    // console.log(mp.length);
                    for (i=0; i<mp.length; i++) {
                        polygon = mp[i];

                        var areaBoundary = {
                            type: "Feature",
                            geometry: {
                                type: "Polygon",
                                coordinates: polygon
                            },
                            crs: {
                                type: "name",
                                properties: {
                                    name: "EPSG:28992"
                                }
                            }
                        };
                        // L.Proj.geoJson(areaBoundary).addTo(map);
                        L.Proj.geoJson(areaBoundary, {color: color, fillcolor: fillcolor, weight: 1}).addTo(area_layer);
                    }
                }

                // assume coordinates are in CRS WGS84 (Lat/Lon); default for ESDL
                if (info_type == 'P-WGS84') {
                    // console.log('received P-WGS84')
                    var polygon = geometry['coordinates'];
                    // console.log(polygon);
                    var areaBoundary = {
                        type: "Feature",
                        geometry: {
                            type: "Polygon",
                            coordinates: polygon
                        }
                    };
                    // console.log(areaBoundary);
                    if (boundary_type == 'building') {
                        L.geoJson(areaBoundary, {
                            color: color, fillcolor: fillcolor, weight: 1, name: name
                        }).bindPopup(function (layer) {
                            return 'name:'+layer.options.name}).addTo(bld_layer);
                    } else {
                        L.geoJson(areaBoundary, {
                            color: color, fillcolor: fillcolor, weight: 1, name: name
                        }).bindPopup(function (layer) {
                            return 'name:'+layer.options.name}).addTo(area_layer);
                    }
                }

                // coordinates are in CRS WGS84 (Lat/Lon)
                if (info_type == 'MP-WGS84') {
                    console.log('received MP-WGS84')
                    var mp = geometry['coordinates'];
                    console.log(mp);

                    for (i=0; i<mp.length; i++) {
                        polygon = mp[i];

                        var areaBoundary = {
                            type: "Feature",
                            geometry: {
                                type: "Polygon",
                                coordinates: polygon
                            }
                        };
                        console.log(areaBoundary);
                        L.geoJson(areaBoundary, {color: color, fillcolor: fillcolor, weight: 1}).addTo(area_layer);
                    }
                }

                if (info_type == 'WKT') {
                    layer = omnivore.wkt.parse(geometry);
                    layer.setStyle({color: color, weight: 2, name: name});
                    layer.bindPopup(function (layer) {
                            return 'name:'+layer.options.name});
                    layer.addTo(area_layer);
                }
            });

            socket.on('pot_boundary', function(pot_boundary) {
                geometry = pot_boundary['boundary'];
                info_type = pot_boundary['info-type'];
                name = pot_boundary['name'];
                color = pot_boundary['color'];

                if (info_type == 'WKT') {
                    layer = omnivore.wkt.parse(geometry);
                    layer.setStyle({color: color, weight: 2, name: name});
                    layer.bindPopup(function (layer) {
                            return 'name:'+layer.options.name});
                    layer.addTo(pot_layer);
                }
            });

            socket.on('profile_info', function(pa) {
                profile_array = pa;
                // This functionality is now in the contextmenu
                <!--var select = document.getElementById('profile_menu');-->
                <!--select.innerHTML = '';-->

                <!--var option = document.createElement("option");-->
                <!--option.classList.add("ui-state-active");-->
                <!--option.text = "SingleValue profile";-->
                <!--option.value = "SingleValue";-->
                <!--select.add(option, null);-->

                <!--for (i=0; i<profile_array.length; i++) {-->
                    <!--var option = document.createElement("option");-->
                    <!--option.text = profile_array[i]["profile_uiname"];-->
                    <!--option.value = profile_array[i]["profile_uiname"];-->
                    <!--select.add(option, null);-->
                <!--}-->
                <!--$("#profile_menu").selectmenu("refresh");    // to update the selectmenu based on the selected value-->
            });

            socket.on('control_strategy_config', function(csc) {
                control_strategy_config = csc
            });

            socket.on('storage_strategy_window', function(params) {
                var asset_id = params['asset_id'];
                var mcc = params['mcc'];
                var mdc = params['mdc'];

                storage_strategy_window(asset_id, mcc, mdc)
            });

            socket.on('marginal_costs', function(params) {
                var mc = params['mc'];
                var asset_id = params['asset_id'];

                marginal_costs_window(asset_id, mc)
            });

            socket.on('carrier_list', function(carr_list) {
                carrier_list = carr_list;
                // console.log(carr_list);

                var select = document.getElementById('carrier_select');
                select.innerHTML = '';
                for (i=0; i<carrier_list.length; i++) {
                    var option = document.createElement("option");
                    if (i==0) { option.classList.add("ui-state-active"); }
                    option.text = carrier_list[i]['name']
                    option.value = carrier_list[i]['id']
                    select.add(option, null);
                }
                $("#carrier_select").selectmenu("refresh");    // to update the selectmenu based on the selected value
            });

            socket.on('wms_layer_list', function(wms_layer_lst) {
                wms_layer_list = wms_layer_lst;
                console.log(wms_layer_list);

                for (var key in wms_layer_list) {
                    var layer_info = wms_layer_list[key];

                    layer_info.layer_ref = L.tileLayer.wms(layer_info.url, {
                        layers: layer_info.layer_name,
                        format:'image/png',
                        transparent: true
                    });
                    if (layer_info.visible) {
                        layer_info.layer_ref.addTo(map);
                        layer_info.layer_ref.bringToFront();
                    }
                }
            });

            socket.on('and_now_press_download_file', function() {
                $("#download-esdl").click();
            });

            socket.on('show_simulation_progress_window', function() {
                show_simulation_progress_window();
            });

            socket.on('results_validation_for_ESSIM', function(results) {
                show_validate_for_ESSIM_window(results);
            });
        });
    </script>
    <script src=".{{dir_settings.plugin_prefix}}/plugins/shp.js"></script>
    <script src=".{{dir_settings.plugin_prefix}}/plugins/leaflet.shpfile.js"></script>


    <script>
        $(function() {
            $("#asset_menu").selectmenu({ width:200 });
            $("#line_select").selectmenu({ width:200 });
            $("#area_bld_select").selectmenu({ width:500 });
            $("#carrier_select").selectmenu({ width:150 });
            $("#building_color").selectmenu({ width:150 });
            $("#profile_menu").selectmenu({ width:150 });
            $('#boundary-info').button({text: false, icons: {primary: "geometry"}});
            $('#layer-info').button({text: false, icons: {primary: "layers"}});

            // changes the icon for the new marker command
            $('#asset_menu').on('selectmenuchange', function (e) {
                var selected_asset = $(e.target).val();
                var marker_class_name = window[selected_asset + "Marker"];

                drawControl.setDrawingOptions({
                    marker: {
                        icon: new marker_class_name()
                    }
                });
            });

            $("#building_color").on('selectmenuchange', function (e) {
                var selected_method = $(e.target).val();
                socket.emit('command', {cmd: 'set_building_color_method', method: selected_method});
            });
        });

        $(function() {
            $(document).tooltip();
        });
    </script>

    <style>
        .ui-widget { font-family: Trebuchet MS, Tahoma, Verdana, Arial, sans-serif; font-size: 11px; }
        .header, .footer {
          background-color: grey;
          color: white;
          padding: 4px;
        }
        body {
            padding: 0;
            margin: 0;
        }
        .ui-button .ui-icon.graph {
            background-image: url({{dir_settings.resource_prefix}}icons/Graph.png);
            width: 16;
            height: 16;
        }
        .ui-button .ui-icon.geometry{
            background-image: url({{dir_settings.resource_prefix}}icons/AreaGeometry.png);
            width: 25;
            height: 25;
        }
        .ui-button .ui-icon.layers{
            background-image: url({{dir_settings.resource_prefix}}icons/Layers.png);
            width: 25;
            height: 25;
        }

        .circle {
            border-radius: 50%;
            width: 30px;
            height: 30px;
            line-height: 30px;
        }
        .circle-img {
            vertical-align: middle;
        }
        .Producer {
            background: #93a800;
            border: 3px solid #6b7a00;
        }
        .Consumer {
            background: #649ec9;
            border: 3px solid #477393;
        }
        .Conversion {
            background: #b574ba;
            border: 3px solid #7030a0;
        }
        .Storage {
            background: #cb1325;
            border: 3px solid #950b18;
        }
        .Transport {
            background: #ffcb00;
            border: 3px solid #bc9500;
        }
    </style>

</head>
<body>
    <div class="header" style="height: 25px">
        <div style="float: left; padding:2px;"><img src="{{dir_settings.resource_prefix}}favicon.ico" height="20"></div>
        <div style="float: left; padding:2px;"><b>ESDL Web Editor:</b></div>
        <div style="float: left; padding:2px;" id="es_title"></div>
    </div>

    <div id="ctrl" style="clear: left; position: relative; height: 28px; padding:3px;">
        <button id="new-esdl" onclick="new_ESDL();" title="New energysystem" class="ui-button ui-widget ui-corner-all ui-button-icon-only"><span class="ui-icon ui-icon-document"></span>New</button>
        <button onclick="document.querySelector('.inputFile').click();" title="Load ESDL File" class="ui-button ui-widget ui-corner-all ui-button-icon-only"><span class="ui-icon ui-icon-folder-open"></span>Open</button>
        <input class="inputFile" type="file" style="display: none;" onchange="open_ESDL(event);">
        <button id="save-esdl" onclick="save_ESDL();" title="Save ESDL to file" class="ui-button ui-widget ui-corner-all ui-button-icon-only"><span class="ui-icon ui-icon-disk"></span>Save</button>
        <!-- button id="download-esdl" onclick="send_download_ESDL();">Download ESDL</button-->
        <a href=".{{dir_settings.download_prefix}}/EnergySystem.esdl" hidden><button id="download-esdl">Download ESDL</button></a>
        <button id="load-esdl" onclick="send_cmd_load_ESDL();" title="Load from ESDL store" class="ui-button ui-widget ui-corner-all"><span class="ui-icon ui-icon-folder-open"></span>Store</button>
        <button id="EC" onclick="energy_carrier_info()" title="Energy carriers and commodities" class="ui-button ui-widget ui-corner-all">ECs</button>
        <button id="store-esdl" onclick="send_cmd_store_ESDL();" title="Save to ESDL Store" class="ui-button ui-widget ui-corner-all"><span class="ui-icon ui-icon-disk"></span>Store</button>
        <!-- Connect assets now works via context menu -->
        <!-- button id="conn-disconn-assets" onclick="conn_disconn_assets();" title="Connect assets" class="ui-button ui-widget ui-corner-all"><span class="ui-icon ui-icon-link"></span>Connect</button-->
        <button id="boundary-info" onclick="boundary_info_window();" title="Get boundary information for region (and subregions)" class="ui-button ui-widget ui-corner-all ui-button-icon-only">Boundary</button>

        <select id="asset_menu" style='position:relative;z-index:100'>
            <option value="Battery">Battery</option>
            <option value="CHP">Combined Heat and Power</option>
            <option value="EConnection">EConnection</option>
            <option value="ElectricityDemand">ElectricityDemand</option>
            <option value="ElectricityNetwork">ElectricityNetwork</option>
            <option value="Electrolyzer">Electrolyzer</option>
            <option value="EVChargingStation">EVChargingStation</option>
            <option value="FuelCell">FuelCell</option>
            <option value="GConnection">GConnection</option>
            <option value="GasHeater">GasHeater</option>
            <option value="GasNetwork">GasNetwork</option>
            <option value="GenericConsumer">GenericConsumer</option>
            <option value="GenericConversion">GenericConversion</option>
            <option value="GenericProducer">GenericProducer</option>
            <option value="GeothermalSource">GeothermalSource</option>
            <option value="HeatingDemand">HeatingDemand</option>
            <option value="HeatNetwork">HeatNetwork</option>
            <option value="HeatPump">HeatPump</option>
            <option value="Joint">Joint</option>
            <option value="MobilityDemand">MobilityDemand</option>
            <option value="PowerPlant">PowerPlant</option>
            <option value="PVInstallation">PVInstallation</option>
            <option value="PVParc">PVParc</option>
            <option value="Transformer">Transformer</option>
            <option value="UTES">UTES</option>
            <option value="WindTurbine">WindTurbine</option>
            <!-- option value="ResidualHeatSourcePotential">ResidualHeatSourcePotential</option-->
        </select>

        <select id="line_select">
            <option value="ElectricityCable">ElectricityCable</option>
            <option value="Pipe">Pipe</option>
        </select>

        <select id="area_bld_select"></select>
        <select id="carrier_select"></select>

        <select id="building_color">
            <option value="building type">Building type</option>
            <option value="building year">Building year</option>
            <option value="floor area">Floor area</option>
        </select>

        <button id="valESSIM" onclick="validate_for_ESSIM();" title="Validate before ESSIM simulation" class="ui-button ui-widget ui-corner-all"><span class="ui-icon ui-icon-check"></span>Validate</button>
        <button id="ESSIM" onclick="run_ESSIM_simulation();" title="Run an ESSIM simulation" class="ui-button ui-widget ui-corner-all"><span class="ui-icon ui-icon-circle-triangle-e"></span>Simulate</button>
        <!-- <button id="button_shapefile" onclick="show_add_shapefile();" title="Add a shapefile" class="ui-button ui-widget ui-corner-all">SHP</button> -->
        <button id="layer-info" onclick="show_layers();" title="Show layers" class="ui-button ui-widget ui-corner-all"><span class="ui-button ui-widget ui-corner-all ui-button-icon-only"></span>Layers</button>
    </div>

    <div id="mapid" style="float: left; width: 100%; height: 850px; position:relative; z-index:10"></div>

    <div id="sidebar">
    </div>

    <!--
    <div id="log" style="float: left;"><h2>Logs:</h2></div>
    <div id="esdltxt" style="float: left;"></div>
    -->
</body>
</html>

<script>

    var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            osmAttrib = '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            osm = L.tileLayer(osmUrl, { maxZoom: 19, attribution: osmAttrib }),
            // map = new L.Map('mapid', { center: new L.LatLng(53.44, 5.8), zoom: 12 }),  // Ameland centered
            map = new L.Map('mapid', { center: new L.LatLng(52.1, 5.8), zoom: 8 }),
            esdl_layer = L.featureGroup().addTo(map),
            area_layer = L.featureGroup().addTo(map),
            bld_layer = L.featureGroup().addTo(map),
            pot_layer = L.featureGroup().addTo(map),
            connection_layer = L.featureGroup().addTo(map);

    connection_layer.bringToFront();

    // var geo = L.geoJson({features:[]},{onEachFeature:function popUp(f,l){
    // 		var out = [];
    // 		if (f.properties){
    //    		for(var key in f.properties){
    //        	out.push(key+": "+f.properties[key]);
    //        }
    //        l.bindPopup(out.join("<br />"));
    //    }
    // }}).addTo(map);

	// shp('http://localhost:8111/prov.zip').then(function(data){
	//    geo.addData(data);
	// }, function(a){
	//    console.log(a)
	// });

    L.control.layers(
        {
            'OpenStreetMap': osm.addTo(map),
            "Google": L.tileLayer('http://www.google.cn/maps/vt?lyrs=s@189&gl=cn&x={x}&y={y}&z={z}', {
                attribution: 'Google'
            })
        },
        { 'Assets': esdl_layer, 'Area boundaries': area_layer, 'Building boundaries': bld_layer, 'Potential boundaries': pot_layer, 'Connections': connection_layer },
        //, 'wms': wms_layer, 'wms2': wms_layer2 },
        { position: 'topleft', collapsed: false }
    ).addTo(map);

    var assets_for_icons = ["Battery", "CHP", "EConnection", "ElectricityDemand", "ElectricityNetwork", "Electrolyzer",
        "EVChargingStation",
        "FuelCell", "GConnection", "GasHeater", "GasNetwork", "GenericConsumer", "GenericConversion", "GenericProducer",
        "GeothermalSource", "HeatingDemand", "HeatNetwork", "HeatPump", "Joint", "MobilityDemand", "PowerPlant",
        "PVInstallation", "PVParc", "ResidualHeatSourcePotential", "Transformer", "UTES", "WindTurbine"];

    for (var i=0; i < assets_for_icons.length; i++) {
        var ass_name = assets_for_icons[i];
        window[ass_name+'Marker'] = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12),
            iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/' + ass_name +'.png'}});
    }

//    var BatteryMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/Battery.png'}});
//	  var CHPMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/CHP.png'}});
//    var EConnectionMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/EConnection.png'}});
//    var ElectricityDemandMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/ElectricityDemand.png'}});
//    var ElectricityNetworkMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/ElectricityNetwork.png'}});
//    var ElectrolyzerMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/Electrolyzer.png'}});
//    var FuelCellMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/FuelCell.png'}});
//	  var GConnectionMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/GConnection.png'}});
//    var GasHeaterMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/GasHeater.png'}});
//    var GasNetworkMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/GasNetwork.png'}});
//    var GenericConsumerMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/GenericConsumer.png'}});
//    var GenericConversionMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/GenericConversion.png'}});
//    var GenericProducerMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/GenericProducer.png'}});
//    var GeothermalSourceMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/GeothermalSource.png'}});
//    var HeatingDemandMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/HeatingDemand.png'}});
//    var HeatNetworkMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/HeatNetwork.png'}});
//    var HeatPumpMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/HeatPump.png'}});
//    var JointMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/Joint.png'}});
//    var MobilityDemandMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/MobilityDemand.png'}});
//    var PowerPlantMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/PowerPlant.png'}});
//    var PVInstallationMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/PVInstallation.png'}});
//    var PVParcMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/PVParc.png'}});
//    var ResidualHeatSourcePotentialMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/ResidualHeatSourcePotential.png'}});
//    var TransformerMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/Transformer.png'}});
//    var UTESMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/UTES.png'}});
//    var WindTurbineMarker = L.Icon.extend({options: {shadowUrl: null, iconAnchor: new L.Point(12, 12), iconSize: new L.Point(30, 30), iconUrl: '{{dir_settings.resource_prefix}}images/WindTurbine.png'}});

    var drawControl = new L.Control.Draw({
        edit: {
            featureGroup: esdl_layer,
            poly: {
                allowIntersection: true
            }
        },
        draw: {
            polygon: {
                allowIntersection: true,
                showArea: true
            },
            circle: false,
            polyline: {
                repeatMode: true
            },
            marker: {
                icon: new BatteryMarker(),
                repeatMode: true
            }
        }
    })
    map.addControl(drawControl);

    sidebar = L.control.sidebar('sidebar', {
        position: 'right',
        closeButton: true
    });
    map.addControl(sidebar);

    // the 'dragend' event of Polyline does not work, this is an alternative solution
    map.on('draw:edited', function (e) {
        var layers = e.layers;
        layers.eachLayer(function (layer) {
            if (layer instanceof L.Polyline) {
                polyline_length = calculate_length(layer);
                // console.log(layer.getLatLngs());
                socket.emit('update-line-coord', {id: layer.id, polyline: layer.getLatLngs(), length: polyline_length});
            }
        });
    });

    // To prevent the onclick functionality when removing objects
	map.on(L.Draw.Event.DELETESTART, function (event) {
        deleting_objects = true;
	});

	map.on(L.Draw.Event.DELETESTOP, function (event) {
        deleting_objects = false;
	});

    // To prevent the onclick functionality when editing objects
	map.on(L.Draw.Event.EDITSTART, function (event) {
        editing_objects = true;
	});

	map.on(L.Draw.Event.EDITSTOP, function (event) {
        editing_objects = false;
	});

    map.on('contextmenu.select', function(e) {
        // this event is fired for all contextmenu clicks
        // TODO: how to filter add profile in a better way???
        menu_item_text = e.el.innerText;
        console.log(e);

//        if (menu_item_text.substring(0, 11) == 'Set profile') {
//            port_id = menu_item_text.substring(menu_item_text.indexOf('(')+1, menu_item_text.indexOf(')'));
//            // console.log(port_id);
//            socket.emit('command', {'cmd': 'get_port_profile_info', 'port_id': port_id});
//        }

//        if (menu_item_text.substring(0, 8) ==  'Connect ') {
//            port_id = menu_item_text.substring(menu_item_text.indexOf('(')+1, menu_item_text.indexOf(')'));
//            // console.log('In contextmenu select eventhandler:');
//            // console.log(port_id);
//            if (connect_ports != null) {
//                socket.emit('command', {'cmd': 'connect_ports', port1id: connect_ports, port2id: port_id});
//                connect_ports = null;
//            } else {
//                connect_ports = port_id;
//            }
//        }

//        if (menu_item_text.substring(0, 10) ==  'Set Driven') {
//            port_id = menu_item_text.substring(menu_item_text.indexOf('(')+1, menu_item_text.indexOf(')'));
//            asset_id = menu_item_text.substring(menu_item_text.indexOf('[')+1, menu_item_text.indexOf(']'));
//
//            if (menu_item_text.substring(4, 14) ==  'DrivenByDemand') {
//                set_driven_by_demand(asset_id, port_id);
//            }
//            if (menu_item_text.substring(4, 14) ==  'DrivenBySupply') {
//                set_driven_by_supply(asset_id, port_id);
//            }
//        }

        if (menu_item_text.substring(0, 11) ==  'Set Storage') {
            asset_id = menu_item_text.substring(menu_item_text.indexOf('[')+1, menu_item_text.indexOf(']'));
            socket.emit('command', {'cmd': 'get_storage_strategy_info', 'asset_id': asset_id});
        }
    });

    map.on(L.Draw.Event.CREATED, function (event) {
        var layer = event.layer;
        var type = event.layerType;
        layer.id = uuidv4();

        selected_area_bld_index = document.getElementById("area_bld_select").selectedIndex;
        selected_area_bld_options = document.getElementById("area_bld_select").options;
        selected_area_bld_id = selected_area_bld_options[selected_area_bld_index].value;
        // console.log('selected area/building id: ' + selected_area_bld_id);

        if (type === 'marker') {
            selection = document.getElementById("asset_menu").selectedIndex;
            asset_options = document.getElementById("asset_menu").options;
            selected_asset = asset_options[selection].value;
            // console.log('selected option: ' + selection);
            // console.log('selected asset: ' + selected_asset);

            layer.name = selected_asset + '_' + layer.id.substring(0,4);
            socket.emit('command', {cmd: 'add_asset', area_bld_id: selected_area_bld_id, asset: selected_asset, asset_name: layer.name, asset_id: layer.id, lat: layer.getLatLng().lat, lng: layer.getLatLng().lng});
        }
        if (type === 'polyline') {
            line_type = document.getElementById("line_select").value;
            //console.log('selected line type: ' + line_type);
            layer.type = line_type;
            layer.name = line_type + '_' + layer.id.substring(0,4);
            layer.title = layer.name;
            polyline_length = calculate_length(layer);
            socket.emit('command', {cmd: 'add_asset', area_bld_id: selected_area_bld_id, asset: line_type, asset_name: layer.name, asset_id: layer.id, polyline: layer.getLatLngs(), length: polyline_length});
        }
        if (type === 'polygon' || type === 'rectangle') {
            socket.emit('command', {cmd: 'set_area_bld_polygon', area_bld_id: selected_area_bld_id, polygon: layer.getLatLngs()});
            area_layer.addLayer(layer, true);
        }
    });


</script>
